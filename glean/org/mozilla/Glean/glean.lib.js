var Glean;(()=>{var e={d:(t,i)=>{for(var n in i)e.o(i,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:i[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};(()=>{var i;e.r(t),e.d(t,{default:()=>$i}),function(e){e.InvalidValue="invalid_value",e.InvalidLabel="invalid_label",e.InvalidState="invalid_state",e.InvalidOverflow="invalid_overflow"}(i||(i={}));function n(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a}function r(e,t,i,n){return new(i||(i=Promise))((function(r,s){function a(e){try{c(n.next(e))}catch(e){s(e)}}function o(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}c((n=n.apply(e,t||[])).next())}))}Object.create;var s;Object.create;function a(e,t,i=s.Debug){const n=`(Glean.${e})`;Array.isArray(t)?console[i](n,...t):console[i](n,t)}!function(e){e.Debug="debug",e.Info="info",e.Warn="warn",e.Error="error"}(s||(s={}));var o;!function(e){e[e.RecoverableFailure=0]="RecoverableFailure",e[e.UnrecoverableFailure=1]="UnrecoverableFailure",e[e.Success=2]="Success"}(o||(o={}));class c{constructor(e,t){this.result=e,this.status=t}}const d=class{};var l,u=new Uint8Array(16);function h(){if(!l&&!(l="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return l(u)}const g=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;const p=function(e){return"string"==typeof e&&g.test(e)};for(var f=[],v=0;v<256;++v)f.push((v+256).toString(16).substr(1));const m=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=(f[e[t+0]]+f[e[t+1]]+f[e[t+2]]+f[e[t+3]]+"-"+f[e[t+4]]+f[e[t+5]]+"-"+f[e[t+6]]+f[e[t+7]]+"-"+f[e[t+8]]+f[e[t+9]]+"-"+f[e[t+10]]+f[e[t+11]]+f[e[t+12]]+f[e[t+13]]+f[e[t+14]]+f[e[t+15]]).toLowerCase();if(!p(i))throw TypeError("Stringified UUID is invalid");return i};const y=function(e,t,i){var n=(e=e||{}).random||(e.rng||h)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){i=i||0;for(var r=0;r<16;++r)t[i+r]=n[r];return t}return m(n)};var b,w;!function(e){e.Uninitialized="Uninitialized",e.Idle="Idle",e.Processing="Processing",e.Stopped="Stopped",e.Shutdown="Shutdown"}(b||(b={})),function(e){e.Task="Task",e.PersistentTask="PersistentTask",e.InitTask="InitTask",e.Stop="Stop",e.Clear="Clear",e.Shutdown="Shutdown",e.TestTask="TestTask"}(w||(w={}));const _=class{constructor(e=100,t="core.Dispatcher"){this.maxPreInitQueueSize=e,this.logTag=t,this.shuttingDown=!1,this.currentJob=Promise.resolve(),this.queue=[],this.state="Uninitialized"}getNextCommand(){return this.queue.shift()}executeTask(e){return r(this,void 0,void 0,(function*(){try{return yield e(),!0}catch(e){return a(this.logTag,["Error executing task:",e],s.Error),!1}}))}unblockTestResolvers(){this.queue.forEach((e=>{"TestTask"===e.command&&e.resolver()}))}execute(){return r(this,void 0,void 0,(function*(){let e=this.getNextCommand();for(;e;){switch(e.command){case"Stop":return void(this.state="Stopped");case"Shutdown":return this.unblockTestResolvers(),this.queue=[],this.state="Shutdown",void(this.shuttingDown=!1);case"Clear":this.unblockTestResolvers(),this.queue=this.queue.filter((e=>["PersistentTask","Shutdown"].includes(e.command)));break;case"TestTask":yield this.executeTask(e.task),e.resolver();break;case"InitTask":(yield this.executeTask(e.task))||(a(this.logTag,["Error initializing dispatcher, won't execute anything further.","There might be more error logs above."],s.Error),this.clear(),this.shutdown());break;case"PersistentTask":case"Task":yield this.executeTask(e.task)}e=this.getNextCommand()}}))}triggerExecution(){"Idle"===this.state&&this.queue.length>0&&(this.state="Processing",this.currentJob=this.execute(),this.currentJob.then((()=>{const e=this;"Processing"===this.state&&(e.state="Idle")})).catch((e=>{a(this.logTag,["IMPOSSIBLE: Something went wrong while the dispatcher was executing the tasks queue.",e],s.Error)})))}launchInternal(e,t=!1){return"Shutdown"===this.state?(a(this.logTag,"Attempted to enqueue a new task but the dispatcher is shutdown. Ignoring.",s.Warn),!1):!t&&"Uninitialized"===this.state&&this.queue.length>=this.maxPreInitQueueSize?(a(this.logTag,"Unable to enqueue task, pre init queue is full.",s.Warn),!1):(t?this.queue.unshift(e):this.queue.push(e),this.triggerExecution(),!0)}launch(e){this.launchInternal({task:e,command:"Task"})}launchPersistent(e){this.launchInternal({task:e,command:"PersistentTask"})}flushInit(e){"Uninitialized"===this.state?(e&&this.launchInternal({task:e,command:"InitTask"},!0),this.state="Idle",this.triggerExecution()):a(this.logTag,"Attempted to initialize the Dispatcher, but it is already initialized. Ignoring.",s.Warn)}clear(e=!0){this.launchInternal({command:"Clear"},e),this.resume()}stop(e=!0){this.shuttingDown?this.clear(e):this.launchInternal({command:"Stop"},e)}resume(){"Stopped"===this.state&&(this.state="Idle",this.triggerExecution())}shutdown(){return this.shuttingDown=!0,this.launchInternal({command:"Shutdown"}),this.resume(),this.currentJob}testBlockOnQueue(){return r(this,void 0,void 0,(function*(){return yield this.currentJob}))}testUninitialize(){return r(this,void 0,void 0,(function*(){"Uninitialized"!==this.state&&(this.clear(),yield this.shutdown(),this.state="Uninitialized")}))}testLaunch(e){return new Promise(((t,i)=>{this.resume();this.launchInternal({resolver:t,task:e,command:"TestTask"})||i()}))}},T="core.Context";class I{constructor(){this._initialized=!1,this._testing=!1,this._startTime=new Date,this._dispatcher=new _}static get instance(){return I._instance||(I._instance=new I),I._instance}static testUninitialize(){I._instance=void 0}static get dispatcher(){return I.instance._dispatcher}static get uploadEnabled(){return void 0===I.instance._uploadEnabled&&a(T,["Attempted to access Context.uploadEnabled before it was set. This may cause unexpected behaviour."],s.Error),I.instance._uploadEnabled}static set uploadEnabled(e){I.instance._uploadEnabled=e}static get metricsDatabase(){return void 0===I.instance._metricsDatabase&&a(T,["Attempted to access Context.metricsDatabase before it was set. This may cause unexpected behaviour."],s.Error),I.instance._metricsDatabase}static set metricsDatabase(e){I.instance._metricsDatabase=e}static get eventsDatabase(){return void 0===I.instance._eventsDatabase&&a(T,["Attempted to access Context.eventsDatabase before it was set. This may cause unexpected behaviour."],s.Error),I.instance._eventsDatabase}static set eventsDatabase(e){I.instance._eventsDatabase=e}static get pingsDatabase(){return void 0===I.instance._pingsDatabase&&a(T,["Attempted to access Context.pingsDatabase before it was set. This may cause unexpected behaviour."],s.Error),I.instance._pingsDatabase}static set pingsDatabase(e){I.instance._pingsDatabase=e}static get errorManager(){return void 0===I.instance._errorManager&&a(T,["Attempted to access Context.errorManager before it was set. This may cause unexpected behaviour."],s.Error),I.instance._errorManager}static set errorManager(e){I.instance._errorManager=e}static get applicationId(){return void 0===I.instance._applicationId&&a(T,["Attempted to access Context.applicationId before it was set. This may cause unexpected behaviour."],s.Error),I.instance._applicationId}static set applicationId(e){I.instance._applicationId=e}static get initialized(){return I.instance._initialized}static set initialized(e){I.instance._initialized=e}static get debugOptions(){return void 0===I.instance._debugOptions&&a(T,["Attempted to access Context.debugOptions before it was set. This may cause unexpected behaviour."],s.Error),I.instance._debugOptions}static set debugOptions(e){I.instance._debugOptions=e}static get startTime(){return I.instance._startTime}static get testing(){return I.instance._testing}static set testing(e){I.instance._testing=e}}function S(e){if(P(e)||D(e)||M(e))return!0;if(x(e)){if(0===Object.keys(e).length)return!0;for(const t in e)return S(e[t])}return!!Array.isArray(e)&&e.every((e=>S(e)))}function x(e){return"object"==typeof e&&null!==e&&e.constructor===Object}function E(e){return void 0===e}function P(e){return"string"==typeof e}function D(e){return"boolean"==typeof e}function M(e){return"number"==typeof e&&!isNaN(e)}function $(e){return M(e)&&Number.isInteger(e)}function U(e){return/^[a-z0-9-]{1,20}$/i.test(e)}function O(){return"undefined"!=typeof crypto?y():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}const k=Date.now();function z(){return"undefined"==typeof performance?Date.now()-k:performance.now()}function R(e,t,n){return r(this,void 0,void 0,(function*(){const r=t.substr(0,n);return r!==t&&(yield I.errorManager.record(e,i.InvalidOverflow,`Value length ${t.length} exceeds maximum of ${n}.`)),r}))}function A(e="core.utils"){return(t,i,n)=>{const r=n.value;return n.value=function(...t){return I.testing?r?r.apply(this,t):Promise.resolve():(a(e,[`Attempted to access test only method \`${i||"unknown"}\`,`,"but Glean is not in testing mode. Ignoring. Make sure to put Glean in testing mode","before accessing such methods, by calling `Glean.testResetGlean`."],s.Error),Promise.resolve())},n}}const V="platform.qt.Uploader";const j=new class extends d{post(e,t,i={}){return r(this,void 0,void 0,(function*(){return new Promise((n=>{const r=new XMLHttpRequest;r.timeout=1e4,r.open("POST",e);for(const e in i)r.setRequestHeader(e,i[e]);r.ontimeout=function(e){a(V,["Timeout while attempting to upload ping.\n",e.type],s.Error),n(new c(0))},r.onerror=function(e){a(V,["Network error while attempting to upload ping.\n",e.type],s.Error),n(new c(0))},r.onabort=function(e){a(V,["The attempt to upload ping is aborted.\n",e.type],s.Error),n(new c(0))},r.onload=()=>{n(new c(2,r.status))},P(t)?r.send(t):r.send(t.buffer)}))}))}},L={os(){return r(this,void 0,void 0,(function*(){switch(Qt.platform.os){case"android":return"Android";case"ios":return"iOS";case"tvos":return"tvOS";case"linux":return"Linux";case"osx":return"Darwin";case"qnx":return"QNX";case"windows":case"winrt":return"Windows";case"wasm":return"Wasm";default:return"Unknown"}}))},osVersion(e){return r(this,void 0,void 0,(function*(){return Promise.resolve(e||"Unknown")}))},arch(e){return r(this,void 0,void 0,(function*(){return Promise.resolve(e||"Unknown")}))},locale(){return r(this,void 0,void 0,(function*(){const e=Qt.locale();return Promise.resolve(e?e.name.replace("_","-"):"und")}))}};function G(e,t){if(0===t.length)throw Error("The index must contain at least one property to get.");let i=e;for(const e of t){if(!x(i)||!(e in i))return;{const t=i[e];S(t)&&(i=t)}}return i}function C(e,t,i){if(0===t.length)throw Error("The index must contain at least one property to update.");const n=Object.assign({},e);let r=n;for(const e of t.slice(0,t.length-1))x(r[e])||(r[e]={}),r=r[e];const o=t[t.length-1],c=r[o];try{const e=i(c);return r[o]=e,n}catch(e){return a("core.Storage.Utils",["Error while transforming stored value. Ignoring old value.",e],s.Error),r[o]=i(void 0),n}}function N(e,t="",i=[]){if(x(e)){const n=Object.keys(e);for(const r of n){const n=e[r];E(n)||N(n,`${t}${r}+`,i)}}else i.push([t.slice(0,-1),JSON.stringify(e)]);return i}function q(e){if(!e||0===e.rows.length)return;const t={};for(let i=0;i<e.rows.length;i++){const n=e.rows.item(i),r=n.key.split("+");let s=t;for(const e of r.slice(0,-1))E(s[e])&&(s[e]={}),s=s[e];try{s[r[r.length-1]]=JSON.parse(n.value)}catch(e){s[r[r.length-1]]=n.value}}return t}const F={Storage:class{constructor(e,t="Glean"){this.tableName=e,this.name=t,this.initialized=this._executeQuery(`CREATE TABLE IF NOT EXISTS ${e}(key VARCHAR(255), value VARCHAR(255));`),this.logTag=`platform.qt.Storage.${e}`}_createKeyFromIndex(e){return e.join("+")}get _dbHandle(){try{const e=LocalStorage.LocalStorage.openDatabaseSync(this.name,"1.0",`${this.name} Storage`,3e5);this.dbHandle=e}catch(e){a(this.logTag,["Error while attempting to access LocalStorage.\n",e],s.Debug)}finally{return this.dbHandle}}_executeQuery(e){const t=this._dbHandle;return new Promise(((i,n)=>{try{t.transaction((t=>{const n=t.executeSql(e);i(n)}))}catch(t){a(this.logTag,[`Error executing LocalStorage query: ${e}.\n`,t],s.Debug),n()}}))}_executeOnceInitialized(e){return r(this,void 0,void 0,(function*(){return yield this.initialized,this._executeQuery(e)}))}_getFullResultObject(e){return r(this,void 0,void 0,(function*(){const t=this._createKeyFromIndex(e);return q(yield this._executeOnceInitialized(`SELECT * FROM ${this.tableName} WHERE key LIKE "${t}%"`))}))}_getWholeStore(){return r(this,void 0,void 0,(function*(){return q(yield this._executeOnceInitialized(`SELECT * FROM ${this.tableName}`))}))}get(e=[]){return r(this,void 0,void 0,(function*(){if(0===e.length)return this._getWholeStore();const t=(yield this._getFullResultObject(e))||{};try{return G(t,e)}catch(e){a(this.logTag,["Error getting value from database.",e])}}))}update(e,t){return r(this,void 0,void 0,(function*(){const i=N(C((yield this._getFullResultObject(e))||{},e,t));for(const e of i){const[t,i]=e,n=i.replace("'","''"),r=yield this._executeOnceInitialized(`UPDATE ${this.tableName} SET value='${n}' WHERE key='${t}'`);(null==r?void 0:r.rows.length)||(yield this._executeOnceInitialized(`INSERT INTO ${this.tableName}(key, value) VALUES('${t}', '${n}');`))}}))}delete(e){return r(this,void 0,void 0,(function*(){const t=this._createKeyFromIndex(e);yield this._executeOnceInitialized(`DELETE FROM ${this.tableName} WHERE key LIKE "${t}%"`)}))}},uploader:j,info:L,name:"Qt"},W="0.23.0",B="glean_ping_info",J="glean_client_info",Q="c0ffeec0-ffee-c0ff-eec0-ffeec0ffeec0",H="deletion-request",K="#glean_reference_time",X="#glean_execution_counter",Z=[X,K],Y="core.Config";class ee{constructor(e){if(this.channel=null==e?void 0:e.channel,this.appBuild=null==e?void 0:e.appBuild,this.appDisplayVersion=null==e?void 0:e.appDisplayVersion,this.architecture=null==e?void 0:e.architecture,this.osVersion=null==e?void 0:e.osVersion,this.debug=ee.sanitizeDebugOptions(null==e?void 0:e.debug),(null==e?void 0:e.serverEndpoint)&&(t=e.serverEndpoint,!/^(http|https):\/\/[a-zA-Z0-9._-]+(:\d+){0,1}(\/{0,1})$/i.test(t)))throw new Error(`Unable to initialize Glean, serverEndpoint ${e.serverEndpoint} is an invalid URL.`);var t;this.serverEndpoint=e&&e.serverEndpoint?e.serverEndpoint:"https://incoming.telemetry.mozilla.org",this.httpClient=null==e?void 0:e.httpClient}static sanitizeDebugOptions(e){const t=e||{};return void 0===(null==e?void 0:e.debugViewTag)||ee.validateDebugViewTag(null==e?void 0:e.debugViewTag)||delete t.debugViewTag,void 0===(null==e?void 0:e.sourceTags)||ee.validateSourceTags(null==e?void 0:e.sourceTags)||delete t.sourceTags,t}static validateDebugViewTag(e){const t=U(e);return t||a(Y,[`"${e}" is not a valid \`debugViewTag\` value.`,"Please make sure the value passed satisfies the regex `^[a-zA-Z0-9-]{1,20}$`."],s.Error),t}static validateSourceTags(e){if(e.length<1||e.length>5)return a(Y,"A list of tags cannot contain more than 5 elements.",s.Error),!1;for(const t of e){if(t.startsWith("glean"))return a(Y,"Tags starting with `glean` are reserved and must not be used.",s.Error),!1;if(!U(t))return!1}return!0}}class te{constructor(e){if(!this.validate(e))throw new Error("Unable to create new Metric instance, value is in unexpected format.");this._inner=e}get(){return this._inner}set(e){this.validate(e)?this._inner=e:a("core.Metrics.Metric",`Unable to set metric to ${JSON.stringify(e)}. Value is in unexpected format. Ignoring.`,s.Error)}}class ie extends te{constructor(e){super(e)}validate(e){return!0}payload(){return this._inner}}const ne="__other__",re=/^[a-z_][a-z0-9_-]{0,29}(\.[a-z_][a-z0-9_-]{0,29})*$/;function se(e,t){return`${e}/${t}`}class ae{constructor(e,t,i){return new Proxy(this,{get:(n,r)=>i?ae.createFromStaticLabel(e,t,i,r):ae.createFromDynamicLabel(e,t,r)})}static createFromStaticLabel(e,t,i,n){const r=i.includes(n)?n:ne;return new t(Object.assign(Object.assign({},e),{name:se(e.name,r)}))}static createFromDynamicLabel(e,t,i){return new t(Object.assign(Object.assign({},e),{dynamicLabel:i}))}}const oe=ae;class ce{constructor(e,t){this.type=e,this.name=t.name,this.category=t.category,this.sendInPings=t.sendInPings,this.lifetime=t.lifetime,this.disabled=t.disabled,this.dynamicLabel=t.dynamicLabel}baseIdentifier(){return this.category.length>0?`${this.category}.${this.name}`:this.name}identifier(){return r(this,void 0,void 0,(function*(){const e=this.baseIdentifier();return E(this.dynamicLabel)?e:yield function(e){return r(this,void 0,void 0,(function*(){if(void 0===e.dynamicLabel)throw new Error("This point should never be reached.");const t=se(e.baseIdentifier(),e.dynamicLabel);for(const i of e.sendInPings)if(yield I.metricsDatabase.hasMetric(e.lifetime,i,e.type,t))return t;let n=0;for(const t of e.sendInPings)n+=(yield I.metricsDatabase.countByBaseIdentifier(e.lifetime,t,e.type,e.baseIdentifier()));let r=!1;return n>=16?r=!0:e.dynamicLabel.length>61?(r=!0,yield I.errorManager.record(e,i.InvalidLabel,`Label length ${e.dynamicLabel.length} exceeds maximum of 61.`)):re.test(e.dynamicLabel)||(r=!0,yield I.errorManager.record(e,i.InvalidLabel,`Label must be snake_case, got '${e.dynamicLabel}'.`)),r?se(e.baseIdentifier(),ne):t}))}(this)}))}shouldRecord(e){return e&&!this.disabled}testGetNumRecordedErrors(e,t=this.sendInPings[0]){return r(this,void 0,void 0,(function*(){return I.errorManager.testGetNumRecordedErrors(this,e,t)}))}}n([A()],ce.prototype,"testGetNumRecordedErrors",null);class de extends te{constructor(e){super(e)}validate(e){return D(e)}payload(){return this._inner}}class le extends ce{constructor(e){super("boolean",e)}set(e){I.dispatcher.launch((()=>r(this,void 0,void 0,(function*(){if(!this.shouldRecord(I.uploadEnabled))return;const t=new de(e);yield I.metricsDatabase.record(this,t)}))))}testGetValue(e=this.sendInPings[0]){return r(this,void 0,void 0,(function*(){let t;return yield I.dispatcher.testLaunch((()=>r(this,void 0,void 0,(function*(){t=yield I.metricsDatabase.getMetric(e,this)})))),t}))}}n([A("core.metrics.BooleanMetricType")],le.prototype,"testGetValue",null);const ue=le;class he extends te{constructor(e){super(e)}validate(e){return!!$(e)&&!(e<=0)}payload(){return this._inner}}class ge extends ce{constructor(e){super("counter",e)}static _private_addUndispatched(e,t){return r(this,void 0,void 0,(function*(){if(!e.shouldRecord(I.uploadEnabled))return;if(E(t)&&(t=1),t<=0)return void(yield I.errorManager.record(e,i.InvalidValue,`Added negative and zero value ${t}`));const n=(e=>t=>{let i,n;try{i=new he(t),n=i.get()+e}catch(t){i=new he(e),n=e}return n>Number.MAX_SAFE_INTEGER&&(n=Number.MAX_SAFE_INTEGER),i.set(n),i})(t);yield I.metricsDatabase.transform(e,n)}))}add(e){I.dispatcher.launch((()=>r(this,void 0,void 0,(function*(){return ge._private_addUndispatched(this,e)}))))}testGetValue(e=this.sendInPings[0]){return r(this,void 0,void 0,(function*(){let t;return yield I.dispatcher.testLaunch((()=>r(this,void 0,void 0,(function*(){t=yield I.metricsDatabase.getMetric(e,this)})))),t}))}}n([A("core.metrics.CounterMetricType")],ge.prototype,"testGetValue",null);const pe=ge;var fe;!function(e){e.Nanosecond="nanosecond",e.Microsecond="microsecond",e.Millisecond="millisecond",e.Second="second",e.Minute="minute",e.Hour="hour",e.Day="day"}(fe||(fe={}));const ve=fe,me="core.metrics.DatetimeMetricType";class ye extends te{constructor(e){super(e)}static fromDate(e,t){return new ye({timeUnit:t,timezone:e.getTimezoneOffset(),date:e.toISOString()})}get date(){return new Date(this._inner.date)}get timezone(){return this._inner.timezone}get timeUnit(){return this._inner.timeUnit}get dateISOString(){return this._inner.date}validate(e){if(!x(e)||3!==Object.keys(e).length)return!1;const t="timeUnit"in e&&P(e.timeUnit)&&Object.values(ve).includes(e.timeUnit),i="timezone"in e&&M(e.timezone),n="date"in e&&P(e.date)&&24===e.date.length&&!isNaN(Date.parse(e.date));return!!(t&&i&&n)}payload(){const e=this.dateISOString.match(/\d+/g);if(!e||e.length<0)throw new Error("IMPOSSIBLE: Unable to extract date information from DatetimeMetric.");const t=new Date(parseInt(e[0]),parseInt(e[1])-1,parseInt(e[2]),parseInt(e[3])-this.timezone/60,parseInt(e[4]),parseInt(e[5]),parseInt(e[6])),i=function(e){const t=e/60*-1;return`${t>0?"+":"-"}${Math.abs(t).toString().padStart(2,"0")}:00`}(this.timezone),n=t.getFullYear().toString().padStart(2,"0"),r=(t.getMonth()+1).toString().padStart(2,"0"),s=t.getDate().toString().padStart(2,"0");if(this.timeUnit===ve.Day)return`${n}-${r}-${s}${i}`;const a=t.getHours().toString().padStart(2,"0");if(this.timeUnit===ve.Hour)return`${n}-${r}-${s}T${a}${i}`;const o=t.getMinutes().toString().padStart(2,"0");if(this.timeUnit===ve.Minute)return`${n}-${r}-${s}T${a}:${o}${i}`;const c=t.getSeconds().toString().padStart(2,"0");if(this.timeUnit===ve.Second)return`${n}-${r}-${s}T${a}:${o}:${c}${i}`;const d=t.getMilliseconds().toString().padStart(3,"0");return this.timeUnit===ve.Millisecond?`${n}-${r}-${s}T${a}:${o}:${c}.${d}${i}`:this.timeUnit===ve.Microsecond?`${n}-${r}-${s}T${a}:${o}:${c}.${d}000${i}`:`${n}-${r}-${s}T${a}:${o}:${c}.${d}000000${i}`}}class be extends ce{constructor(e,t){super("datetime",e),this.timeUnit=t}static _private_setUndispatched(e,t){return r(this,void 0,void 0,(function*(){if(!e.shouldRecord(I.uploadEnabled))return;t||(t=new Date);const i=t;switch(e.timeUnit){case ve.Day:i.setMilliseconds(0),i.setSeconds(0),i.setMinutes(0),i.setMilliseconds(0);case ve.Hour:i.setMilliseconds(0),i.setSeconds(0),i.setMinutes(0);case ve.Minute:i.setMilliseconds(0),i.setSeconds(0);case ve.Second:i.setMilliseconds(0)}const n=ye.fromDate(t,e.timeUnit);yield I.metricsDatabase.record(e,n)}))}set(e){I.dispatcher.launch((()=>be._private_setUndispatched(this,e)))}testGetValueAsDatetimeMetric(e){return r(this,void 0,void 0,(function*(){let t;if(yield I.dispatcher.testLaunch((()=>r(this,void 0,void 0,(function*(){t=yield I.metricsDatabase.getMetric(e,this)})))),t)return new ye(t)}))}testGetValueAsString(e=this.sendInPings[0]){return r(this,void 0,void 0,(function*(){const t=yield this.testGetValueAsDatetimeMetric(e);return t?t.payload():void 0}))}testGetValue(e=this.sendInPings[0]){return r(this,void 0,void 0,(function*(){const t=yield this.testGetValueAsDatetimeMetric(e);return t?t.date:void 0}))}}n([A(me)],be.prototype,"testGetValueAsDatetimeMetric",null),n([A(me)],be.prototype,"testGetValueAsString",null),n([A(me)],be.prototype,"testGetValue",null);const we=be;class _e extends te{constructor(e){super(e)}validate(e){return!!$(e)&&!(e<0)}payload(){return this._inner}}class Te extends ce{constructor(e){super("quantity",e)}static _private_setUndispatched(e,t){return r(this,void 0,void 0,(function*(){if(!e.shouldRecord(I.uploadEnabled))return;if(t<0)return void(yield I.errorManager.record(e,i.InvalidValue,`Set negative value ${t}`));t>Number.MAX_SAFE_INTEGER&&(t=Number.MAX_SAFE_INTEGER);const n=new _e(t);yield I.metricsDatabase.record(e,n)}))}set(e){I.dispatcher.launch((()=>Te._private_setUndispatched(this,e)))}testGetValue(e=this.sendInPings[0]){return r(this,void 0,void 0,(function*(){let t;return yield I.dispatcher.testLaunch((()=>r(this,void 0,void 0,(function*(){t=yield I.metricsDatabase.getMetric(e,this)})))),t}))}}n([A("core.metrics.QuantityMetricType")],Te.prototype,"testGetValue",null);const Ie=Te;class Se extends te{constructor(e){super(e)}validate(e){return!!P(e)&&!(e.length>100)}payload(){return this._inner}}class xe extends ce{constructor(e){super("string",e)}static _private_setUndispatched(e,t){return r(this,void 0,void 0,(function*(){if(!e.shouldRecord(I.uploadEnabled))return;const i=yield R(e,t,100),n=new Se(i);yield I.metricsDatabase.record(e,n)}))}set(e){I.dispatcher.launch((()=>xe._private_setUndispatched(this,e)))}testGetValue(e=this.sendInPings[0]){return r(this,void 0,void 0,(function*(){let t;return yield I.dispatcher.testLaunch((()=>r(this,void 0,void 0,(function*(){t=yield I.metricsDatabase.getMetric(e,this)})))),t}))}}n([A("core.metrics.StringMetricType")],xe.prototype,"testGetValue",null);const Ee=xe,Pe=20;class De extends te{constructor(e){super(e)}validate(e){if(!Array.isArray(e))return!1;if(e.length>Pe)return!1;for(const t of e)if(!P(t)||t.length>50)return!1;return!0}payload(){return this._inner}}class Me extends ce{constructor(e){super("string_list",e)}set(e){I.dispatcher.launch((()=>r(this,void 0,void 0,(function*(){if(!this.shouldRecord(I.uploadEnabled))return;const t=[];e.length>Pe&&(yield I.errorManager.record(this,i.InvalidValue,`String list length of ${e.length} exceeds maximum of 20.`));for(let i=0;i<Math.min(e.length,Pe);++i){const n=yield R(this,e[i],50);t.push(n)}const n=new De(t);yield I.metricsDatabase.record(this,n)}))))}add(e){I.dispatcher.launch((()=>r(this,void 0,void 0,(function*(){if(!this.shouldRecord(I.uploadEnabled))return;const t=yield R(this,e,50);let n=0;const r=(e=>t=>{let i,r;try{i=new De(t),r=i.get(),n=r.length,r.length<Pe&&r.push(e)}catch(t){i=new De([e]),r=[e]}return i.set(r),i})(t);yield I.metricsDatabase.transform(this,r),n>=Pe&&(yield I.errorManager.record(this,i.InvalidValue,`String list length of ${n+1} exceeds maximum of 20.`))}))))}testGetValue(e=this.sendInPings[0]){return r(this,void 0,void 0,(function*(){let t;return yield I.dispatcher.testLaunch((()=>r(this,void 0,void 0,(function*(){t=yield I.metricsDatabase.getMetric(e,this)})))),t}))}}n([A("core.metrics.StringListMetricType")],Me.prototype,"testGetValue",null);const $e=Me,Ue=204800;class Oe extends te{constructor(e){super(e)}validate(e){return!!P(e)&&!(e.length>Ue)}payload(){return this._inner}}class ke extends ce{constructor(e){super("text",e)}set(e){I.dispatcher.launch((()=>r(this,void 0,void 0,(function*(){if(!this.shouldRecord(I.uploadEnabled))return;const t=yield R(this,e,Ue),i=new Oe(t);yield I.metricsDatabase.record(this,i)}))))}testGetValue(e=this.sendInPings[0]){return r(this,void 0,void 0,(function*(){let t;return yield I.dispatcher.testLaunch((()=>r(this,void 0,void 0,(function*(){t=yield I.metricsDatabase.getMetric(e,this)})))),t}))}}n([A("core.metrics.TextMetricType")],ke.prototype,"testGetValue",null);const ze=ke;class Re extends te{constructor(e){super(e)}get timespan(){switch(this._inner.timeUnit){case ve.Nanosecond:return this._inner.timespan*10**6;case ve.Microsecond:return 1e3*this._inner.timespan;case ve.Millisecond:return this._inner.timespan;case ve.Second:return Math.round(this._inner.timespan/1e3);case ve.Minute:return Math.round(this._inner.timespan/1e3/60);case ve.Hour:return Math.round(this._inner.timespan/1e3/60/60);case ve.Day:return Math.round(this._inner.timespan/1e3/60/60/24)}}validate(e){if(!x(e)||2!==Object.keys(e).length)return!1;const t="timeUnit"in e&&P(e.timeUnit)&&Object.values(ve).includes(e.timeUnit),i="timespan"in e&&M(e.timespan)&&e.timespan>=0;return!(!t||!i)}payload(){return{time_unit:this._inner.timeUnit,value:this.timespan}}}class Ae extends ce{constructor(e,t){super("timespan",e),this.timeUnit=t}static _private_setRawUndispatched(e,t){return r(this,void 0,void 0,(function*(){if(!e.shouldRecord(I.uploadEnabled))return;if(!E(e.startTime))return void(yield I.errorManager.record(e,i.InvalidState,"Timespan already running. Raw value not recorded."));let n=!1;const r=(t=>i=>{let r;try{r=new Re(i),n=!0}catch(i){r=new Re({timespan:t,timeUnit:e.timeUnit})}return r})(t);yield I.metricsDatabase.transform(e,r),n&&(yield I.errorManager.record(e,i.InvalidState,"Timespan value already recorded. New value discarded."))}))}start(){const e=z();I.dispatcher.launch((()=>r(this,void 0,void 0,(function*(){if(this.shouldRecord(I.uploadEnabled)){if(E(this.startTime))return this.startTime=e,Promise.resolve();yield I.errorManager.record(this,i.InvalidState,"Timespan already started")}}))))}stop(){const e=z();I.dispatcher.launch((()=>r(this,void 0,void 0,(function*(){if(!this.shouldRecord(I.uploadEnabled))return void(this.startTime=void 0);if(E(this.startTime))return void(yield I.errorManager.record(this,i.InvalidState,"Timespan not running."));const t=e-this.startTime;this.startTime=void 0,t<0?yield I.errorManager.record(this,i.InvalidState,"Timespan was negative."):yield Ae._private_setRawUndispatched(this,t)}))))}cancel(){I.dispatcher.launch((()=>(this.startTime=void 0,Promise.resolve())))}setRawNanos(e){I.dispatcher.launch((()=>r(this,void 0,void 0,(function*(){const t=e*10**-6;yield Ae._private_setRawUndispatched(this,t)}))))}testGetValue(e=this.sendInPings[0]){return r(this,void 0,void 0,(function*(){let t;if(yield I.dispatcher.testLaunch((()=>r(this,void 0,void 0,(function*(){t=yield I.metricsDatabase.getMetric(e,this)})))),t)return new Re(t).timespan}))}}n([A("core.metrics.TimespanMetricType")],Ae.prototype,"testGetValue",null);const Ve=Ae,je=/^[a-zA-Z][a-zA-Z0-9-\+\.]*:(.*)$/;class Le extends Error{constructor(e,t){super(t),this.type=e,this.name="UrlMetricError"}}class Ge extends te{constructor(e){super(e)}validate(e){if(!P(e))return!1;if(e.length>2048)throw new Le(i.InvalidOverflow,`URL length ${e.length} exceeds maximum of 2048.`);if(e.startsWith("data:"))throw new Le(i.InvalidValue,"URL metric does not support data URLs.");if(!je.test(e))throw new Le(i.InvalidValue,`"${e}" does not start with a valid URL scheme.`);return!0}payload(){return this._inner}}class Ce extends ce{constructor(e){super("url",e)}set(e){I.dispatcher.launch((()=>r(this,void 0,void 0,(function*(){if(this.shouldRecord(I.uploadEnabled))try{const t=new Ge(e);yield I.metricsDatabase.record(this,t)}catch(e){e instanceof Le&&(yield I.errorManager.record(this,e.type,e))}}))))}setUrl(e){this.set(e.toString())}testGetValue(e=this.sendInPings[0]){return r(this,void 0,void 0,(function*(){let t;return yield I.dispatcher.testLaunch((()=>r(this,void 0,void 0,(function*(){t=yield I.metricsDatabase.getMetric(e,this)})))),t}))}}n([A("core.metrics.URLMetricType")],Ce.prototype,"testGetValue",null);const Ne=Ce,qe=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;class Fe extends te{constructor(e){super(e)}validate(e){return!!P(e)&&qe.test(e)}payload(){return this._inner}}class We extends ce{constructor(e){super("uuid",e)}static _private_setUndispatched(e,t){return r(this,void 0,void 0,(function*(){if(!e.shouldRecord(I.uploadEnabled))return;let n;t||(t=O());try{n=new Fe(t)}catch(n){return void(yield I.errorManager.record(e,i.InvalidValue,`"${t}" is not a valid UUID.`))}yield I.metricsDatabase.record(e,n)}))}set(e){I.dispatcher.launch((()=>We._private_setUndispatched(this,e)))}generateAndSet(){if(!this.shouldRecord(I.uploadEnabled))return;const e=O();return this.set(e),e}testGetValue(e=this.sendInPings[0]){return r(this,void 0,void 0,(function*(){let t;return yield I.dispatcher.testLaunch((()=>r(this,void 0,void 0,(function*(){t=yield I.metricsDatabase.getMetric(e,this)})))),t}))}}n([A("core.metrics.UUIDMetricType")],We.prototype,"testGetValue",null);const Be=We,Je=Object.freeze({boolean:de,counter:he,datetime:ye,labeled_boolean:ie,labeled_counter:ie,labeled_string:ie,quantity:_e,string:Se,string_list:De,text:Oe,timespan:Re,url:Ge,uuid:Fe});function Qe(e,t){if(!(e in Je))throw new Error(`Unable to create metric of unknown type ${e}`);return new Je[e](t)}function He(e,t){try{return Qe(e,t),!0}catch(e){return!1}}const Ke="core.Metrics.Database";const Xe=class{constructor(e){this.userStore=new e("userLifetimeMetrics"),this.pingStore=new e("pingLifetimeMetrics"),this.appStore=new e("appLifetimeMetrics")}_chooseStore(e){switch(e){case"user":return this.userStore;case"ping":return this.pingStore;case"application":return this.appStore}}record(e,t){return r(this,void 0,void 0,(function*(){yield this.transform(e,(()=>t))}))}transform(e,t){return r(this,void 0,void 0,(function*(){if(e.disabled)return;const i=this._chooseStore(e.lifetime),n=yield e.identifier();for(const r of e.sendInPings){const s=e=>t(e).get();yield i.update([r,e.type,n],s)}}))}hasMetric(e,t,i,n){return r(this,void 0,void 0,(function*(){const r=this._chooseStore(e);return!E(yield r.get([t,i,n]))}))}countByBaseIdentifier(e,t,i,n){return r(this,void 0,void 0,(function*(){const r=this._chooseStore(e),s=yield r.get([t,i]);return E(s)?0:Object.keys(s).filter((e=>e.startsWith(n))).length}))}getMetric(e,t){return r(this,void 0,void 0,(function*(){const i=this._chooseStore(t.lifetime),n=yield t.identifier(),r=yield i.get([e,t.type,n]);return E(r)||He(t.type,r)?r:(a(Ke,`Unexpected value found for metric ${n}: ${JSON.stringify(r)}. Clearing.`,s.Error),void(yield i.delete([e,t.type,n])))}))}getAndValidatePingData(e,t){return r(this,void 0,void 0,(function*(){const i=this._chooseStore(t),n=yield i.get([e]);return E(n)?{}:function(e){if(x(e)){for(const t in e){const i=e[t];if(!x(i))return!1;for(const e in i)if(!He(t,i[e]))return a(Ke,`Invalid metric representation found for metric "${e}"`,s.Debug),!1}return!0}return!1}(n)?n:(a(Ke,`Unexpected value found for ping "${e}" in "${t}" store: ${JSON.stringify(n)}. Clearing.`,s.Debug),yield i.delete([e]),{})}))}processLabeledMetric(e,t,i,n){const r=`labeled_${t}`,s=i.split("/",2),a=s[0],o=s[1];if(r in e&&a in e[r]){const t=e[r][a];e[r][a]=Object.assign(Object.assign({},t),{[o]:n})}else e[r]=Object.assign(Object.assign({},e[r]),{[a]:{[o]:n}})}getPingMetrics(e,t){return r(this,void 0,void 0,(function*(){const i=yield this.getAndValidatePingData(e,"user"),n=yield this.getAndValidatePingData(e,"ping"),r=yield this.getAndValidatePingData(e,"application");t&&Object.keys(n).length>0&&(yield this.clear("ping",e));const s={};for(const e of[i,n,r])for(const t in e)for(const i in e[t])i.startsWith("glean.reserved#")||(i.includes("/")?this.processLabeledMetric(s,t,i,e[t][i]):s[t]=Object.assign(Object.assign({},s[t]),{[i]:e[t][i]}));return 0===Object.keys(s).length?void 0:function(e){const t={};for(const i in e){const n=e[i];t[i]={};for(const e in n){const r=Qe(i,n[e]);t[i][e]=r.payload()}}return t}(s)}))}clear(e,t){return r(this,void 0,void 0,(function*(){const i=this._chooseStore(e),n=t?[t]:[];yield i.delete(n)}))}clearAll(){return r(this,void 0,void 0,(function*(){yield this.userStore.delete([]),yield this.pingStore.delete([]),yield this.appStore.delete([])}))}};var Ze=Uint8Array,Ye=Uint16Array,et=Uint32Array,tt=new Ze([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),it=new Ze([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),nt=new Ze([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),rt=function(e,t){for(var i=new Ye(31),n=0;n<31;++n)i[n]=t+=1<<e[n-1];var r=new et(i[30]);for(n=1;n<30;++n)for(var s=i[n];s<i[n+1];++s)r[s]=s-i[n]<<5|n;return[i,r]},st=rt(tt,2),at=st[0],ot=st[1];at[28]=258,ot[258]=28;for(var ct=rt(it,0),dt=(ct[0],ct[1]),lt=new Ye(32768),ut=0;ut<32768;++ut){var ht=(43690&ut)>>>1|(21845&ut)<<1;ht=(61680&(ht=(52428&ht)>>>2|(13107&ht)<<2))>>>4|(3855&ht)<<4,lt[ut]=((65280&ht)>>>8|(255&ht)<<8)>>>1}var gt=function(e,t,i){for(var n=e.length,r=0,s=new Ye(t);r<n;++r)++s[e[r]-1];var a,o=new Ye(t);for(r=0;r<t;++r)o[r]=o[r-1]+s[r-1]<<1;if(i){a=new Ye(1<<t);var c=15-t;for(r=0;r<n;++r)if(e[r])for(var d=r<<4|e[r],l=t-e[r],u=o[e[r]-1]++<<l,h=u|(1<<l)-1;u<=h;++u)a[lt[u]>>>c]=d}else for(a=new Ye(n),r=0;r<n;++r)e[r]&&(a[r]=lt[o[e[r]-1]++]>>>15-e[r]);return a},pt=new Ze(288);for(ut=0;ut<144;++ut)pt[ut]=8;for(ut=144;ut<256;++ut)pt[ut]=9;for(ut=256;ut<280;++ut)pt[ut]=7;for(ut=280;ut<288;++ut)pt[ut]=8;var ft=new Ze(32);for(ut=0;ut<32;++ut)ft[ut]=5;var vt=gt(pt,9,0),mt=gt(ft,5,0),yt=function(e){return(e+7)/8|0},bt=function(e,t,i){(null==t||t<0)&&(t=0),(null==i||i>e.length)&&(i=e.length);var n=new(e instanceof Ye?Ye:e instanceof et?et:Ze)(i-t);return n.set(e.subarray(t,i)),n},wt=function(e,t,i){i<<=7&t;var n=t/8|0;e[n]|=i,e[n+1]|=i>>>8},_t=function(e,t,i){i<<=7&t;var n=t/8|0;e[n]|=i,e[n+1]|=i>>>8,e[n+2]|=i>>>16},Tt=function(e,t){for(var i=[],n=0;n<e.length;++n)e[n]&&i.push({s:n,f:e[n]});var r=i.length,s=i.slice();if(!r)return[Mt,0];if(1==r){var a=new Ze(i[0].s+1);return a[i[0].s]=1,[a,1]}i.sort((function(e,t){return e.f-t.f})),i.push({s:-1,f:25001});var o=i[0],c=i[1],d=0,l=1,u=2;for(i[0]={s:-1,f:o.f+c.f,l:o,r:c};l!=r-1;)o=i[i[d].f<i[u].f?d++:u++],c=i[d!=l&&i[d].f<i[u].f?d++:u++],i[l++]={s:-1,f:o.f+c.f,l:o,r:c};var h=s[0].s;for(n=1;n<r;++n)s[n].s>h&&(h=s[n].s);var g=new Ye(h+1),p=It(i[l-1],g,0);if(p>t){n=0;var f=0,v=p-t,m=1<<v;for(s.sort((function(e,t){return g[t.s]-g[e.s]||e.f-t.f}));n<r;++n){var y=s[n].s;if(!(g[y]>t))break;f+=m-(1<<p-g[y]),g[y]=t}for(f>>>=v;f>0;){var b=s[n].s;g[b]<t?f-=1<<t-g[b]++-1:++n}for(;n>=0&&f;--n){var w=s[n].s;g[w]==t&&(--g[w],++f)}p=t}return[new Ze(g),p]},It=function(e,t,i){return-1==e.s?Math.max(It(e.l,t,i+1),It(e.r,t,i+1)):t[e.s]=i},St=function(e){for(var t=e.length;t&&!e[--t];);for(var i=new Ye(++t),n=0,r=e[0],s=1,a=function(e){i[n++]=e},o=1;o<=t;++o)if(e[o]==r&&o!=t)++s;else{if(!r&&s>2){for(;s>138;s-=138)a(32754);s>2&&(a(s>10?s-11<<5|28690:s-3<<5|12305),s=0)}else if(s>3){for(a(r),--s;s>6;s-=6)a(8304);s>2&&(a(s-3<<5|8208),s=0)}for(;s--;)a(r);s=1,r=e[o]}return[i.subarray(0,n),t]},xt=function(e,t){for(var i=0,n=0;n<t.length;++n)i+=e[n]*t[n];return i},Et=function(e,t,i){var n=i.length,r=yt(t+2);e[r]=255&n,e[r+1]=n>>>8,e[r+2]=255^e[r],e[r+3]=255^e[r+1];for(var s=0;s<n;++s)e[r+s+4]=i[s];return 8*(r+4+n)},Pt=function(e,t,i,n,r,s,a,o,c,d,l){wt(t,l++,i),++r[256];for(var u=Tt(r,15),h=u[0],g=u[1],p=Tt(s,15),f=p[0],v=p[1],m=St(h),y=m[0],b=m[1],w=St(f),_=w[0],T=w[1],I=new Ye(19),S=0;S<y.length;++S)I[31&y[S]]++;for(S=0;S<_.length;++S)I[31&_[S]]++;for(var x=Tt(I,7),E=x[0],P=x[1],D=19;D>4&&!E[nt[D-1]];--D);var M,$,U,O,k=d+5<<3,z=xt(r,pt)+xt(s,ft)+a,R=xt(r,h)+xt(s,f)+a+14+3*D+xt(I,E)+(2*I[16]+3*I[17]+7*I[18]);if(k<=z&&k<=R)return Et(t,l,e.subarray(c,c+d));if(wt(t,l,1+(R<z)),l+=2,R<z){M=gt(h,g,0),$=h,U=gt(f,v,0),O=f;var A=gt(E,P,0);wt(t,l,b-257),wt(t,l+5,T-1),wt(t,l+10,D-4),l+=14;for(S=0;S<D;++S)wt(t,l+3*S,E[nt[S]]);l+=3*D;for(var V=[y,_],j=0;j<2;++j){var L=V[j];for(S=0;S<L.length;++S){var G=31&L[S];wt(t,l,A[G]),l+=E[G],G>15&&(wt(t,l,L[S]>>>5&127),l+=L[S]>>>12)}}}else M=vt,$=pt,U=mt,O=ft;for(S=0;S<o;++S)if(n[S]>255){G=n[S]>>>18&31;_t(t,l,M[G+257]),l+=$[G+257],G>7&&(wt(t,l,n[S]>>>23&31),l+=tt[G]);var C=31&n[S];_t(t,l,U[C]),l+=O[C],C>3&&(_t(t,l,n[S]>>>5&8191),l+=it[C])}else _t(t,l,M[n[S]]),l+=$[n[S]];return _t(t,l,M[256]),l+$[256]},Dt=new et([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),Mt=new Ze(0),$t=function(e,t,i,n,r,s){var a=e.length,o=new Ze(n+a+5*(1+Math.ceil(a/7e3))+r),c=o.subarray(n,o.length-r),d=0;if(!t||a<8)for(var l=0;l<=a;l+=65535){var u=l+65535;u<a?d=Et(c,d,e.subarray(l,u)):(c[l]=s,d=Et(c,d,e.subarray(l,a)))}else{for(var h=Dt[t-1],g=h>>>13,p=8191&h,f=(1<<i)-1,v=new Ye(32768),m=new Ye(f+1),y=Math.ceil(i/3),b=2*y,w=function(t){return(e[t]^e[t+1]<<y^e[t+2]<<b)&f},_=new et(25e3),T=new Ye(288),I=new Ye(32),S=0,x=0,E=(l=0,0),P=0,D=0;l<a;++l){var M=w(l),$=32767&l,U=m[M];if(v[$]=U,m[M]=$,P<=l){var O=a-l;if((S>7e3||E>24576)&&O>423){d=Pt(e,c,0,_,T,I,x,E,D,l-D,d),E=S=x=0,D=l;for(var k=0;k<286;++k)T[k]=0;for(k=0;k<30;++k)I[k]=0}var z=2,R=0,A=p,V=$-U&32767;if(O>2&&M==w(l-V))for(var j=Math.min(g,O)-1,L=Math.min(32767,l),G=Math.min(258,O);V<=L&&--A&&$!=U;){if(e[l+z]==e[l+z-V]){for(var C=0;C<G&&e[l+C]==e[l+C-V];++C);if(C>z){if(z=C,R=V,C>j)break;var N=Math.min(V,C-2),q=0;for(k=0;k<N;++k){var F=l-V+k+32768&32767,W=F-v[F]+32768&32767;W>q&&(q=W,U=F)}}}V+=($=U)-(U=v[$])+32768&32767}if(R){_[E++]=268435456|ot[z]<<18|dt[R];var B=31&ot[z],J=31&dt[R];x+=tt[B]+it[J],++T[257+B],++I[J],P=l+z,++S}else _[E++]=e[l],++T[e[l]]}}d=Pt(e,c,s,_,T,I,x,E,D,l-D,d),!s&&7&d&&(d=Et(c,d+1,Mt))}return bt(o,0,n+yt(d)+r)},Ut=function(){for(var e=new Int32Array(256),t=0;t<256;++t){for(var i=t,n=9;--n;)i=(1&i&&-306674912)^i>>>1;e[t]=i}return e}(),Ot=function(){var e=-1;return{p:function(t){for(var i=e,n=0;n<t.length;++n)i=Ut[255&i^t[n]]^i>>>8;e=i},d:function(){return~e}}},kt=function(e,t,i,n,r){return $t(e,null==t.level?6:t.level,null==t.mem?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(e.length)))):12+t.mem,i,n,!r)},zt=function(e,t,i){for(;i;++t)e[t]=i,i>>>=8},Rt=function(e,t){var i=t.filename;if(e[0]=31,e[1]=139,e[2]=8,e[8]=t.level<2?4:9==t.level?2:0,e[9]=3,0!=t.mtime&&zt(e,4,Math.floor(new Date(t.mtime||Date.now())/1e3)),i){e[3]=8;for(var n=0;n<=i.length;++n)e[n+10]=i.charCodeAt(n)}},At=function(e){return 10+(e.filename&&e.filename.length+1||0)};function Vt(e,t){t||(t={});var i=Ot(),n=e.length;i.p(e);var r=kt(e,t,At(t),8),s=r.length;return Rt(r,t),zt(r,s-8,i.d()),zt(r,s-4,n),r}var jt="undefined"!=typeof TextEncoder&&new TextEncoder,Lt="undefined"!=typeof TextDecoder&&new TextDecoder;try{Lt.decode(Mt,{stream:!0}),1}catch(e){}function Gt(e,t){if(t){for(var i=new Ze(e.length),n=0;n<e.length;++n)i[n]=e.charCodeAt(n);return i}if(jt)return jt.encode(e);var r=e.length,s=new Ze(e.length+(e.length>>1)),a=0,o=function(e){s[a++]=e};for(n=0;n<r;++n){if(a+5>s.length){var c=new Ze(a+8+(r-n<<1));c.set(s),s=c}var d=e.charCodeAt(n);d<128||t?o(d):d<2048?(o(192|d>>6),o(128|63&d)):d>55295&&d<57344?(o(240|(d=65536+(1047552&d)|1023&e.charCodeAt(++n))>>18),o(128|d>>12&63),o(128|d>>6&63),o(128|63&d)):(o(224|d>>12),o(128|d>>6&63),o(128|63&d))}return bt(s,0,a)}"function"==typeof queueMicrotask?queueMicrotask:"function"==typeof setTimeout&&setTimeout;const Ct="core.Pings.Database";function Nt(e){return e.path.split("/")[3]===H}function qt(e){return Gt(JSON.stringify(e)).length}function Ft(e){if(x(e)&&(2===Object.keys(e).length||3===Object.keys(e).length)){const t="path"in e&&P(e.path),i="payload"in e&&S(e.payload)&&x(e.payload),n=!("headers"in e)||S(e.headers)&&x(e.headers);return!!(t&&i&&n)}return!1}const Wt=class{constructor(e){this.store=new e("pings")}attachObserver(e){this.observer=e}recordPing(e,t,i,n){return r(this,void 0,void 0,(function*(){const r={collectionDate:(new Date).toISOString(),path:e,payload:i};n&&(r.headers=n),yield this.store.update([t],(()=>r)),this.observer&&this.observer.update(t,r)}))}deletePing(e){return r(this,void 0,void 0,(function*(){yield this.store.delete([e])}))}getAllPings(){return r(this,void 0,void 0,(function*(){const e=yield this.store.get(),t={};if(x(e))for(const i in e){const n=e[i];Ft(n)?t[i]=n:(a(Ct,"Unexpected data found in pings database. Deleting.",s.Warn),yield this.store.delete([i]))}return Object.entries(t).sort((([e,{collectionDate:t}],[i,{collectionDate:n}])=>new Date(t).getTime()-new Date(n).getTime()))}))}getAllPingsWithoutSurplus(e=250,t=10485760){return r(this,void 0,void 0,(function*(){const i=yield this.getAllPings(),n=i.filter((([e,t])=>!Nt(t))).reverse(),r=i.filter((([e,t])=>Nt(t))),o=n.length;o>e&&a(Ct,[`More than ${e} pending pings in the pings database,`,`will delete ${o-e} old pings.`],s.Warn);let c=!1,d=0,l=0;const u=[];for(const[i,r]of n)d++,l+=qt(r),!c&&l>t&&(a(Ct,[`Pending pings database has reached the size quota of ${t} bytes,`,"outstanding pings will be deleted."],s.Warn),c=!0),d>e&&(c=!0),c?yield this.deletePing(i):u.unshift([i,r]);return[...r,...u]}))}scanPendingPings(){return r(this,void 0,void 0,(function*(){if(!this.observer)return;const e=yield this.getAllPingsWithoutSurplus();for(const[t,i]of e)this.observer.update(t,i)}))}clearAll(){return r(this,void 0,void 0,(function*(){yield this.store.delete([])}))}};var Bt;!function(e){e[e.Incrementing=0]="Incrementing",e[e.Stopped=1]="Stopped",e[e.Throttled=2]="Throttled"}(Bt||(Bt={}));const Jt=class{constructor(e,t,i=0,n){this.interval=e,this.maxCount=t,this.count=i,this.started=n,this.stopped=!1}get elapsed(){if(E(this.started))return NaN;const e=z()-this.started;return e<0?NaN:e}reset(){this.started=z(),this.count=0,this.stopped=!1}shouldReset(){return!!E(this.started)||!!(isNaN(this.elapsed)||this.elapsed>this.interval)}getState(){this.shouldReset()&&this.reset();const e=this.interval-this.elapsed;return this.stopped?{state:1,remainingTime:e}:this.count>=this.maxCount?{state:2,remainingTime:e}:(this.count++,{state:0})}stop(){this.stopped=!0}},Ht="core.Upload";function Kt(){const e=new _(100,"core.Upload.Dispatcher");return e.flushInit(),e}class Xt{constructor(e=3,t=1048576){this.maxRecoverableFailures=e,this.maxPingBodySize=t}}class Zt extends Error{constructor(e){super(e),this.name="PingBodyOverflow"}}const Yt=class{constructor(e,t,i,n=new Xt,r=new Jt(6e4,15)){this.pingsDatabase=i,this.policy=n,this.rateLimiter=r,this.processing=[],this.uploader=e.httpClient?e.httpClient:t.uploader,this.platformInfo=t.info,this.serverEndpoint=e.serverEndpoint,this.dispatcher=Kt()}enqueuePing(e){for(const t of this.processing)if(t.identifier===e.identifier)return;this.processing.push(e);const{state:t,remainingTime:i}=this.rateLimiter.getState();0===t?this.dispatcher.resume():(this.dispatcher.stop(!1),2===t?a(Ht,["Attempted to upload a ping, but Glean is currently throttled.",`Pending pings will be processed in ${(i||0)/1e3}s.`],s.Debug):1===t&&a(Ht,["Attempted to upload a ping, but Glean has reached maximum recoverable upload failures","for the current uploading window.",`Will retry in ${(i||0)/1e3}s.`],s.Debug));(Nt(e)?this.dispatcher.launchPersistent:this.dispatcher.launch).bind(this.dispatcher)((()=>r(this,void 0,void 0,(function*(){const t=yield this.attemptPingUpload(e);(yield this.processPingUploadResponse(e.identifier,t))&&(e.retries++,this.enqueuePing(e)),e.retries>=this.policy.maxRecoverableFailures&&(a(Ht,`Reached maximum recoverable failures for ping "${JSON.stringify(e.name)}". You are done.`,s.Info),this.rateLimiter.stop(),this.dispatcher.stop(),e.retries=0)}))))}preparePingForUpload(e){return r(this,void 0,void 0,(function*(){let t=e.headers||{};t=Object.assign(Object.assign({},e.headers),{"Content-Type":"application/json; charset=utf-8",Date:(new Date).toISOString(),"X-Client-Type":"Glean.js","X-Client-Version":W,"X-Telemetry-Agent":`Glean/0.23.0 (JS on ${yield this.platformInfo.os()})`});const i=JSON.stringify(e.payload),n=Gt(i);let r,s;try{r=Vt(n),s=r.length,t["Content-Encoding"]="gzip"}catch(e){r=i,s=n.length}if(s>this.policy.maxPingBodySize)throw new Zt(`Body for ping ${e.identifier} exceeds ${this.policy.maxPingBodySize}bytes. Discarding.`);return t["Content-Length"]=s.toString(),{headers:t,payload:r}}))}attemptPingUpload(e){return r(this,void 0,void 0,(function*(){if(!I.initialized)return a(Ht,"Attempted to upload a ping, but Glean is not initialized yet. Ignoring.",s.Warn),new c(0);try{const t=yield this.preparePingForUpload(e);return yield this.uploader.post(`${this.serverEndpoint}${e.path}`,t.payload,t.headers)}catch(e){return a(Ht,["Error trying to build ping request:",e],s.Warn),new c(0)}}))}concludePingProcessing(e){this.processing=this.processing.filter((t=>t.identifier!==e))}processPingUploadResponse(e,t){return r(this,void 0,void 0,(function*(){this.concludePingProcessing(e);const{status:i,result:n}=t;return i&&i>=200&&i<300?(a(Ht,`Ping ${e} succesfully sent ${i}.`,s.Info),yield this.pingsDatabase.deletePing(e),!1):1===n||i&&i>=400&&i<500?(a(Ht,`Unrecoverable upload failure while attempting to send ping ${e}. Error was: ${null!=i?i:"no status"}.`,s.Warn),yield this.pingsDatabase.deletePing(e),!1):(a(Ht,[`Recoverable upload failure while attempting to send ping ${e}, will retry.`,`Error was ${null!=i?i:"no status"}.`],s.Warn),!0)}))}update(e,t){this.dispatcher.resume(),this.enqueuePing(Object.assign({identifier:e,retries:0},t))}shutdown(){return this.dispatcher.shutdown()}clearPendingPingsQueue(){return r(this,void 0,void 0,(function*(){this.dispatcher.clear(),yield this.dispatcher.shutdown(),this.processing=[],this.dispatcher=Kt()}))}testBlockOnPingsQueue(){return r(this,void 0,void 0,(function*(){return this.dispatcher.testBlockOnQueue()}))}};class ei{constructor(){this.clientId=new Be({name:"client_id",category:"",sendInPings:["glean_client_info"],lifetime:"user",disabled:!1}),this.firstRunDate=new we({name:"first_run_date",category:"",sendInPings:["glean_client_info"],lifetime:"user",disabled:!1},ve.Day),this.os=new Ee({name:"os",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1}),this.osVersion=new Ee({name:"os_version",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1}),this.architecture=new Ee({name:"architecture",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1}),this.locale=new Ee({name:"locale",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1}),this.appChannel=new Ee({name:"app_channel",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1}),this.appBuild=new Ee({name:"app_build",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1}),this.appDisplayVersion=new Ee({name:"app_display_version",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1})}initialize(e,t){return r(this,void 0,void 0,(function*(){yield this.initializeClientId(),yield this.initializeFirstRunDate(),yield Ee._private_setUndispatched(this.os,yield t.info.os()),yield Ee._private_setUndispatched(this.osVersion,yield t.info.osVersion(e.osVersion)),yield Ee._private_setUndispatched(this.architecture,yield t.info.arch(e.architecture)),yield Ee._private_setUndispatched(this.locale,yield t.info.locale()),yield Ee._private_setUndispatched(this.appBuild,e.appBuild||"Unknown"),yield Ee._private_setUndispatched(this.appDisplayVersion,e.appDisplayVersion||"Unknown"),e.channel&&(yield Ee._private_setUndispatched(this.appChannel,e.channel))}))}initializeClientId(){return r(this,void 0,void 0,(function*(){let e=!1;const t=yield I.metricsDatabase.getMetric(J,this.clientId);if(t)try{Qe("uuid",t).payload()===Q&&(e=!0)}catch(t){a("core.InternalMetrics","Unexpected value found for Glean clientId. Ignoring.",s.Warn),e=!0}else e=!0;e&&(yield Be._private_setUndispatched(this.clientId,O()))}))}initializeFirstRunDate(){return r(this,void 0,void 0,(function*(){(yield I.metricsDatabase.getMetric(J,this.firstRunDate))||(yield we._private_setUndispatched(this.firstRunDate))}))}}class ti{constructor(e,t,i,n){this.category=e,this.name=t,this.timestamp=i,this.extra=n}static toJSONObject(e){return{category:e.category,name:e.name,timestamp:e.timestamp,extra:e.extra}}static fromJSONObject(e){return new ti(e.category,e.name,e.timestamp,e.extra)}static withTransformedExtras(e,t){const i=t(e.extra||{});return new ti(e.category,e.name,e.timestamp,i&&Object.keys(i).length>0?i:void 0)}addExtra(e,t){this.extra||(this.extra={}),this.extra[e]=t}withoutReservedExtras(){return ti.withTransformedExtras(this,(e=>Object.keys(e).filter((e=>!Z.includes(e))).reduce(((t,i)=>(t[i]=e[i],t)),{})))}payload(){return ti.withTransformedExtras(this.withoutReservedExtras(),(e=>Object.keys(e).reduce(((t,i)=>(t[i]=e[i].toString(),t)),{})))}}class ii extends ce{constructor(e,t){super("event",e),this.allowedExtraKeys=t}static _private_recordUndispatched(e,t,n=z()){return r(this,void 0,void 0,(function*(){if(!e.shouldRecord(I.uploadEnabled))return;let r;if(t&&e.allowedExtraKeys){r={};for(const[n,s]of Object.entries(t))e.allowedExtraKeys.includes(n)?P(s)?r[n]=yield R(e,s,100):r[n]=s:yield I.errorManager.record(e,i.InvalidValue,`Invalid key index: ${n}`)}return I.eventsDatabase.record(e,new ti(e.category,e.name,n,r))}))}record(e){const t=z();I.dispatcher.launch((()=>r(this,void 0,void 0,(function*(){yield ii._private_recordUndispatched(this,e,t)}))))}testGetValue(e=this.sendInPings[0]){return r(this,void 0,void 0,(function*(){let t;return yield I.dispatcher.testLaunch((()=>r(this,void 0,void 0,(function*(){t=yield I.eventsDatabase.getEvents(e,this)})))),t}))}}n([A("core.metrics.EventMetricType")],ii.prototype,"testGetValue",null);const ni=ii;function ri(e){P(e)||(e="");const t=new Date(e);if(isNaN(t.getTime()))throw new Error(`Error attempting to generate Date object from string: ${e}`);return t}function si(e){return new pe(Object.assign(Object.assign({},{category:"glean",name:`reserved#${"execution_counter"}`}),{sendInPings:e,lifetime:"ping",disabled:!1}))}function ai(e){return new ni({category:"glean",name:"restarted",sendInPings:e,lifetime:"ping",disabled:!1},[K])}function oi(e,t=I.startTime){return r(this,void 0,void 0,(function*(){const i=ai(e);yield ni._private_recordUndispatched(i,{[K]:t.toISOString()},0)}))}const ci=class{constructor(e){this.initialized=!1,this.eventsStore=new e("events")}getAvailableStoreNames(){return r(this,void 0,void 0,(function*(){const e=yield this.eventsStore.get([]);return E(e)?[]:Object.keys(e)}))}initialize(){return r(this,void 0,void 0,(function*(){if(this.initialized)return;const e=yield this.getAvailableStoreNames();yield pe._private_addUndispatched(si(e),1),yield oi(e),this.initialized=!0}))}record(e,t){return r(this,void 0,void 0,(function*(){if(!e.disabled)for(const i of e.sendInPings){const e=si([i]);let n=yield I.metricsDatabase.getMetric(i,e);n||(yield pe._private_addUndispatched(e,1),n=1,yield oi([i],new Date)),t.addExtra(X,n);const r=e=>{var i;const n=null!==(i=e)&&void 0!==i?i:[];return n.push(ti.toJSONObject(t)),n};yield this.eventsStore.update([i],r)}}))}getEvents(e,t){return r(this,void 0,void 0,(function*(){const i=yield this.getAndValidatePingData(e);if(0!==i.length)return i.filter((e=>e.category===t.category&&e.name===t.name)).map((e=>e.withoutReservedExtras()))}))}getAndValidatePingData(e){return r(this,void 0,void 0,(function*(){const t=yield this.eventsStore.get([e]);return E(t)?[]:Array.isArray(t)?t.map((e=>ti.fromJSONObject(e))):(a("core.Metric.EventsDatabase",`Unexpected value found for ping ${e}: ${JSON.stringify(t)}. Clearing.`,s.Error),yield this.eventsStore.delete([e]),[])}))}getPingEvents(e,t){return r(this,void 0,void 0,(function*(){const i=yield this.getAndValidatePingData(e);if(t&&Object.keys(i).length>0&&(yield this.eventsStore.delete([e])),0===i.length)return;const n=yield this.prepareEventsPayload(e,i);return n.length>0?n:void 0}))}prepareEventsPayload(e,t){var n,s,a,o;return r(this,void 0,void 0,(function*(){const r=t.sort(((e,t)=>{var i,n;const r=Number(null===(i=e.extra)||void 0===i?void 0:i["#glean_execution_counter"]),s=Number(null===(n=t.extra)||void 0===n?void 0:n["#glean_execution_counter"]);return r!==s?r-s:e.timestamp-t.timestamp}));let c;try{c=ri(null===(n=r[0].extra)||void 0===n?void 0:n["#glean_reference_time"]),r.shift()}catch(e){c=I.startTime}const d=(null===(s=r[0])||void 0===s?void 0:s.timestamp)||0;let l=0;for(const[t,n]of r.entries()){try{const s=ri(null===(a=n.extra)||void 0===a?void 0:a["#glean_reference_time"]),o=s.getTime()-c.getTime();c=s;const d=l+o,u=r[t-1].timestamp;d<=u?(l=u+1,yield I.errorManager.record(ai([e]),i.InvalidValue,`Invalid time offset between application sessions found for ping "${e}". Ignoring.`)):l=d}catch(e){}let s;s=1===Number((null===(o=n.extra)||void 0===o?void 0:o["#glean_execution_counter"])||1)?n.timestamp-d:n.timestamp+l,r[t]=new ti(n.category,n.name,s,n.extra)}return r.map((e=>ti.toJSONObject(e.payload())))}))}clearAll(){return r(this,void 0,void 0,(function*(){yield this.eventsStore.delete([])}))}};const di={afterPingCollection:new class{constructor(e){this.name=e}get registeredPluginIdentifier(){var e;return null===(e=this.plugin)||void 0===e?void 0:e.name}registerPlugin(e){this.plugin?a("core.Events",[`Attempted to register plugin '${e.name}', which listens to the event '${e.event}'.`,`That event is already watched by plugin '${this.plugin.name}'`,`Plugin '${e.name}' will be ignored.`],s.Error):this.plugin=e}deregisterPlugin(){this.plugin=void 0}trigger(...e){if(this.plugin)return this.plugin.action(...e)}}("afterPingCollection")},li=di,ui="core.Pings.Maker";function hi(e){return r(this,void 0,void 0,(function*(){const{startTimeMetric:t,startTime:i}=yield function(e){return r(this,void 0,void 0,(function*(){const t=new we({category:"",name:`${e.name}#start`,sendInPings:[B],lifetime:"user",disabled:!1},ve.Minute),i=yield I.metricsDatabase.getMetric(B,t);let n;return n=i?new ye(i):ye.fromDate(I.startTime,ve.Minute),{startTimeMetric:t,startTime:n}}))}(e),n=new Date;yield we._private_setUndispatched(t,n);const s=ye.fromDate(n,ve.Minute);return{startTime:i.payload(),endTime:s.payload()}}))}function gi(e,t){return r(this,void 0,void 0,(function*(){const i=yield function(e){return r(this,void 0,void 0,(function*(){const t=new pe({category:"",name:`${e.name}#sequence`,sendInPings:[B],lifetime:"user",disabled:!1}),i=yield I.metricsDatabase.getMetric(B,t);if(yield pe._private_addUndispatched(t,1),i)try{return new he(i).payload()}catch(t){a(ui,`Unexpected value found for sequence number in ping ${e.name}. Ignoring.`,s.Warn)}return 0}))}(e),{startTime:n,endTime:o}=yield hi(e),c={seq:i,start_time:n,end_time:o};return t&&(c.reason=t),c}))}function pi(e,t){return r(this,void 0,void 0,(function*(){const i=yield I.eventsDatabase.getPingEvents(e.name,!0),n=yield I.metricsDatabase.getPingMetrics(e.name,!0);if(!n&&!i){if(!e.sendIfEmpty)return void a(ui,`Storage for ${e.name} empty. Bailing out.`,s.Info);a(ui,`Storage for ${e.name} empty. Ping will still be sent.`,s.Info)}const o=n?{metrics:n}:{},c=i?{events:i}:{},d=yield gi(e,t),l=yield function(e){return r(this,void 0,void 0,(function*(){let t=yield I.metricsDatabase.getPingMetrics(J,!0);t||(a(ui,"Empty client info data. Will submit anyways.",s.Warn),t={});let i={telemetry_sdk_build:W};for(const e in t)i=Object.assign(Object.assign({},i),t[e]);return e.includeClientId||delete i.client_id,i}))}(e);return Object.assign(Object.assign(Object.assign({},o),c),{ping_info:d,client_info:l})}))}const fi=function(e,t,i){return r(this,void 0,void 0,(function*(){const n=yield pi(t,i);if(!n)return;let r;try{r=yield li.afterPingCollection.trigger(n)}catch(e){return void a(ui,[`Error while attempting to modify ping payload for the "${t.name}" ping using`,`the ${JSON.stringify(li.afterPingCollection.registeredPluginIdentifier)} plugin.`,"Ping will not be submitted. See more logs below.\n\n",e],s.Error)}I.debugOptions.logPings&&a(ui,JSON.stringify(n,null,2),s.Info);const o=r||n,c=function(){var e,t;const i={};if((null===(e=I.debugOptions)||void 0===e?void 0:e.debugViewTag)&&(i["X-Debug-ID"]=I.debugOptions.debugViewTag),(null===(t=I.debugOptions)||void 0===t?void 0:t.sourceTags)&&(i["X-Source-Tags"]=I.debugOptions.sourceTags.toString()),Object.keys(i).length>0)return i}();return I.pingsDatabase.recordPing(function(e,t){return`/submit/${I.applicationId}/${t.name}/1/${e}`}(e,t),e,o,c)}))},vi="core.Pings.PingType";class mi{constructor(e){var t;this.name=e.name,this.includeClientId=e.includeClientId,this.sendIfEmpty=e.sendIfEmpty,this.reasonCodes=null!==(t=e.reasonCodes)&&void 0!==t?t:[]}isDeletionRequest(){return this.name===H}submit(e){this.testCallback?this.testCallback(e).then((()=>{mi._private_internalSubmit(this,e,this.resolveTestPromiseFunction)})).catch((t=>{a(vi,[`There was an error validating "${this.name}" (${null!=e?e:"no reason"}):`,t],s.Error),mi._private_internalSubmit(this,e,this.rejectTestPromiseFunction)})):mi._private_internalSubmit(this,e)}static _private_submitUndispatched(e,t,i){return r(this,void 0,void 0,(function*(){if(!I.initialized)return void a(vi,"Glean must be initialized before submitting pings.",s.Info);if(!I.uploadEnabled&&!e.isDeletionRequest())return void a(vi,"Glean disabled: not submitting pings. Glean may still submit the deletion-request ping.",s.Info);let n=t;t&&!e.reasonCodes.includes(t)&&(a(vi,`Invalid reason code ${t} from ${this.name}. Ignoring.`,s.Warn),n=void 0);const r=O();yield fi(r,e,n),i&&(i(),e.resolveTestPromiseFunction=void 0,e.rejectTestPromiseFunction=void 0,e.testCallback=void 0)}))}static _private_internalSubmit(e,t,i){I.dispatcher.launch((()=>r(this,void 0,void 0,(function*(){yield mi._private_submitUndispatched(e,t,i)}))))}testBeforeNextSubmit(e){return r(this,void 0,void 0,(function*(){if(!this.testCallback)return new Promise(((t,i)=>{this.resolveTestPromiseFunction=t,this.rejectTestPromiseFunction=i,this.testCallback=e}));a(vi,`There is an existing test call for ping "${this.name}". Ignoring.`,s.Error)}))}}n([A(vi)],mi.prototype,"testBeforeNextSubmit",null);const yi=mi;const bi=class{constructor(){this.deletionRequest=new yi({name:H,includeClientId:!0,sendIfEmpty:!0})}};function wi(e){const t=e.event;if(t in li){li[t].registerPlugin(e)}else a("core.Events.Utils",[`Attempted to register plugin '${e.name}', which listens to the event '${e.event}'.`,"That is not a valid Glean event. Ignoring"],s.Error)}function _i(e,t){const i=function(e){return e.split("/")[0]}(e.baseIdentifier());return new pe({name:se(t,i),category:"glean.error",lifetime:"ping",sendInPings:e.sendInPings,disabled:!1})}class Ti{record(e,t,i,n=1){return r(this,void 0,void 0,(function*(){const r=_i(e,t);a(function(e){return`core.Metrics.${e.type.charAt(0).toUpperCase()+e.type.slice(1)}`}(e),[`${e.baseIdentifier()}:`,i]),n>0&&(yield pe._private_addUndispatched(r,n))}))}testGetNumRecordedErrors(e,t,i){return r(this,void 0,void 0,(function*(){const n=_i(e,t);return(yield n.testGetValue(i))||0}))}}let Ii={};const Si=class{constructor(e){this.rootKey=e}get(e=[]){try{const t=G(Ii,[this.rootKey,...e]);return Promise.resolve(t)}catch(e){return Promise.reject(e)}}update(e,t){try{return Ii=C(Ii,[this.rootKey,...e],t),Promise.resolve()}catch(e){return Promise.reject(e)}}delete(e){try{Ii=function(e,t){if(0===t.length)return{};const i=Object.assign({},e);let n=i;for(const e of t.slice(0,t.length-1)){const i=n[e];if(!x(i))throw Error(`Attempted to delete an entry from an inexistent index: ${JSON.stringify(t)}.`);n=i}return delete n[t[t.length-1]],i}(Ii,[this.rootKey,...e])}catch(t){a("plaftom.test.Storage",[`Error attempting to delete key ${e.toString()} from storage. Ignoring.`,t],s.Warn)}return Promise.resolve()}};const xi={os:()=>Promise.resolve("Unknown"),osVersion:()=>Promise.resolve("Unknown"),arch:()=>Promise.resolve("Unknown"),locale:()=>Promise.resolve("Unknown")},Ei={Storage:Si,uploader:new class extends d{post(e,t,i){const n=new c(2,200);return Promise.resolve(n)}},info:xi,name:"test"},Pi="core.Glean";class Di{constructor(){if(!E(Di._instance))throw new Error("Tried to instantiate Glean through `new`.\n      Use Glean.instance instead to access the Glean singleton.");this._coreMetrics=new ei,this._corePings=new bi}static get instance(){return Di._instance||(Di._instance=new Di),Di._instance}static get pingUploader(){return Di.instance._pingUploader}static get coreMetrics(){return Di.instance._coreMetrics}static get corePings(){return Di.instance._corePings}static onUploadEnabled(){return r(this,void 0,void 0,(function*(){I.uploadEnabled=!0,yield Di.coreMetrics.initialize(Di.instance._config,Di.platform)}))}static onUploadDisabled(){return r(this,void 0,void 0,(function*(){I.uploadEnabled=!1,yield yi._private_submitUndispatched(Di.corePings.deletionRequest),yield Di.clearMetrics()}))}static clearMetrics(){return r(this,void 0,void 0,(function*(){let e;yield Di.pingUploader.clearPendingPingsQueue();try{e=new ye(yield I.metricsDatabase.getMetric(J,Di.coreMetrics.firstRunDate)).date}catch(t){e=new Date}yield I.eventsDatabase.clearAll(),yield I.metricsDatabase.clearAll(),yield I.pingsDatabase.clearAll(),I.uploadEnabled=!0,yield Be._private_setUndispatched(Di.coreMetrics.clientId,Q),yield we._private_setUndispatched(Di.coreMetrics.firstRunDate,e),I.uploadEnabled=!1}))}static initialize(e,t,i){if(I.initialized)return void a(Pi,"Attempted to initialize Glean, but it has already been initialized. Ignoring.",s.Warn);if(0===e.length)return void a(Pi,"Unable to initialize Glean, applicationId cannot be an empty string.",s.Error);if(!Di.instance._platform)return void a(Pi,"Unable to initialize Glean, environment has not been set.",s.Error);I.applicationId=function(e){return e.replace(/[^a-z0-9]+/gi,"-").toLowerCase()}(e);const n=new ee(i);if(I.debugOptions=n.debug,Di.instance._config=n,I.metricsDatabase=new Xe(Di.platform.Storage),I.eventsDatabase=new ci(Di.platform.Storage),I.pingsDatabase=new Wt(Di.platform.Storage),I.errorManager=new Ti,Di.instance._pingUploader=new Yt(n,Di.platform,I.pingsDatabase),I.pingsDatabase.attachObserver(Di.pingUploader),null==i?void 0:i.plugins)for(const e of i.plugins)wi(e);I.dispatcher.flushInit((()=>r(this,void 0,void 0,(function*(){if(I.initialized=!0,yield I.metricsDatabase.clear("application"),t)yield Di.onUploadEnabled();else{const e=yield I.metricsDatabase.getMetric(J,Di.coreMetrics.clientId);e?e!==Q&&(yield Di.onUploadDisabled()):yield Di.clearMetrics()}yield I.eventsDatabase.initialize(),yield I.pingsDatabase.scanPendingPings()}))))}static get serverEndpoint(){var e;return null===(e=Di.instance._config)||void 0===e?void 0:e.serverEndpoint}static get logPings(){var e,t;return(null===(t=null===(e=Di.instance._config)||void 0===e?void 0:e.debug)||void 0===t?void 0:t.logPings)||!1}static get debugViewTag(){var e;return null===(e=Di.instance._config)||void 0===e?void 0:e.debug.debugViewTag}static get sourceTags(){var e,t;return null===(t=null===(e=Di.instance._config)||void 0===e?void 0:e.debug.sourceTags)||void 0===t?void 0:t.toString()}static get platform(){if(!Di.instance._platform)throw new Error("IMPOSSIBLE: Attempted to access environment specific APIs before Glean was initialized.");return Di.instance._platform}static setUploadEnabled(e){I.dispatcher.launch((()=>r(this,void 0,void 0,(function*(){I.initialized?I.uploadEnabled!==e&&(e?yield Di.onUploadEnabled():yield Di.onUploadDisabled()):a(Pi,["Changing upload enabled before Glean is initialized is not supported.\n","Pass the correct state into `Glean.initialize\n`.","See documentation at https://mozilla.github.io/glean/book/user/general-api.html#initializing-the-glean-sdk`"],s.Error)}))))}static setLogPings(e){I.dispatcher.launch((()=>(Di.instance._config.debug.logPings=e,Promise.resolve())))}static setDebugViewTag(e){ee.validateDebugViewTag(e)?I.dispatcher.launch((()=>(Di.instance._config.debug.debugViewTag=e,Promise.resolve()))):a(Pi,`Invalid \`debugViewTag\` ${e}. Ignoring.`,s.Error)}static setSourceTags(e){ee.validateSourceTags(e)?I.dispatcher.launch((()=>(Di.instance._config.debug.sourceTags=e,Promise.resolve()))):a(Pi,`Invalid \`sourceTags\` ${e.toString()}. Ignoring.`,s.Error)}static shutdown(){return r(this,void 0,void 0,(function*(){yield I.dispatcher.shutdown(),yield Di.pingUploader.shutdown()}))}static setPlatform(e){I.initialized||(Di.instance._platform&&Di.instance._platform.name!==e.name&&!I.testing&&a(Pi,[`IMPOSSIBLE: Attempted to change Glean's targeted platform",\n          "from "${Di.platform.name}" to "${e.name}". Ignoring.`],s.Error),Di.instance._platform=e)}static testInitialize(e,t=!0,i){return r(this,void 0,void 0,(function*(){I.testing=!0,Di.setPlatform(Ei),Di.initialize(e,t,i),yield I.dispatcher.testBlockOnQueue()}))}static testUninitialize(e=!0){return r(this,void 0,void 0,(function*(){I.initialized&&(yield Di.shutdown(),e&&(yield I.eventsDatabase.clearAll(),yield I.metricsDatabase.clearAll(),yield I.pingsDatabase.clearAll()),I.testUninitialize(),function(){for(const e in li)li[e].deregisterPlugin()}())}))}static testResetGlean(e,t=!0,i,n=!0){return r(this,void 0,void 0,(function*(){yield Di.testUninitialize(n),yield Di.testInitialize(e,t,i)}))}}const Mi=Di,$i=Object.assign(Object.assign({},(Ui=F,{initialize(e,t,i){Mi.setPlatform(Ui),Mi.initialize(e,t,i)},setUploadEnabled(e){Mi.setUploadEnabled(e)},setLogPings(e){Mi.setLogPings(e)},setDebugViewTag(e){Mi.setDebugViewTag(e)},shutdown:()=>Mi.shutdown(),setSourceTags(e){Mi.setSourceTags(e)},testResetGlean(e,t=!0,i){return r(this,void 0,void 0,(function*(){return Mi.testResetGlean(e,t,i)}))}})),{ErrorType:i,_private:{PingType:yi,BooleanMetricType:ue,CounterMetricType:pe,DatetimeMetricType:we,EventMetricType:ni,LabeledMetricType:oe,QuantityMetricType:Ie,StringMetricType:Ee,StringListMetricType:$e,TimespanMetricType:Ve,TextMetricType:ze,UUIDMetricType:Be,URLMetricType:Ne}});var Ui})(),Glean=t})();