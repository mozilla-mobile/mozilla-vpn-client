var Glean;(()=>{var e={d:(t,i)=>{for(var n in i)e.o(i,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:i[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};(()=>{var i;e.r(t),e.d(t,{default:()=>xi}),function(e){e.InvalidValue="invalid_value",e.InvalidLabel="invalid_label",e.InvalidState="invalid_state",e.InvalidOverflow="invalid_overflow"}(i||(i={}));function n(e,t,i,n){return new(i||(i=Promise))((function(r,s){function a(e){try{c(n.next(e))}catch(e){s(e)}}function o(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}c((n=n.apply(e,t||[])).next())}))}Object.create;var r;Object.create;function s(e,t,i=r.Debug){const n=`(Glean.${e})`;"string"==typeof t?console[i](n,t):console[i](n,...t)}!function(e){e.Debug="debug",e.Info="info",e.Warn="warn",e.Error="error"}(r||(r={}));var a;!function(e){e[e.RecoverableFailure=0]="RecoverableFailure",e[e.UnrecoverableFailure=1]="UnrecoverableFailure",e[e.Success=2]="Success"}(a||(a={}));class o{constructor(e,t){this.result=e,this.status=t}}const c=class{};var d,l=new Uint8Array(16);function u(){if(!d&&!(d="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return d(l)}const h=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;const g=function(e){return"string"==typeof e&&h.test(e)};for(var f=[],p=0;p<256;++p)f.push((p+256).toString(16).substr(1));const v=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=(f[e[t+0]]+f[e[t+1]]+f[e[t+2]]+f[e[t+3]]+"-"+f[e[t+4]]+f[e[t+5]]+"-"+f[e[t+6]]+f[e[t+7]]+"-"+f[e[t+8]]+f[e[t+9]]+"-"+f[e[t+10]]+f[e[t+11]]+f[e[t+12]]+f[e[t+13]]+f[e[t+14]]+f[e[t+15]]).toLowerCase();if(!g(i))throw TypeError("Stringified UUID is invalid");return i};const m=function(e,t,i){var n=(e=e||{}).random||(e.rng||u)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){i=i||0;for(var r=0;r<16;++r)t[i+r]=n[r];return t}return v(n)};var y,b;!function(e){e[e.Uninitialized=0]="Uninitialized",e[e.Idle=1]="Idle",e[e.Processing=2]="Processing",e[e.Stopped=3]="Stopped",e[e.Shutdown=4]="Shutdown"}(y||(y={})),function(e){e.Task="Task",e.PersistentTask="PersistentTask",e.Stop="Stop",e.Clear="Clear",e.Shutdown="Shutdown",e.TestTask="TestTask"}(b||(b={}));const w=class{constructor(e=100,t="core.Dispatcher"){this.maxPreInitQueueSize=e,this.logTag=t,this.shuttingDown=!1,this.currentJob=Promise.resolve(),this.queue=[],this.state=0}getNextCommand(){return this.queue.shift()}executeTask(e){return n(this,void 0,void 0,(function*(){try{yield e()}catch(e){s(this.logTag,["Error executing task:",JSON.stringify(e)],r.Error)}}))}unblockTestResolvers(){this.queue.forEach((e=>{"TestTask"===e.command&&e.resolver()}))}execute(){return n(this,void 0,void 0,(function*(){let e=this.getNextCommand();for(;e;)switch(e.command){case"Stop":return void(this.state=3);case"Shutdown":return this.unblockTestResolvers(),this.queue=[],this.state=4,void(this.shuttingDown=!1);case"Clear":this.unblockTestResolvers(),this.queue=this.queue.filter((e=>["PersistentTask","Shutdown"].includes(e.command))),e=this.getNextCommand();continue;case"TestTask":yield this.executeTask(e.task),e.resolver(),e=this.getNextCommand();continue;case"PersistentTask":case"Task":yield this.executeTask(e.task),e=this.getNextCommand()}}))}triggerExecution(){1===this.state&&this.queue.length>0&&(this.state=2,this.currentJob=this.execute(),this.currentJob.then((()=>{const e=this;2===this.state&&(e.state=1)})).catch((e=>{s(this.logTag,["IMPOSSIBLE: Something went wrong while the dispatcher was executing the tasks queue.",e],r.Error)})))}launchInternal(e,t=!1){return 4===this.state?(s(this.logTag,"Attempted to enqueue a new task but the dispatcher is shutdown. Ignoring.",r.Warn),!1):!t&&0===this.state&&this.queue.length>=this.maxPreInitQueueSize?(s(this.logTag,"Unable to enqueue task, pre init queue is full.",r.Warn),!1):(t?this.queue.unshift(e):this.queue.push(e),this.triggerExecution(),!0)}launch(e){this.launchInternal({task:e,command:"Task"})}launchPersistent(e){this.launchInternal({task:e,command:"PersistentTask"})}flushInit(e){0===this.state?(e&&this.launchInternal({task:e,command:"Task"},!0),this.state=1,this.triggerExecution()):s(this.logTag,"Attempted to initialize the Dispatcher, but it is already initialized. Ignoring.",r.Warn)}clear(e=!0){this.launchInternal({command:"Clear"},e),this.resume()}stop(e=!0){this.shuttingDown?this.clear(e):this.launchInternal({command:"Stop"},e)}resume(){3===this.state&&(this.state=1,this.triggerExecution())}shutdown(){return this.shuttingDown=!0,this.launchInternal({command:"Shutdown"}),this.resume(),this.currentJob}testBlockOnQueue(){return n(this,void 0,void 0,(function*(){return yield this.currentJob}))}testUninitialize(){return n(this,void 0,void 0,(function*(){0!==this.state&&(this.clear(),yield this.shutdown(),this.state=0)}))}testLaunch(e){return new Promise(((t,i)=>{this.resume();this.launchInternal({resolver:t,task:e,command:"TestTask"})||i()}))}},_="core.Context";class S{constructor(){this._initialized=!1,this._startTime=new Date,this._dispatcher=new w}static get instance(){return S._instance||(S._instance=new S),S._instance}static testUninitialize(){S._instance=void 0}static get dispatcher(){return S.instance._dispatcher}static get uploadEnabled(){return void 0===S.instance._uploadEnabled&&s(_,["Attempted to access Context.uploadEnabled before it was set. This may cause unexpected behaviour."],r.Error),S.instance._uploadEnabled}static set uploadEnabled(e){S.instance._uploadEnabled=e}static get metricsDatabase(){return void 0===S.instance._metricsDatabase&&s(_,["Attempted to access Context.metricsDatabase before it was set. This may cause unexpected behaviour."],r.Error),S.instance._metricsDatabase}static set metricsDatabase(e){S.instance._metricsDatabase=e}static get eventsDatabase(){return void 0===S.instance._eventsDatabase&&s(_,["Attempted to access Context.eventsDatabase before it was set. This may cause unexpected behaviour."],r.Error),S.instance._eventsDatabase}static set eventsDatabase(e){S.instance._eventsDatabase=e}static get pingsDatabase(){return void 0===S.instance._pingsDatabase&&s(_,["Attempted to access Context.pingsDatabase before it was set. This may cause unexpected behaviour."],r.Error),S.instance._pingsDatabase}static set pingsDatabase(e){S.instance._pingsDatabase=e}static get errorManager(){return void 0===S.instance._errorManager&&s(_,["Attempted to access Context.errorManager before it was set. This may cause unexpected behaviour."],r.Error),S.instance._errorManager}static set errorManager(e){S.instance._errorManager=e}static get applicationId(){return void 0===S.instance._applicationId&&s(_,["Attempted to access Context.applicationId before it was set. This may cause unexpected behaviour."],r.Error),S.instance._applicationId}static set applicationId(e){S.instance._applicationId=e}static get initialized(){return S.instance._initialized}static set initialized(e){S.instance._initialized=e}static get debugOptions(){return void 0===S.instance._debugOptions&&s(_,["Attempted to access Context.debugOptions before it was set. This may cause unexpected behaviour."],r.Error),S.instance._debugOptions}static set debugOptions(e){S.instance._debugOptions=e}static get startTime(){return S.instance._startTime}}function x(e){if(E(e)||D(e)||P(e))return!0;if(I(e)){if(0===Object.keys(e).length)return!0;for(const t in e)return x(e[t])}return!!Array.isArray(e)&&e.every((e=>x(e)))}function I(e){return"object"==typeof e&&null!==e&&e.constructor===Object}function T(e){return void 0===e}function E(e){return"string"==typeof e}function D(e){return"boolean"==typeof e}function P(e){return"number"==typeof e&&!isNaN(e)}function $(e){return P(e)&&Number.isInteger(e)}function M(e){return/^[a-z0-9-]{1,20}$/i.test(e)}function U(){return"undefined"!=typeof crypto?m():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}const O=Date.now();function z(){return"undefined"==typeof performance?Date.now()-O:performance.now()}function R(e,t,r){return n(this,void 0,void 0,(function*(){const n=t.substr(0,r);return n!==t&&(yield S.errorManager.record(e,i.InvalidOverflow,`Value length ${t.length} exceeds maximum of ${r}.`)),n}))}const A="platform.qt.Uploader";const k=new class extends c{post(e,t,i={}){return n(this,void 0,void 0,(function*(){return new Promise((n=>{const a=new XMLHttpRequest;a.timeout=1e4,a.open("POST",e);for(const e in i)a.setRequestHeader(e,i[e]);a.ontimeout=function(e){s(A,["Timeout while attempting to upload ping.\n",e.type],r.Error),n(new o(0))},a.onerror=function(e){s(A,["Network error while attempting to upload ping.\n",e.type],r.Error),n(new o(0))},a.onabort=function(e){s(A,["The attempt to upload ping is aborted.\n",e.type],r.Error),n(new o(0))},a.onload=()=>{n(new o(2,a.status))},E(t)?a.send(t):a.send(t.buffer)}))}))}},N={os(){return n(this,void 0,void 0,(function*(){switch(Qt.platform.os){case"android":return"Android";case"ios":return"iOS";case"tvos":return"tvOS";case"linux":return"Linux";case"osx":return"Darwin";case"qnx":return"QNX";case"windows":case"winrt":return"Windows";case"wasm":return"Wasm";default:return"Unknown"}}))},osVersion(){return n(this,void 0,void 0,(function*(){return Promise.resolve("Unknown")}))},arch(){return n(this,void 0,void 0,(function*(){return Promise.resolve("Unknown")}))},locale(){return n(this,void 0,void 0,(function*(){const e=Qt.locale();return Promise.resolve(e?e.name.replace("_","-"):"und")}))}};function j(e,t){if(0===t.length)throw Error("The index must contain at least one property to get.");let i=e;for(const e of t){if(!I(i)||!(e in i))return;{const t=i[e];x(t)&&(i=t)}}return i}function V(e,t,i){if(0===t.length)throw Error("The index must contain at least one property to update.");const n=Object.assign({},e);let a=n;for(const e of t.slice(0,t.length-1))I(a[e])||(a[e]={}),a=a[e];const o=t[t.length-1],c=a[o];try{const e=i(c);return a[o]=e,n}catch(e){return s("core.Storage.Utils",["Error while transforming stored value. Ignoring old value.",JSON.stringify(e)],r.Error),a[o]=i(void 0),n}}function C(e,t="",i=[]){if(I(e)){const n=Object.keys(e);for(const r of n){const n=e[r];T(n)||C(n,`${t}${r}+`,i)}}else i.push([t.slice(0,-1),JSON.stringify(e)]);return i}function L(e){if(!e||0===e.rows.length)return;const t={};for(let i=0;i<e.rows.length;i++){const n=e.rows.item(i),r=n.key.split("+");let s=t;for(const e of r.slice(0,-1))T(s[e])&&(s[e]={}),s=s[e];try{s[r[r.length-1]]=JSON.parse(n.value)}catch(e){s[r[r.length-1]]=n.value}}return t}const G={Storage:class{constructor(e,t="Glean"){this.tableName=e,this.name=t,this.initialized=this._executeQuery(`CREATE TABLE IF NOT EXISTS ${e}(key VARCHAR(255), value VARCHAR(255));`),this.logTag=`platform.qt.Storage.${e}`}_createKeyFromIndex(e){return e.join("+")}get _dbHandle(){try{const e=LocalStorage.LocalStorage.openDatabaseSync(this.name,"1.0",`${this.name} Storage`,3e5);this.dbHandle=e}catch(e){s(this.logTag,["Error while attempting to access LocalStorage.\n",JSON.stringify(e)],r.Debug)}finally{return this.dbHandle}}_executeQuery(e){const t=this._dbHandle;return new Promise(((i,n)=>{try{t.transaction((t=>{const n=t.executeSql(e);i(n)}))}catch(t){s(this.logTag,[`Error executing LocalStorage query: ${e}.\n`,JSON.stringify(t)],r.Debug),n()}}))}_executeOnceInitialized(e){return n(this,void 0,void 0,(function*(){return yield this.initialized,this._executeQuery(e)}))}_getFullResultObject(e){return n(this,void 0,void 0,(function*(){const t=this._createKeyFromIndex(e);return L(yield this._executeOnceInitialized(`SELECT * FROM ${this.tableName} WHERE key LIKE "${t}%"`))}))}_getWholeStore(){return n(this,void 0,void 0,(function*(){return L(yield this._executeOnceInitialized(`SELECT * FROM ${this.tableName}`))}))}get(e=[]){return n(this,void 0,void 0,(function*(){if(0===e.length)return this._getWholeStore();const t=(yield this._getFullResultObject(e))||{};try{return j(t,e)}catch(e){s(this.logTag,["Error getting value from database.",JSON.stringify(e.message)])}}))}update(e,t){return n(this,void 0,void 0,(function*(){const i=C(V((yield this._getFullResultObject(e))||{},e,t));for(const e of i){const[t,i]=e,n=i.replace("'","''"),r=yield this._executeOnceInitialized(`UPDATE ${this.tableName} SET value='${n}' WHERE key='${t}'`);(null==r?void 0:r.rows.length)||(yield this._executeOnceInitialized(`INSERT INTO ${this.tableName}(key, value) VALUES('${t}', '${n}');`))}}))}delete(e){return n(this,void 0,void 0,(function*(){const t=this._createKeyFromIndex(e);yield this._executeOnceInitialized(`DELETE FROM ${this.tableName} WHERE key LIKE "${t}%"`)}))}},uploader:k,info:N,name:"Qt"},q="0.21.1",F="glean_ping_info",W="glean_client_info",J="c0ffeec0-ffee-c0ff-eec0-ffeec0ffeec0",B="deletion-request",H="#glean_reference_time",Q="#glean_execution_counter",K=[Q,H],X="core.Config";class Z{constructor(e){if(this.appBuild=null==e?void 0:e.appBuild,this.appDisplayVersion=null==e?void 0:e.appDisplayVersion,this.debug=Z.sanitizeDebugOptions(null==e?void 0:e.debug),(null==e?void 0:e.serverEndpoint)&&(t=e.serverEndpoint,!/^(http|https):\/\/[a-zA-Z0-9._-]+(:\d+){0,1}(\/{0,1})$/i.test(t)))throw new Error(`Unable to initialize Glean, serverEndpoint ${e.serverEndpoint} is an invalid URL.`);var t;this.serverEndpoint=e&&e.serverEndpoint?e.serverEndpoint:"https://incoming.telemetry.mozilla.org",this.httpClient=null==e?void 0:e.httpClient}static sanitizeDebugOptions(e){const t=e||{};return void 0===(null==e?void 0:e.debugViewTag)||Z.validateDebugViewTag(null==e?void 0:e.debugViewTag)||delete t.debugViewTag,void 0===(null==e?void 0:e.sourceTags)||Z.validateSourceTags(null==e?void 0:e.sourceTags)||delete t.sourceTags,t}static validateDebugViewTag(e){const t=M(e);return t||s(X,[`"${e}" is not a valid \`debugViewTag\` value.`,"Please make sure the value passed satisfies the regex `^[a-zA-Z0-9-]{1,20}$`."],r.Error),t}static validateSourceTags(e){if(e.length<1||e.length>5)return s(X,"A list of tags cannot contain more than 5 elements.",r.Error),!1;for(const t of e){if(t.startsWith("glean"))return s(X,"Tags starting with `glean` are reserved and must not be used.",r.Error),!1;if(!M(t))return!1}return!0}}class Y{constructor(e){if(!this.validate(e))throw new Error("Unable to create new Metric instance, value is in unexpected format.");this._inner=e}get(){return this._inner}set(e){this.validate(e)?this._inner=e:s("core.Metrics.Metric",`Unable to set metric to ${JSON.stringify(e)}. Value is in unexpected format. Ignoring.`,r.Error)}}class ee extends Y{constructor(e){super(e)}validate(e){return!0}payload(){return this._inner}}const te="__other__",ie=/^[a-z_][a-z0-9_-]{0,29}(\.[a-z_][a-z0-9_-]{0,29})*$/;function ne(e,t){return`${e}/${t}`}class re{constructor(e,t,i){return new Proxy(this,{get:(n,r)=>i?re.createFromStaticLabel(e,t,i,r):re.createFromDynamicLabel(e,t,r)})}static createFromStaticLabel(e,t,i,n){const r=i.includes(n)?n:te;return new t(Object.assign(Object.assign({},e),{name:ne(e.name,r)}))}static createFromDynamicLabel(e,t,i){return new t(Object.assign(Object.assign({},e),{dynamicLabel:i}))}}const se=re;class ae{constructor(e,t){this.type=e,this.name=t.name,this.category=t.category,this.sendInPings=t.sendInPings,this.lifetime=t.lifetime,this.disabled=t.disabled,this.dynamicLabel=t.dynamicLabel}baseIdentifier(){return this.category.length>0?`${this.category}.${this.name}`:this.name}identifier(){return n(this,void 0,void 0,(function*(){const e=this.baseIdentifier();return T(this.dynamicLabel)?e:yield function(e){return n(this,void 0,void 0,(function*(){if(void 0===e.dynamicLabel)throw new Error("This point should never be reached.");const t=ne(e.baseIdentifier(),e.dynamicLabel);for(const i of e.sendInPings)if(yield S.metricsDatabase.hasMetric(e.lifetime,i,e.type,t))return t;let n=0;for(const t of e.sendInPings)n+=(yield S.metricsDatabase.countByBaseIdentifier(e.lifetime,t,e.type,e.baseIdentifier()));let r=!1;return n>=16?r=!0:e.dynamicLabel.length>61?(r=!0,yield S.errorManager.record(e,i.InvalidLabel,`Label length ${e.dynamicLabel.length} exceeds maximum of 61.`)):ie.test(e.dynamicLabel)||(r=!0,yield S.errorManager.record(e,i.InvalidLabel,`Label must be snake_case, got '${e.dynamicLabel}'.`)),r?ne(e.baseIdentifier(),te):t}))}(this)}))}shouldRecord(e){return e&&!this.disabled}testGetNumRecordedErrors(e,t=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){return S.errorManager.testGetNumRecordedErrors(this,e,t)}))}}class oe extends Y{constructor(e){super(e)}validate(e){return D(e)}payload(){return this._inner}}const ce=class extends ae{constructor(e){super("boolean",e)}set(e){S.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(!this.shouldRecord(S.uploadEnabled))return;const t=new oe(e);yield S.metricsDatabase.record(this,t)}))))}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){let t;return yield S.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield S.metricsDatabase.getMetric(e,this)})))),t}))}};class de extends Y{constructor(e){super(e)}validate(e){return!!$(e)&&!(e<=0)}payload(){return this._inner}}class le extends ae{constructor(e){super("counter",e)}static _private_addUndispatched(e,t){return n(this,void 0,void 0,(function*(){if(!e.shouldRecord(S.uploadEnabled))return;if(T(t)&&(t=1),t<=0)return void(yield S.errorManager.record(e,i.InvalidValue,`Added negative and zero value ${t}`));const n=(e=>t=>{let i,n;try{i=new de(t),n=i.get()+e}catch(t){i=new de(e),n=e}return n>Number.MAX_SAFE_INTEGER&&(n=Number.MAX_SAFE_INTEGER),i.set(n),i})(t);yield S.metricsDatabase.transform(e,n)}))}add(e){S.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){return le._private_addUndispatched(this,e)}))))}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){let t;return yield S.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield S.metricsDatabase.getMetric(e,this)})))),t}))}}const ue=le;var he;!function(e){e.Nanosecond="nanosecond",e.Microsecond="microsecond",e.Millisecond="millisecond",e.Second="second",e.Minute="minute",e.Hour="hour",e.Day="day"}(he||(he={}));const ge=he;class fe extends Y{constructor(e){super(e)}static fromDate(e,t){return new fe({timeUnit:t,timezone:e.getTimezoneOffset(),date:e.toISOString()})}get date(){return new Date(this._inner.date)}get timezone(){return this._inner.timezone}get timeUnit(){return this._inner.timeUnit}get dateISOString(){return this._inner.date}validate(e){if(!I(e)||3!==Object.keys(e).length)return!1;const t="timeUnit"in e&&E(e.timeUnit)&&Object.values(ge).includes(e.timeUnit),i="timezone"in e&&P(e.timezone),n="date"in e&&E(e.date)&&24===e.date.length&&!isNaN(Date.parse(e.date));return!!(t&&i&&n)}payload(){const e=this.dateISOString.match(/\d+/g);if(!e||e.length<0)throw new Error("IMPOSSIBLE: Unable to extract date information from DatetimeMetric.");const t=new Date(parseInt(e[0]),parseInt(e[1])-1,parseInt(e[2]),parseInt(e[3])-this.timezone/60,parseInt(e[4]),parseInt(e[5]),parseInt(e[6])),i=function(e){const t=e/60*-1;return`${t>0?"+":"-"}${Math.abs(t).toString().padStart(2,"0")}:00`}(this.timezone),n=t.getFullYear().toString().padStart(2,"0"),r=(t.getMonth()+1).toString().padStart(2,"0"),s=t.getDate().toString().padStart(2,"0");if(this.timeUnit===ge.Day)return`${n}-${r}-${s}${i}`;const a=t.getHours().toString().padStart(2,"0");if(this.timeUnit===ge.Hour)return`${n}-${r}-${s}T${a}${i}`;const o=t.getMinutes().toString().padStart(2,"0");if(this.timeUnit===ge.Minute)return`${n}-${r}-${s}T${a}:${o}${i}`;const c=t.getSeconds().toString().padStart(2,"0");if(this.timeUnit===ge.Second)return`${n}-${r}-${s}T${a}:${o}:${c}${i}`;const d=t.getMilliseconds().toString().padStart(3,"0");return this.timeUnit===ge.Millisecond?`${n}-${r}-${s}T${a}:${o}:${c}.${d}${i}`:this.timeUnit===ge.Microsecond?`${n}-${r}-${s}T${a}:${o}:${c}.${d}000${i}`:`${n}-${r}-${s}T${a}:${o}:${c}.${d}000000${i}`}}class pe extends ae{constructor(e,t){super("datetime",e),this.timeUnit=t}static _private_setUndispatched(e,t){return n(this,void 0,void 0,(function*(){if(!e.shouldRecord(S.uploadEnabled))return;t||(t=new Date);const i=t;switch(e.timeUnit){case ge.Day:i.setMilliseconds(0),i.setSeconds(0),i.setMinutes(0),i.setMilliseconds(0);case ge.Hour:i.setMilliseconds(0),i.setSeconds(0),i.setMinutes(0);case ge.Minute:i.setMilliseconds(0),i.setSeconds(0);case ge.Second:i.setMilliseconds(0)}const n=fe.fromDate(t,e.timeUnit);yield S.metricsDatabase.record(e,n)}))}set(e){S.dispatcher.launch((()=>pe._private_setUndispatched(this,e)))}testGetValueAsDatetimeMetric(e){return n(this,void 0,void 0,(function*(){let t;if(yield S.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield S.metricsDatabase.getMetric(e,this)})))),t)return new fe(t)}))}testGetValueAsString(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){const t=yield this.testGetValueAsDatetimeMetric(e);return t?t.payload():void 0}))}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){const t=yield this.testGetValueAsDatetimeMetric(e);return t?t.date:void 0}))}}const ve=pe;class me extends Y{constructor(e){super(e)}validate(e){return!!$(e)&&!(e<0)}payload(){return this._inner}}class ye extends ae{constructor(e){super("quantity",e)}static _private_setUndispatched(e,t){return n(this,void 0,void 0,(function*(){if(!e.shouldRecord(S.uploadEnabled))return;if(t<0)return void(yield S.errorManager.record(e,i.InvalidValue,`Set negative value ${t}`));t>Number.MAX_SAFE_INTEGER&&(t=Number.MAX_SAFE_INTEGER);const n=new me(t);yield S.metricsDatabase.record(e,n)}))}set(e){S.dispatcher.launch((()=>ye._private_setUndispatched(this,e)))}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){let t;return yield S.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield S.metricsDatabase.getMetric(e,this)})))),t}))}}const be=ye;class we extends Y{constructor(e){super(e)}validate(e){return!!E(e)&&!(e.length>100)}payload(){return this._inner}}class _e extends ae{constructor(e){super("string",e)}static _private_setUndispatched(e,t){return n(this,void 0,void 0,(function*(){if(!e.shouldRecord(S.uploadEnabled))return;const i=yield R(e,t,100),n=new we(i);yield S.metricsDatabase.record(e,n)}))}set(e){S.dispatcher.launch((()=>_e._private_setUndispatched(this,e)))}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){let t;return yield S.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield S.metricsDatabase.getMetric(e,this)})))),t}))}}const Se=_e,xe=20;class Ie extends Y{constructor(e){super(e)}validate(e){if(!Array.isArray(e))return!1;if(e.length>xe)return!1;for(const t of e)if(!E(t)||t.length>50)return!1;return!0}payload(){return this._inner}}const Te=class extends ae{constructor(e){super("string_list",e)}set(e){S.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(!this.shouldRecord(S.uploadEnabled))return;const t=[];e.length>xe&&(yield S.errorManager.record(this,i.InvalidValue,`String list length of ${e.length} exceeds maximum of 20.`));for(let i=0;i<Math.min(e.length,xe);++i){const n=yield R(this,e[i],50);t.push(n)}const n=new Ie(t);yield S.metricsDatabase.record(this,n)}))))}add(e){S.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(!this.shouldRecord(S.uploadEnabled))return;const t=yield R(this,e,50);let n=0;const r=(e=>t=>{let i,r;try{i=new Ie(t),r=i.get(),n=r.length,r.length<xe&&r.push(e)}catch(t){i=new Ie([e]),r=[e]}return i.set(r),i})(t);yield S.metricsDatabase.transform(this,r),n>=xe&&(yield S.errorManager.record(this,i.InvalidValue,`String list length of ${n+1} exceeds maximum of 20.`))}))))}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){let t;return yield S.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield S.metricsDatabase.getMetric(e,this)})))),t}))}},Ee=204800;class De extends Y{constructor(e){super(e)}validate(e){return!!E(e)&&!(e.length>Ee)}payload(){return this._inner}}const Pe=class extends ae{constructor(e){super("text",e)}set(e){S.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(!this.shouldRecord(S.uploadEnabled))return;const t=yield R(this,e,Ee),i=new De(t);yield S.metricsDatabase.record(this,i)}))))}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){let t;return yield S.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield S.metricsDatabase.getMetric(e,this)})))),t}))}};class $e extends Y{constructor(e){super(e)}get timespan(){switch(this._inner.timeUnit){case ge.Nanosecond:return this._inner.timespan*10**6;case ge.Microsecond:return 1e3*this._inner.timespan;case ge.Millisecond:return this._inner.timespan;case ge.Second:return Math.round(this._inner.timespan/1e3);case ge.Minute:return Math.round(this._inner.timespan/1e3/60);case ge.Hour:return Math.round(this._inner.timespan/1e3/60/60);case ge.Day:return Math.round(this._inner.timespan/1e3/60/60/24)}}validate(e){if(!I(e)||2!==Object.keys(e).length)return!1;const t="timeUnit"in e&&E(e.timeUnit)&&Object.values(ge).includes(e.timeUnit),i="timespan"in e&&P(e.timespan)&&e.timespan>=0;return!(!t||!i)}payload(){return{time_unit:this._inner.timeUnit,value:this.timespan}}}class Me extends ae{constructor(e,t){super("timespan",e),this.timeUnit=t}static _private_setRawUndispatched(e,t){return n(this,void 0,void 0,(function*(){if(!e.shouldRecord(S.uploadEnabled))return;if(!T(e.startTime))return void(yield S.errorManager.record(e,i.InvalidState,"Timespan already running. Raw value not recorded."));let n=!1;const r=(t=>i=>{let r;try{r=new $e(i),n=!0}catch(i){r=new $e({timespan:t,timeUnit:e.timeUnit})}return r})(t);yield S.metricsDatabase.transform(e,r),n&&(yield S.errorManager.record(e,i.InvalidState,"Timespan value already recorded. New value discarded."))}))}start(){const e=z();S.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(this.shouldRecord(S.uploadEnabled)){if(T(this.startTime))return this.startTime=e,Promise.resolve();yield S.errorManager.record(this,i.InvalidState,"Timespan already started")}}))))}stop(){const e=z();S.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(!this.shouldRecord(S.uploadEnabled))return void(this.startTime=void 0);if(T(this.startTime))return void(yield S.errorManager.record(this,i.InvalidState,"Timespan not running."));const t=e-this.startTime;this.startTime=void 0,t<0?yield S.errorManager.record(this,i.InvalidState,"Timespan was negative."):yield Me._private_setRawUndispatched(this,t)}))))}cancel(){S.dispatcher.launch((()=>(this.startTime=void 0,Promise.resolve())))}setRawNanos(e){S.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){const t=e*10**-6;yield Me._private_setRawUndispatched(this,t)}))))}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){let t;if(yield S.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield S.metricsDatabase.getMetric(e,this)})))),t)return new $e(t).timespan}))}}const Ue=Me,Oe=/^[a-zA-Z][a-zA-Z0-9-\+\.]*:(.*)$/;class ze extends Error{constructor(e,t){super(t),this.type=e,this.name="UrlMetricError"}}class Re extends Y{constructor(e){super(e)}validate(e){if(!E(e))return!1;if(e.length>2048)throw new ze(i.InvalidOverflow,`URL length ${e.length} exceeds maximum of 2048.`);if(e.startsWith("data:"))throw new ze(i.InvalidValue,"URL metric does not support data URLs.");if(!Oe.test(e))throw new ze(i.InvalidValue,`"${e}" does not start with a valid URL scheme.`);return!0}payload(){return this._inner}}const Ae=class extends ae{constructor(e){super("url",e)}set(e){S.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(this.shouldRecord(S.uploadEnabled))try{const t=new Re(e);yield S.metricsDatabase.record(this,t)}catch(e){e instanceof ze&&(yield S.errorManager.record(this,e.type,e.message))}}))))}setUrl(e){this.set(e.toString())}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){let t;return yield S.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield S.metricsDatabase.getMetric(e,this)})))),t}))}},ke=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;class Ne extends Y{constructor(e){super(e)}validate(e){return!!E(e)&&ke.test(e)}payload(){return this._inner}}class je extends ae{constructor(e){super("uuid",e)}static _private_setUndispatched(e,t){return n(this,void 0,void 0,(function*(){if(!e.shouldRecord(S.uploadEnabled))return;let n;t||(t=U());try{n=new Ne(t)}catch(n){return void(yield S.errorManager.record(e,i.InvalidValue,`"${t}" is not a valid UUID.`))}yield S.metricsDatabase.record(e,n)}))}set(e){S.dispatcher.launch((()=>je._private_setUndispatched(this,e)))}generateAndSet(){if(!this.shouldRecord(S.uploadEnabled))return;const e=U();return this.set(e),e}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){let t;return yield S.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield S.metricsDatabase.getMetric(e,this)})))),t}))}}const Ve=je,Ce=Object.freeze({boolean:oe,counter:de,datetime:fe,labeled_boolean:ee,labeled_counter:ee,labeled_string:ee,quantity:me,string:we,string_list:Ie,text:De,timespan:$e,url:Re,uuid:Ne});function Le(e,t){if(!(e in Ce))throw new Error(`Unable to create metric of unknown type ${e}`);return new Ce[e](t)}function Ge(e,t){try{return Le(e,t),!0}catch(e){return!1}}const qe="core.Metrics.Database";const Fe=class{constructor(e){this.userStore=new e("userLifetimeMetrics"),this.pingStore=new e("pingLifetimeMetrics"),this.appStore=new e("appLifetimeMetrics")}_chooseStore(e){switch(e){case"user":return this.userStore;case"ping":return this.pingStore;case"application":return this.appStore}}record(e,t){return n(this,void 0,void 0,(function*(){yield this.transform(e,(()=>t))}))}transform(e,t){return n(this,void 0,void 0,(function*(){if(e.disabled)return;const i=this._chooseStore(e.lifetime),n=yield e.identifier();for(const r of e.sendInPings){const s=e=>t(e).get();yield i.update([r,e.type,n],s)}}))}hasMetric(e,t,i,r){return n(this,void 0,void 0,(function*(){const n=this._chooseStore(e);return!T(yield n.get([t,i,r]))}))}countByBaseIdentifier(e,t,i,r){return n(this,void 0,void 0,(function*(){const n=this._chooseStore(e),s=yield n.get([t,i]);return T(s)?0:Object.keys(s).filter((e=>e.startsWith(r))).length}))}getMetric(e,t){return n(this,void 0,void 0,(function*(){const i=this._chooseStore(t.lifetime),n=yield t.identifier(),a=yield i.get([e,t.type,n]);return T(a)||Ge(t.type,a)?a:(s(qe,`Unexpected value found for metric ${n}: ${JSON.stringify(a)}. Clearing.`,r.Error),void(yield i.delete([e,t.type,n])))}))}getAndValidatePingData(e,t){return n(this,void 0,void 0,(function*(){const i=this._chooseStore(t),n=yield i.get([e]);return T(n)?{}:function(e){if(I(e)){for(const t in e){const i=e[t];if(!I(i))return!1;for(const e in i)if(!Ge(t,i[e]))return s(qe,`Invalid metric representation found for metric "${e}"`,r.Debug),!1}return!0}return!1}(n)?n:(s(qe,`Unexpected value found for ping "${e}" in "${t}" store: ${JSON.stringify(n)}. Clearing.`,r.Debug),yield i.delete([e]),{})}))}processLabeledMetric(e,t,i,n){const r=`labeled_${t}`,s=i.split("/",2),a=s[0],o=s[1];if(r in e&&a in e[r]){const t=e[r][a];e[r][a]=Object.assign(Object.assign({},t),{[o]:n})}else e[r]=Object.assign(Object.assign({},e[r]),{[a]:{[o]:n}})}getPingMetrics(e,t){return n(this,void 0,void 0,(function*(){const i=yield this.getAndValidatePingData(e,"user"),n=yield this.getAndValidatePingData(e,"ping"),r=yield this.getAndValidatePingData(e,"application");t&&Object.keys(n).length>0&&(yield this.clear("ping",e));const s={};for(const e of[i,n,r])for(const t in e)for(const i in e[t])i.startsWith("glean.reserved#")||(i.includes("/")?this.processLabeledMetric(s,t,i,e[t][i]):s[t]=Object.assign(Object.assign({},s[t]),{[i]:e[t][i]}));return 0===Object.keys(s).length?void 0:function(e){const t={};for(const i in e){const n=e[i];t[i]={};for(const e in n){const r=Le(i,n[e]);t[i][e]=r.payload()}}return t}(s)}))}clear(e,t){return n(this,void 0,void 0,(function*(){const i=this._chooseStore(e),n=t?[t]:[];yield i.delete(n)}))}clearAll(){return n(this,void 0,void 0,(function*(){yield this.userStore.delete([]),yield this.pingStore.delete([]),yield this.appStore.delete([])}))}};var We=Uint8Array,Je=Uint16Array,Be=Uint32Array,He=new We([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Qe=new We([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Ke=new We([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Xe=function(e,t){for(var i=new Je(31),n=0;n<31;++n)i[n]=t+=1<<e[n-1];var r=new Be(i[30]);for(n=1;n<30;++n)for(var s=i[n];s<i[n+1];++s)r[s]=s-i[n]<<5|n;return[i,r]},Ze=Xe(He,2),Ye=Ze[0],et=Ze[1];Ye[28]=258,et[258]=28;for(var tt=Xe(Qe,0),it=(tt[0],tt[1]),nt=new Je(32768),rt=0;rt<32768;++rt){var st=(43690&rt)>>>1|(21845&rt)<<1;st=(61680&(st=(52428&st)>>>2|(13107&st)<<2))>>>4|(3855&st)<<4,nt[rt]=((65280&st)>>>8|(255&st)<<8)>>>1}var at=function(e,t,i){for(var n=e.length,r=0,s=new Je(t);r<n;++r)++s[e[r]-1];var a,o=new Je(t);for(r=0;r<t;++r)o[r]=o[r-1]+s[r-1]<<1;if(i){a=new Je(1<<t);var c=15-t;for(r=0;r<n;++r)if(e[r])for(var d=r<<4|e[r],l=t-e[r],u=o[e[r]-1]++<<l,h=u|(1<<l)-1;u<=h;++u)a[nt[u]>>>c]=d}else for(a=new Je(n),r=0;r<n;++r)e[r]&&(a[r]=nt[o[e[r]-1]++]>>>15-e[r]);return a},ot=new We(288);for(rt=0;rt<144;++rt)ot[rt]=8;for(rt=144;rt<256;++rt)ot[rt]=9;for(rt=256;rt<280;++rt)ot[rt]=7;for(rt=280;rt<288;++rt)ot[rt]=8;var ct=new We(32);for(rt=0;rt<32;++rt)ct[rt]=5;var dt=at(ot,9,0),lt=at(ct,5,0),ut=function(e){return(e+7)/8|0},ht=function(e,t,i){(null==t||t<0)&&(t=0),(null==i||i>e.length)&&(i=e.length);var n=new(e instanceof Je?Je:e instanceof Be?Be:We)(i-t);return n.set(e.subarray(t,i)),n},gt=function(e,t,i){i<<=7&t;var n=t/8|0;e[n]|=i,e[n+1]|=i>>>8},ft=function(e,t,i){i<<=7&t;var n=t/8|0;e[n]|=i,e[n+1]|=i>>>8,e[n+2]|=i>>>16},pt=function(e,t){for(var i=[],n=0;n<e.length;++n)e[n]&&i.push({s:n,f:e[n]});var r=i.length,s=i.slice();if(!r)return[St,0];if(1==r){var a=new We(i[0].s+1);return a[i[0].s]=1,[a,1]}i.sort((function(e,t){return e.f-t.f})),i.push({s:-1,f:25001});var o=i[0],c=i[1],d=0,l=1,u=2;for(i[0]={s:-1,f:o.f+c.f,l:o,r:c};l!=r-1;)o=i[i[d].f<i[u].f?d++:u++],c=i[d!=l&&i[d].f<i[u].f?d++:u++],i[l++]={s:-1,f:o.f+c.f,l:o,r:c};var h=s[0].s;for(n=1;n<r;++n)s[n].s>h&&(h=s[n].s);var g=new Je(h+1),f=vt(i[l-1],g,0);if(f>t){n=0;var p=0,v=f-t,m=1<<v;for(s.sort((function(e,t){return g[t.s]-g[e.s]||e.f-t.f}));n<r;++n){var y=s[n].s;if(!(g[y]>t))break;p+=m-(1<<f-g[y]),g[y]=t}for(p>>>=v;p>0;){var b=s[n].s;g[b]<t?p-=1<<t-g[b]++-1:++n}for(;n>=0&&p;--n){var w=s[n].s;g[w]==t&&(--g[w],++p)}f=t}return[new We(g),f]},vt=function(e,t,i){return-1==e.s?Math.max(vt(e.l,t,i+1),vt(e.r,t,i+1)):t[e.s]=i},mt=function(e){for(var t=e.length;t&&!e[--t];);for(var i=new Je(++t),n=0,r=e[0],s=1,a=function(e){i[n++]=e},o=1;o<=t;++o)if(e[o]==r&&o!=t)++s;else{if(!r&&s>2){for(;s>138;s-=138)a(32754);s>2&&(a(s>10?s-11<<5|28690:s-3<<5|12305),s=0)}else if(s>3){for(a(r),--s;s>6;s-=6)a(8304);s>2&&(a(s-3<<5|8208),s=0)}for(;s--;)a(r);s=1,r=e[o]}return[i.subarray(0,n),t]},yt=function(e,t){for(var i=0,n=0;n<t.length;++n)i+=e[n]*t[n];return i},bt=function(e,t,i){var n=i.length,r=ut(t+2);e[r]=255&n,e[r+1]=n>>>8,e[r+2]=255^e[r],e[r+3]=255^e[r+1];for(var s=0;s<n;++s)e[r+s+4]=i[s];return 8*(r+4+n)},wt=function(e,t,i,n,r,s,a,o,c,d,l){gt(t,l++,i),++r[256];for(var u=pt(r,15),h=u[0],g=u[1],f=pt(s,15),p=f[0],v=f[1],m=mt(h),y=m[0],b=m[1],w=mt(p),_=w[0],S=w[1],x=new Je(19),I=0;I<y.length;++I)x[31&y[I]]++;for(I=0;I<_.length;++I)x[31&_[I]]++;for(var T=pt(x,7),E=T[0],D=T[1],P=19;P>4&&!E[Ke[P-1]];--P);var $,M,U,O,z=d+5<<3,R=yt(r,ot)+yt(s,ct)+a,A=yt(r,h)+yt(s,p)+a+14+3*P+yt(x,E)+(2*x[16]+3*x[17]+7*x[18]);if(z<=R&&z<=A)return bt(t,l,e.subarray(c,c+d));if(gt(t,l,1+(A<R)),l+=2,A<R){$=at(h,g,0),M=h,U=at(p,v,0),O=p;var k=at(E,D,0);gt(t,l,b-257),gt(t,l+5,S-1),gt(t,l+10,P-4),l+=14;for(I=0;I<P;++I)gt(t,l+3*I,E[Ke[I]]);l+=3*P;for(var N=[y,_],j=0;j<2;++j){var V=N[j];for(I=0;I<V.length;++I){var C=31&V[I];gt(t,l,k[C]),l+=E[C],C>15&&(gt(t,l,V[I]>>>5&127),l+=V[I]>>>12)}}}else $=dt,M=ot,U=lt,O=ct;for(I=0;I<o;++I)if(n[I]>255){C=n[I]>>>18&31;ft(t,l,$[C+257]),l+=M[C+257],C>7&&(gt(t,l,n[I]>>>23&31),l+=He[C]);var L=31&n[I];ft(t,l,U[L]),l+=O[L],L>3&&(ft(t,l,n[I]>>>5&8191),l+=Qe[L])}else ft(t,l,$[n[I]]),l+=M[n[I]];return ft(t,l,$[256]),l+M[256]},_t=new Be([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),St=new We(0),xt=function(e,t,i,n,r,s){var a=e.length,o=new We(n+a+5*(1+Math.ceil(a/7e3))+r),c=o.subarray(n,o.length-r),d=0;if(!t||a<8)for(var l=0;l<=a;l+=65535){var u=l+65535;u<a?d=bt(c,d,e.subarray(l,u)):(c[l]=s,d=bt(c,d,e.subarray(l,a)))}else{for(var h=_t[t-1],g=h>>>13,f=8191&h,p=(1<<i)-1,v=new Je(32768),m=new Je(p+1),y=Math.ceil(i/3),b=2*y,w=function(t){return(e[t]^e[t+1]<<y^e[t+2]<<b)&p},_=new Be(25e3),S=new Je(288),x=new Je(32),I=0,T=0,E=(l=0,0),D=0,P=0;l<a;++l){var $=w(l),M=32767&l,U=m[$];if(v[M]=U,m[$]=M,D<=l){var O=a-l;if((I>7e3||E>24576)&&O>423){d=wt(e,c,0,_,S,x,T,E,P,l-P,d),E=I=T=0,P=l;for(var z=0;z<286;++z)S[z]=0;for(z=0;z<30;++z)x[z]=0}var R=2,A=0,k=f,N=M-U&32767;if(O>2&&$==w(l-N))for(var j=Math.min(g,O)-1,V=Math.min(32767,l),C=Math.min(258,O);N<=V&&--k&&M!=U;){if(e[l+R]==e[l+R-N]){for(var L=0;L<C&&e[l+L]==e[l+L-N];++L);if(L>R){if(R=L,A=N,L>j)break;var G=Math.min(N,L-2),q=0;for(z=0;z<G;++z){var F=l-N+z+32768&32767,W=F-v[F]+32768&32767;W>q&&(q=W,U=F)}}}N+=(M=U)-(U=v[M])+32768&32767}if(A){_[E++]=268435456|et[R]<<18|it[A];var J=31&et[R],B=31&it[A];T+=He[J]+Qe[B],++S[257+J],++x[B],D=l+R,++I}else _[E++]=e[l],++S[e[l]]}}d=wt(e,c,s,_,S,x,T,E,P,l-P,d),!s&&7&d&&(d=bt(c,d+1,St))}return ht(o,0,n+ut(d)+r)},It=function(){for(var e=new Int32Array(256),t=0;t<256;++t){for(var i=t,n=9;--n;)i=(1&i&&-306674912)^i>>>1;e[t]=i}return e}(),Tt=function(){var e=-1;return{p:function(t){for(var i=e,n=0;n<t.length;++n)i=It[255&i^t[n]]^i>>>8;e=i},d:function(){return~e}}},Et=function(e,t,i,n,r){return xt(e,null==t.level?6:t.level,null==t.mem?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(e.length)))):12+t.mem,i,n,!r)},Dt=function(e,t,i){for(;i;++t)e[t]=i,i>>>=8},Pt=function(e,t){var i=t.filename;if(e[0]=31,e[1]=139,e[2]=8,e[8]=t.level<2?4:9==t.level?2:0,e[9]=3,0!=t.mtime&&Dt(e,4,Math.floor(new Date(t.mtime||Date.now())/1e3)),i){e[3]=8;for(var n=0;n<=i.length;++n)e[n+10]=i.charCodeAt(n)}},$t=function(e){return 10+(e.filename&&e.filename.length+1||0)};function Mt(e,t){t||(t={});var i=Tt(),n=e.length;i.p(e);var r=Et(e,t,$t(t),8),s=r.length;return Pt(r,t),Dt(r,s-8,i.d()),Dt(r,s-4,n),r}var Ut="undefined"!=typeof TextEncoder&&new TextEncoder,Ot="undefined"!=typeof TextDecoder&&new TextDecoder;try{Ot.decode(St,{stream:!0}),1}catch(e){}function zt(e,t){if(t){for(var i=new We(e.length),n=0;n<e.length;++n)i[n]=e.charCodeAt(n);return i}if(Ut)return Ut.encode(e);var r=e.length,s=new We(e.length+(e.length>>1)),a=0,o=function(e){s[a++]=e};for(n=0;n<r;++n){if(a+5>s.length){var c=new We(a+8+(r-n<<1));c.set(s),s=c}var d=e.charCodeAt(n);d<128||t?o(d):d<2048?(o(192|d>>6),o(128|63&d)):d>55295&&d<57344?(o(240|(d=65536+(1047552&d)|1023&e.charCodeAt(++n))>>18),o(128|d>>12&63),o(128|d>>6&63),o(128|63&d)):(o(224|d>>12),o(128|d>>6&63),o(128|63&d))}return ht(s,0,a)}"function"==typeof queueMicrotask?queueMicrotask:"function"==typeof setTimeout&&setTimeout;const Rt="core.Pings.Database";function At(e){return e.path.split("/")[3]===B}function kt(e){return zt(JSON.stringify(e)).length}function Nt(e){if(I(e)&&(2===Object.keys(e).length||3===Object.keys(e).length)){const t="path"in e&&E(e.path),i="payload"in e&&x(e.payload)&&I(e.payload),n=!("headers"in e)||x(e.headers)&&I(e.headers);return!!(t&&i&&n)}return!1}const jt=class{constructor(e){this.store=new e("pings")}attachObserver(e){this.observer=e}recordPing(e,t,i,r){return n(this,void 0,void 0,(function*(){const n={collectionDate:(new Date).toISOString(),path:e,payload:i};r&&(n.headers=r),yield this.store.update([t],(()=>n)),this.observer&&this.observer.update(t,n)}))}deletePing(e){return n(this,void 0,void 0,(function*(){yield this.store.delete([e])}))}getAllPings(){return n(this,void 0,void 0,(function*(){const e=yield this.store.get(),t={};if(I(e))for(const i in e){const n=e[i];Nt(n)?t[i]=n:(s(Rt,"Unexpected data found in pings database. Deleting.",r.Warn),yield this.store.delete([i]))}return Object.entries(t).sort((([e,{collectionDate:t}],[i,{collectionDate:n}])=>new Date(t).getTime()-new Date(n).getTime()))}))}getAllPingsWithoutSurplus(e=250,t=10485760){return n(this,void 0,void 0,(function*(){const i=yield this.getAllPings(),n=i.filter((([e,t])=>!At(t))).reverse(),a=i.filter((([e,t])=>At(t))),o=n.length;o>e&&s(Rt,[`More than ${e} pending pings in the pings database,`,`will delete ${o-e} old pings.`],r.Warn);let c=!1,d=0,l=0;const u=[];for(const[i,a]of n)d++,l+=kt(a),!c&&l>t&&(s(Rt,[`Pending pings database has reached the size quota of ${t} bytes,`,"outstanding pings will be deleted."],r.Warn),c=!0),d>e&&(c=!0),c?yield this.deletePing(i):u.unshift([i,a]);return[...a,...u]}))}scanPendingPings(){return n(this,void 0,void 0,(function*(){if(!this.observer)return;const e=yield this.getAllPingsWithoutSurplus();for(const[t,i]of e)this.observer.update(t,i)}))}clearAll(){return n(this,void 0,void 0,(function*(){yield this.store.delete([])}))}};var Vt;!function(e){e[e.Incrementing=0]="Incrementing",e[e.Stopped=1]="Stopped",e[e.Throttled=2]="Throttled"}(Vt||(Vt={}));const Ct=class{constructor(e,t,i=0,n){this.interval=e,this.maxCount=t,this.count=i,this.started=n,this.stopped=!1}get elapsed(){if(T(this.started))return NaN;const e=z()-this.started;return e<0?NaN:e}reset(){this.started=z(),this.count=0,this.stopped=!1}shouldReset(){return!!T(this.started)||!!(isNaN(this.elapsed)||this.elapsed>this.interval)}getState(){this.shouldReset()&&this.reset();const e=this.interval-this.elapsed;return this.stopped?{state:1,remainingTime:e}:this.count>=this.maxCount?{state:2,remainingTime:e}:(this.count++,{state:0})}stop(){this.stopped=!0}},Lt="core.Upload";function Gt(){const e=new w(100,"core.Upload.Dispatcher");return e.flushInit(),e}class qt{constructor(e=3,t=1048576){this.maxRecoverableFailures=e,this.maxPingBodySize=t}}class Ft extends Error{constructor(e){super(e),this.name="PingBodyOverflow"}}const Wt=class{constructor(e,t,i,n=new qt,r=new Ct(6e4,15)){this.pingsDatabase=i,this.policy=n,this.rateLimiter=r,this.processing=[],this.uploader=e.httpClient?e.httpClient:t.uploader,this.platformInfo=t.info,this.serverEndpoint=e.serverEndpoint,this.dispatcher=Gt()}enqueuePing(e){for(const t of this.processing)if(t.identifier===e.identifier)return;this.processing.push(e);const{state:t,remainingTime:i}=this.rateLimiter.getState();0===t?this.dispatcher.resume():(this.dispatcher.stop(!1),2===t?s(Lt,["Attempted to upload a ping, but Glean is currently throttled.",`Pending pings will be processed in ${(i||0)/1e3}s.`],r.Debug):1===t&&s(Lt,["Attempted to upload a ping, but Glean has reached maximum recoverable upload failures","for the current uploading window.",`Will retry in ${(i||0)/1e3}s.`],r.Debug));(At(e)?this.dispatcher.launchPersistent:this.dispatcher.launch).bind(this.dispatcher)((()=>n(this,void 0,void 0,(function*(){const t=yield this.attemptPingUpload(e);(yield this.processPingUploadResponse(e.identifier,t))&&(e.retries++,this.enqueuePing(e)),e.retries>=this.policy.maxRecoverableFailures&&(s(Lt,`Reached maximum recoverable failures for ping "${JSON.stringify(e.name)}". You are done.`,r.Info),this.rateLimiter.stop(),this.dispatcher.stop(),e.retries=0)}))))}preparePingForUpload(e){return n(this,void 0,void 0,(function*(){let t=e.headers||{};t=Object.assign(Object.assign({},e.headers),{"Content-Type":"application/json; charset=utf-8",Date:(new Date).toISOString(),"X-Client-Type":"Glean.js","X-Client-Version":q,"X-Telemetry-Agent":`Glean/0.21.1 (JS on ${yield this.platformInfo.os()})`});const i=JSON.stringify(e.payload),n=zt(i);let r,s;try{r=Mt(n),s=r.length,t["Content-Encoding"]="gzip"}catch(e){r=i,s=n.length}if(s>this.policy.maxPingBodySize)throw new Ft(`Body for ping ${e.identifier} exceeds ${this.policy.maxPingBodySize}bytes. Discarding.`);return t["Content-Length"]=s.toString(),{headers:t,payload:r}}))}attemptPingUpload(e){return n(this,void 0,void 0,(function*(){if(!S.initialized)return s(Lt,"Attempted to upload a ping, but Glean is not initialized yet. Ignoring.",r.Warn),new o(0);try{const t=yield this.preparePingForUpload(e);return yield this.uploader.post(`${this.serverEndpoint}${e.path}`,t.payload,t.headers)}catch(e){return s(Lt,["Error trying to build ping request:",e.message],r.Warn),new o(0)}}))}concludePingProcessing(e){this.processing=this.processing.filter((t=>t.identifier!==e))}processPingUploadResponse(e,t){return n(this,void 0,void 0,(function*(){this.concludePingProcessing(e);const{status:i,result:n}=t;return i&&i>=200&&i<300?(s(Lt,`Ping ${e} succesfully sent ${i}.`,r.Info),yield this.pingsDatabase.deletePing(e),!1):1===n||i&&i>=400&&i<500?(s(Lt,`Unrecoverable upload failure while attempting to send ping ${e}. Error was: ${null!=i?i:"no status"}.`,r.Warn),yield this.pingsDatabase.deletePing(e),!1):(s(Lt,[`Recoverable upload failure while attempting to send ping ${e}, will retry.`,`Error was ${null!=i?i:"no status"}.`],r.Warn),!0)}))}update(e,t){this.dispatcher.resume(),this.enqueuePing(Object.assign({identifier:e,retries:0},t))}shutdown(){return this.dispatcher.shutdown()}clearPendingPingsQueue(){return n(this,void 0,void 0,(function*(){this.dispatcher.clear(),yield this.dispatcher.shutdown(),this.processing=[],this.dispatcher=Gt()}))}testBlockOnPingsQueue(){return n(this,void 0,void 0,(function*(){return this.dispatcher.testBlockOnQueue()}))}};class Jt{constructor(){this.clientId=new Ve({name:"client_id",category:"",sendInPings:["glean_client_info"],lifetime:"user",disabled:!1}),this.firstRunDate=new ve({name:"first_run_date",category:"",sendInPings:["glean_client_info"],lifetime:"user",disabled:!1},ge.Day),this.os=new Se({name:"os",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1}),this.osVersion=new Se({name:"os_version",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1}),this.architecture=new Se({name:"architecture",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1}),this.locale=new Se({name:"locale",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1}),this.appBuild=new Se({name:"app_build",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1}),this.appDisplayVersion=new Se({name:"app_display_version",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1})}initialize(e,t){return n(this,void 0,void 0,(function*(){yield this.initializeClientId(),yield this.initializeFirstRunDate(),yield Se._private_setUndispatched(this.os,yield t.info.os()),yield Se._private_setUndispatched(this.osVersion,yield t.info.osVersion()),yield Se._private_setUndispatched(this.architecture,yield t.info.arch()),yield Se._private_setUndispatched(this.locale,yield t.info.locale()),yield Se._private_setUndispatched(this.appBuild,e.appBuild||"Unknown"),yield Se._private_setUndispatched(this.appDisplayVersion,e.appDisplayVersion||"Unknown")}))}initializeClientId(){return n(this,void 0,void 0,(function*(){let e=!1;const t=yield S.metricsDatabase.getMetric(W,this.clientId);if(t)try{Le("uuid",t).payload()===J&&(e=!0)}catch(t){s("core.InternalMetrics","Unexpected value found for Glean clientId. Ignoring.",r.Warn),e=!0}else e=!0;e&&(yield Ve._private_setUndispatched(this.clientId,U()))}))}initializeFirstRunDate(){return n(this,void 0,void 0,(function*(){(yield S.metricsDatabase.getMetric(W,this.firstRunDate))||(yield ve._private_setUndispatched(this.firstRunDate))}))}}class Bt{constructor(e,t,i,n){this.category=e,this.name=t,this.timestamp=i,this.extra=n}static toJSONObject(e){return{category:e.category,name:e.name,timestamp:e.timestamp,extra:e.extra}}static fromJSONObject(e){return new Bt(e.category,e.name,e.timestamp,e.extra)}static withTransformedExtras(e,t){const i=t(e.extra||{});return new Bt(e.category,e.name,e.timestamp,i&&Object.keys(i).length>0?i:void 0)}addExtra(e,t){this.extra||(this.extra={}),this.extra[e]=t}withoutReservedExtras(){return Bt.withTransformedExtras(this,(e=>Object.keys(e).filter((e=>!K.includes(e))).reduce(((t,i)=>(t[i]=e[i],t)),{})))}payload(){return Bt.withTransformedExtras(this.withoutReservedExtras(),(e=>Object.keys(e).reduce(((t,i)=>(t[i]=e[i].toString(),t)),{})))}}class Ht extends ae{constructor(e,t){super("event",e),this.allowedExtraKeys=t}static _private_recordUndispatched(e,t,r=z()){return n(this,void 0,void 0,(function*(){if(!e.shouldRecord(S.uploadEnabled))return;let n;if(t&&e.allowedExtraKeys){n={};for(const[r,s]of Object.entries(t))e.allowedExtraKeys.includes(r)?E(s)?n[r]=yield R(e,s,100):n[r]=s:yield S.errorManager.record(e,i.InvalidValue,`Invalid key index: ${r}`)}return S.eventsDatabase.record(e,new Bt(e.category,e.name,r,n))}))}record(e){const t=z();S.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){yield Ht._private_recordUndispatched(this,e,t)}))))}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){let t;return yield S.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield S.eventsDatabase.getEvents(e,this)})))),t}))}}const Kt=Ht;function Xt(e){E(e)||(e="");const t=new Date(e);if(isNaN(t.getTime()))throw new Error(`Error attempting to generate Date object from string: ${e}`);return t}function Zt(e){return new ue(Object.assign(Object.assign({},{category:"glean",name:`reserved#${"execution_counter"}`}),{sendInPings:e,lifetime:"ping",disabled:!1}))}function Yt(e){return new Kt({category:"glean",name:"restarted",sendInPings:e,lifetime:"ping",disabled:!1},[H])}function ei(e,t=S.startTime){return n(this,void 0,void 0,(function*(){const i=Yt(e);yield Kt._private_recordUndispatched(i,{[H]:t.toISOString()},0)}))}const ti=class{constructor(e){this.initialized=!1,this.eventsStore=new e("events")}getAvailableStoreNames(){return n(this,void 0,void 0,(function*(){const e=yield this.eventsStore.get([]);return T(e)?[]:Object.keys(e)}))}initialize(){return n(this,void 0,void 0,(function*(){if(this.initialized)return;const e=yield this.getAvailableStoreNames();yield ue._private_addUndispatched(Zt(e),1),yield ei(e),this.initialized=!0}))}record(e,t){return n(this,void 0,void 0,(function*(){if(!e.disabled)for(const i of e.sendInPings){const e=Zt([i]);let n=yield S.metricsDatabase.getMetric(i,e);n||(yield ue._private_addUndispatched(e,1),n=1,yield ei([i],new Date)),t.addExtra(Q,n);const r=e=>{var i;const n=null!==(i=e)&&void 0!==i?i:[];return n.push(Bt.toJSONObject(t)),n};yield this.eventsStore.update([i],r)}}))}getEvents(e,t){return n(this,void 0,void 0,(function*(){const i=yield this.getAndValidatePingData(e);if(0!==i.length)return i.filter((e=>e.category===t.category&&e.name===t.name)).map((e=>e.withoutReservedExtras()))}))}getAndValidatePingData(e){return n(this,void 0,void 0,(function*(){const t=yield this.eventsStore.get([e]);return T(t)?[]:Array.isArray(t)?t.map((e=>Bt.fromJSONObject(e))):(s("core.Metric.EventsDatabase",`Unexpected value found for ping ${e}: ${JSON.stringify(t)}. Clearing.`,r.Error),yield this.eventsStore.delete([e]),[])}))}getPingEvents(e,t){return n(this,void 0,void 0,(function*(){const i=yield this.getAndValidatePingData(e);if(t&&Object.keys(i).length>0&&(yield this.eventsStore.delete([e])),0===i.length)return;const n=yield this.prepareEventsPayload(e,i);return n.length>0?n:void 0}))}prepareEventsPayload(e,t){var r,s,a,o;return n(this,void 0,void 0,(function*(){const n=t.sort(((e,t)=>{var i,n;const r=Number(null===(i=e.extra)||void 0===i?void 0:i["#glean_execution_counter"]),s=Number(null===(n=t.extra)||void 0===n?void 0:n["#glean_execution_counter"]);return r!==s?r-s:e.timestamp-t.timestamp}));let c;try{c=Xt(null===(r=n[0].extra)||void 0===r?void 0:r["#glean_reference_time"]),n.shift()}catch(e){c=S.startTime}const d=(null===(s=n[0])||void 0===s?void 0:s.timestamp)||0;let l=0;for(const[t,r]of n.entries()){try{const s=Xt(null===(a=r.extra)||void 0===a?void 0:a["#glean_reference_time"]),o=s.getTime()-c.getTime();c=s;const d=l+o,u=n[t-1].timestamp;d<=u?(l=u+1,yield S.errorManager.record(Yt([e]),i.InvalidValue,`Invalid time offset between application sessions found for ping "${e}". Ignoring.`)):l=d}catch(e){}let s;s=1===Number((null===(o=r.extra)||void 0===o?void 0:o["#glean_execution_counter"])||1)?r.timestamp-d:r.timestamp+l,n[t]=new Bt(r.category,r.name,s,r.extra)}return n.map((e=>Bt.toJSONObject(e.payload())))}))}clearAll(){return n(this,void 0,void 0,(function*(){yield this.eventsStore.delete([])}))}};const ii={afterPingCollection:new class{constructor(e){this.name=e}get registeredPluginIdentifier(){var e;return null===(e=this.plugin)||void 0===e?void 0:e.name}registerPlugin(e){this.plugin?s("core.Events",[`Attempted to register plugin '${e.name}', which listens to the event '${e.event}'.`,`That event is already watched by plugin '${this.plugin.name}'`,`Plugin '${e.name}' will be ignored.`],r.Error):this.plugin=e}deregisterPlugin(){this.plugin=void 0}trigger(...e){if(this.plugin)return this.plugin.action(...e)}}("afterPingCollection")},ni=ii,ri="core.Pings.Maker";function si(e){return n(this,void 0,void 0,(function*(){const{startTimeMetric:t,startTime:i}=yield function(e){return n(this,void 0,void 0,(function*(){const t=new ve({category:"",name:`${e.name}#start`,sendInPings:[F],lifetime:"user",disabled:!1},ge.Minute),i=yield S.metricsDatabase.getMetric(F,t);let n;return n=i?new fe(i):fe.fromDate(S.startTime,ge.Minute),{startTimeMetric:t,startTime:n}}))}(e),r=new Date;yield ve._private_setUndispatched(t,r);const s=fe.fromDate(r,ge.Minute);return{startTime:i.payload(),endTime:s.payload()}}))}function ai(e,t){return n(this,void 0,void 0,(function*(){const i=yield function(e){return n(this,void 0,void 0,(function*(){const t=new ue({category:"",name:`${e.name}#sequence`,sendInPings:[F],lifetime:"user",disabled:!1}),i=yield S.metricsDatabase.getMetric(F,t);if(yield ue._private_addUndispatched(t,1),i)try{return new de(i).payload()}catch(t){s(ri,`Unexpected value found for sequence number in ping ${e.name}. Ignoring.`,r.Warn)}return 0}))}(e),{startTime:a,endTime:o}=yield si(e),c={seq:i,start_time:a,end_time:o};return t&&(c.reason=t),c}))}function oi(e,t){return n(this,void 0,void 0,(function*(){const i=yield S.eventsDatabase.getPingEvents(e.name,!0),a=yield S.metricsDatabase.getPingMetrics(e.name,!0);if(!a&&!i){if(!e.sendIfEmpty)return void s(ri,`Storage for ${e.name} empty. Bailing out.`,r.Info);s(ri,`Storage for ${e.name} empty. Ping will still be sent.`,r.Info)}const o=a?{metrics:a}:{},c=i?{events:i}:{},d=yield ai(e,t),l=yield function(e){return n(this,void 0,void 0,(function*(){let t=yield S.metricsDatabase.getPingMetrics(W,!0);t||(s(ri,"Empty client info data. Will submit anyways.",r.Warn),t={});let i={telemetry_sdk_build:q};for(const e in t)i=Object.assign(Object.assign({},i),t[e]);return e.includeClientId||delete i.client_id,i}))}(e);return Object.assign(Object.assign(Object.assign({},o),c),{ping_info:d,client_info:l})}))}const ci=function(e,t,i){return n(this,void 0,void 0,(function*(){const n=yield oi(t,i);if(!n)return;let a;try{a=yield ni.afterPingCollection.trigger(n)}catch(e){return void s(ri,[`Error while attempting to modify ping payload for the "${t.name}" ping using`,`the ${JSON.stringify(ni.afterPingCollection.registeredPluginIdentifier)} plugin.`,"Ping will not be submitted. See more logs below.\n\n",JSON.stringify(e)],r.Error)}S.debugOptions.logPings&&s(ri,JSON.stringify(n,null,2),r.Info);const o=a||n,c=function(){var e,t;const i={};if((null===(e=S.debugOptions)||void 0===e?void 0:e.debugViewTag)&&(i["X-Debug-ID"]=S.debugOptions.debugViewTag),(null===(t=S.debugOptions)||void 0===t?void 0:t.sourceTags)&&(i["X-Source-Tags"]=S.debugOptions.sourceTags.toString()),Object.keys(i).length>0)return i}();return S.pingsDatabase.recordPing(function(e,t){return`/submit/${S.applicationId}/${t.name}/1/${e}`}(e,t),e,o,c)}))},di="core.Pings.PingType";class li{constructor(e){var t;this.name=e.name,this.includeClientId=e.includeClientId,this.sendIfEmpty=e.sendIfEmpty,this.reasonCodes=null!==(t=e.reasonCodes)&&void 0!==t?t:[]}isDeletionRequest(){return this.name===B}submit(e){this.testCallback?this.testCallback(e).then((()=>{li._private_internalSubmit(this,e,this.resolveTestPromiseFunction)})).catch((t=>{s(di,[`There was an error validating "${this.name}" (${null!=e?e:"no reason"}):`,t],r.Error),li._private_internalSubmit(this,e,this.rejectTestPromiseFunction)})):li._private_internalSubmit(this,e)}static _private_submitUndispatched(e,t,i){return n(this,void 0,void 0,(function*(){if(!S.initialized)return void s(di,"Glean must be initialized before submitting pings.",r.Info);if(!S.uploadEnabled&&!e.isDeletionRequest())return void s(di,"Glean disabled: not submitting pings. Glean may still submit the deletion-request ping.",r.Info);let n=t;t&&!e.reasonCodes.includes(t)&&(s(di,`Invalid reason code ${t} from ${this.name}. Ignoring.`,r.Warn),n=void 0);const a=U();yield ci(a,e,n),i&&(i(),e.resolveTestPromiseFunction=void 0,e.rejectTestPromiseFunction=void 0,e.testCallback=void 0)}))}static _private_internalSubmit(e,t,i){S.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){yield li._private_submitUndispatched(e,t,i)}))))}testBeforeNextSubmit(e){return n(this,void 0,void 0,(function*(){if(!this.testCallback)return new Promise(((t,i)=>{this.resolveTestPromiseFunction=t,this.rejectTestPromiseFunction=i,this.testCallback=e}));s(di,`There is an existing test call for ping "${this.name}". Ignoring.`,r.Error)}))}}const ui=li;const hi=class{constructor(){this.deletionRequest=new ui({name:B,includeClientId:!0,sendIfEmpty:!0})}};function gi(e){const t=e.event;if(t in ni){ni[t].registerPlugin(e)}else s("core.Events.Utils",[`Attempted to register plugin '${e.name}', which listens to the event '${e.event}'.`,"That is not a valid Glean event. Ignoring"],r.Error)}function fi(e,t){const i=function(e){return e.split("/")[0]}(e.baseIdentifier());return new ue({name:ne(t,i),category:"glean.error",lifetime:"ping",sendInPings:e.sendInPings,disabled:!1})}class pi{record(e,t,i,r=1){return n(this,void 0,void 0,(function*(){const n=fi(e,t);s(function(e){return`core.Metrics.${e.type.charAt(0).toUpperCase()+e.type.slice(1)}`}(e),`${e.baseIdentifier()}: ${i}`),r>0&&(yield ue._private_addUndispatched(n,r))}))}testGetNumRecordedErrors(e,t,i){return n(this,void 0,void 0,(function*(){const n=fi(e,t);return(yield n.testGetValue(i))||0}))}}let vi={};const mi=class{constructor(e){this.rootKey=e}get(e=[]){try{const t=j(vi,[this.rootKey,...e]);return Promise.resolve(t)}catch(e){return Promise.reject(e)}}update(e,t){try{return vi=V(vi,[this.rootKey,...e],t),Promise.resolve()}catch(e){return Promise.reject(e)}}delete(e){try{vi=function(e,t){if(0===t.length)return{};const i=Object.assign({},e);let n=i;for(const e of t.slice(0,t.length-1)){const i=n[e];if(!I(i))throw Error(`Attempted to delete an entry from an inexistent index: ${JSON.stringify(t)}.`);n=i}return delete n[t[t.length-1]],i}(vi,[this.rootKey,...e])}catch(e){s("plaftom.test.Storage",[e.message,"Ignoring."],r.Warn)}return Promise.resolve()}};const yi={os:()=>Promise.resolve("Unknown"),osVersion:()=>Promise.resolve("Unknown"),arch:()=>Promise.resolve("Unknown"),locale:()=>Promise.resolve("Unknown")},bi={Storage:mi,uploader:new class extends c{post(e,t,i){const n=new o(2,200);return Promise.resolve(n)}},info:yi,name:"test"},wi="core.Glean";class _i{constructor(){if(!T(_i._instance))throw new Error("Tried to instantiate Glean through `new`.\n      Use Glean.instance instead to access the Glean singleton.");this._coreMetrics=new Jt,this._corePings=new hi}static get instance(){return _i._instance||(_i._instance=new _i),_i._instance}static get pingUploader(){return _i.instance._pingUploader}static get coreMetrics(){return _i.instance._coreMetrics}static get corePings(){return _i.instance._corePings}static onUploadEnabled(){return n(this,void 0,void 0,(function*(){S.uploadEnabled=!0,yield _i.coreMetrics.initialize(_i.instance._config,_i.platform)}))}static onUploadDisabled(){return n(this,void 0,void 0,(function*(){S.uploadEnabled=!1,yield ui._private_submitUndispatched(_i.corePings.deletionRequest),yield _i.clearMetrics()}))}static clearMetrics(){return n(this,void 0,void 0,(function*(){let e;yield _i.pingUploader.clearPendingPingsQueue();try{e=new fe(yield S.metricsDatabase.getMetric(W,_i.coreMetrics.firstRunDate)).date}catch(t){e=new Date}yield S.eventsDatabase.clearAll(),yield S.metricsDatabase.clearAll(),yield S.pingsDatabase.clearAll(),S.uploadEnabled=!0,yield Ve._private_setUndispatched(_i.coreMetrics.clientId,J),yield ve._private_setUndispatched(_i.coreMetrics.firstRunDate,e),S.uploadEnabled=!1}))}static initialize(e,t,i){if(S.initialized)return void s(wi,"Attempted to initialize Glean, but it has already been initialized. Ignoring.",r.Warn);if(0===e.length)return void s(wi,"Unable to initialize Glean, applicationId cannot be an empty string.",r.Error);if(!_i.instance._platform)return void s(wi,"Unable to initialize Glean, environment has not been set.",r.Error);S.applicationId=function(e){return e.replace(/[^a-z0-9]+/gi,"-").toLowerCase()}(e);const a=new Z(i);if(S.debugOptions=a.debug,_i.instance._config=a,S.metricsDatabase=new Fe(_i.platform.Storage),S.eventsDatabase=new ti(_i.platform.Storage),S.pingsDatabase=new jt(_i.platform.Storage),S.errorManager=new pi,_i.instance._pingUploader=new Wt(a,_i.platform,S.pingsDatabase),S.pingsDatabase.attachObserver(_i.pingUploader),null==i?void 0:i.plugins)for(const e of i.plugins)gi(e);S.dispatcher.flushInit((()=>n(this,void 0,void 0,(function*(){if(S.initialized=!0,yield S.metricsDatabase.clear("application"),t)yield _i.onUploadEnabled();else{const e=yield S.metricsDatabase.getMetric(W,_i.coreMetrics.clientId);e?e!==J&&(yield _i.onUploadDisabled()):yield _i.clearMetrics()}yield S.eventsDatabase.initialize(),yield S.pingsDatabase.scanPendingPings()}))))}static get serverEndpoint(){var e;return null===(e=_i.instance._config)||void 0===e?void 0:e.serverEndpoint}static get logPings(){var e,t;return(null===(t=null===(e=_i.instance._config)||void 0===e?void 0:e.debug)||void 0===t?void 0:t.logPings)||!1}static get debugViewTag(){var e;return null===(e=_i.instance._config)||void 0===e?void 0:e.debug.debugViewTag}static get sourceTags(){var e,t;return null===(t=null===(e=_i.instance._config)||void 0===e?void 0:e.debug.sourceTags)||void 0===t?void 0:t.toString()}static get platform(){if(!_i.instance._platform)throw new Error("IMPOSSIBLE: Attempted to access environment specific APIs before Glean was initialized.");return _i.instance._platform}static setUploadEnabled(e){S.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){S.initialized?S.uploadEnabled!==e&&(e?yield _i.onUploadEnabled():yield _i.onUploadDisabled()):s(wi,["Changing upload enabled before Glean is initialized is not supported.\n","Pass the correct state into `Glean.initialize\n`.","See documentation at https://mozilla.github.io/glean/book/user/general-api.html#initializing-the-glean-sdk`"],r.Error)}))))}static setLogPings(e){S.dispatcher.launch((()=>(_i.instance._config.debug.logPings=e,Promise.resolve())))}static setDebugViewTag(e){Z.validateDebugViewTag(e)?S.dispatcher.launch((()=>(_i.instance._config.debug.debugViewTag=e,Promise.resolve()))):s(wi,`Invalid \`debugViewTag\` ${e}. Ignoring.`,r.Error)}static setSourceTags(e){Z.validateSourceTags(e)?S.dispatcher.launch((()=>(_i.instance._config.debug.sourceTags=e,Promise.resolve()))):s(wi,`Invalid \`sourceTags\` ${e.toString()}. Ignoring.`,r.Error)}static shutdown(){return n(this,void 0,void 0,(function*(){yield S.dispatcher.shutdown(),yield _i.pingUploader.shutdown()}))}static setPlatform(e){S.initialized||(_i.instance._platform&&_i.instance._platform.name!==e.name&&s(wi,`Changing Glean platform from "${_i.platform.name}" to "${e.name}".`),_i.instance._platform=e)}static testInitialize(e,t=!0,i){return n(this,void 0,void 0,(function*(){_i.setPlatform(bi),_i.initialize(e,t,i),yield S.dispatcher.testBlockOnQueue()}))}static testUninitialize(e=!0){return n(this,void 0,void 0,(function*(){S.initialized&&(yield _i.shutdown(),e&&(yield S.eventsDatabase.clearAll(),yield S.metricsDatabase.clearAll(),yield S.pingsDatabase.clearAll()),S.testUninitialize(),function(){for(const e in ni)ni[e].deregisterPlugin()}())}))}static testResetGlean(e,t=!0,i,r=!0){return n(this,void 0,void 0,(function*(){yield _i.testUninitialize(r),yield _i.testInitialize(e,t,i)}))}}const Si=_i,xi=Object.assign(Object.assign({},(Ii=G,{initialize(e,t,i){Si.setPlatform(Ii),Si.initialize(e,t,i)},setUploadEnabled(e){Si.setUploadEnabled(e)},setLogPings(e){Si.setLogPings(e)},setDebugViewTag(e){Si.setDebugViewTag(e)},shutdown:()=>Si.shutdown(),setSourceTags(e){Si.setSourceTags(e)},testResetGlean(e,t=!0,i){return n(this,void 0,void 0,(function*(){return Si.testResetGlean(e,t,i)}))}})),{ErrorType:i,_private:{PingType:ui,BooleanMetricType:ce,CounterMetricType:ue,DatetimeMetricType:ve,EventMetricType:Kt,LabeledMetricType:se,QuantityMetricType:be,StringMetricType:Se,StringListMetricType:Te,TimespanMetricType:Ue,TextMetricType:Pe,UUIDMetricType:Ve,URLMetricType:Ae}});var Ii})(),Glean=t})();