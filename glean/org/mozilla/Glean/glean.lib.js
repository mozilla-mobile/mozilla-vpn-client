var Glean;(()=>{var e={d:(t,i)=>{for(var n in i)e.o(i,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:i[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};(()=>{var i;e.r(t),e.d(t,{default:()=>ki}),function(e){e.InvalidValue="invalid_value",e.InvalidLabel="invalid_label",e.InvalidState="invalid_state",e.InvalidOverflow="invalid_overflow"}(i||(i={}));function n(e,t,i,n){return new(i||(i=Promise))((function(r,s){function a(e){try{c(n.next(e))}catch(e){s(e)}}function o(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}c((n=n.apply(e,t||[])).next())}))}Object.create;var r;Object.create;function s(e,t,i=r.Debug){const n=`(Glean.${e})`;Array.isArray(t)?console[i](n,...t):console[i](n,t)}!function(e){e.Debug="debug",e.Info="info",e.Warn="warn",e.Error="error",e.Trace="trace"}(r||(r={}));var a;!function(e){e[e.RecoverableFailure=0]="RecoverableFailure",e[e.UnrecoverableFailure=1]="UnrecoverableFailure",e[e.Success=2]="Success"}(a||(a={}));class o{constructor(e,t){this.result=e,this.status=t}}const c=class{};var d,l=new Uint8Array(16);function u(){if(!d&&!(d="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return d(l)}const h=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;const g=function(e){return"string"==typeof e&&h.test(e)};for(var f=[],p=0;p<256;++p)f.push((p+256).toString(16).substr(1));const v=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=(f[e[t+0]]+f[e[t+1]]+f[e[t+2]]+f[e[t+3]]+"-"+f[e[t+4]]+f[e[t+5]]+"-"+f[e[t+6]]+f[e[t+7]]+"-"+f[e[t+8]]+f[e[t+9]]+"-"+f[e[t+10]]+f[e[t+11]]+f[e[t+12]]+f[e[t+13]]+f[e[t+14]]+f[e[t+15]]).toLowerCase();if(!g(i))throw TypeError("Stringified UUID is invalid");return i};const m=function(e,t,i){var n=(e=e||{}).random||(e.rng||u)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){i=i||0;for(var r=0;r<16;++r)t[i+r]=n[r];return t}return v(n)};var y,b;!function(e){e.Uninitialized="Uninitialized",e.Idle="Idle",e.Processing="Processing",e.Stopped="Stopped",e.Shutdown="Shutdown"}(y||(y={})),function(e){e.Task="Task",e.PersistentTask="PersistentTask",e.InitTask="InitTask",e.Stop="Stop",e.Clear="Clear",e.Shutdown="Shutdown",e.TestTask="TestTask"}(b||(b={}));const w=class{constructor(e=100,t="core.Dispatcher"){this.maxPreInitQueueSize=e,this.logTag=t,this.shuttingDown=!1,this.currentJob=Promise.resolve(),this.queue=[],this.state="Uninitialized"}getNextCommand(){return this.queue.shift()}executeTask(e){return n(this,void 0,void 0,(function*(){try{return yield e(),!0}catch(e){return s(this.logTag,"Error executing Glean task"+(e?`: ${e}`:". There might be more error logs above."),r.Error),!1}}))}unblockTestResolvers(){this.queue.forEach((e=>{"TestTask"===e.command&&e.resolver()}))}execute(){return n(this,void 0,void 0,(function*(){let e=this.getNextCommand();for(;e;){switch(e.command){case"Stop":return void(this.state="Stopped");case"Shutdown":return this.unblockTestResolvers(),this.queue=[],this.state="Shutdown",void(this.shuttingDown=!1);case"Clear":this.unblockTestResolvers(),this.queue=this.queue.filter((e=>["PersistentTask","Shutdown"].includes(e.command)));break;case"TestTask":yield this.executeTask(e.task),e.resolver();break;case"InitTask":(yield this.executeTask(e.task))||(s(this.logTag,["Error initializing dispatcher, won't execute anything further.","There might be more error logs above."],r.Error),this.clear(),this.shutdown());break;case"PersistentTask":case"Task":yield this.executeTask(e.task)}e=this.getNextCommand()}}))}triggerExecution(){"Idle"===this.state&&this.queue.length>0&&(this.state="Processing",this.currentJob=this.execute(),this.currentJob.then((()=>{const e=this;"Processing"===this.state&&(e.state="Idle")})).catch((e=>{s(this.logTag,["IMPOSSIBLE: Something went wrong while the dispatcher was executing the tasks queue.",e],r.Error)})))}launchInternal(e,t=!1){return"Shutdown"===this.state?(s(this.logTag,"Attempted to enqueue a new task but the dispatcher is shutdown. Ignoring.",r.Warn),!1):!t&&"Uninitialized"===this.state&&this.queue.length>=this.maxPreInitQueueSize?(s(this.logTag,"Unable to enqueue task, pre init queue is full.",r.Warn),!1):(t?this.queue.unshift(e):this.queue.push(e),this.triggerExecution(),!0)}launch(e){this.launchInternal({task:e,command:"Task"})}launchPersistent(e){this.launchInternal({task:e,command:"PersistentTask"})}flushInit(e){"Uninitialized"===this.state?(e&&this.launchInternal({task:e,command:"InitTask"},!0),this.state="Idle",this.triggerExecution()):s(this.logTag,"Attempted to initialize the Dispatcher, but it is already initialized. Ignoring.",r.Warn)}clear(e=!0){this.launchInternal({command:"Clear"},e),this.resume()}stop(e=!0){this.shuttingDown?this.clear(e):this.launchInternal({command:"Stop"},e)}resume(){"Stopped"===this.state&&(this.state="Idle",this.triggerExecution())}shutdown(){return this.shuttingDown=!0,this.launchInternal({command:"Shutdown"}),this.resume(),this.currentJob}testBlockOnQueue(){return n(this,void 0,void 0,(function*(){return yield this.currentJob}))}testUninitialize(){return n(this,void 0,void 0,(function*(){"Uninitialized"!==this.state&&(this.clear(),yield this.shutdown(),this.state="Uninitialized")}))}testLaunch(e){return new Promise(((t,i)=>{this.resume();this.launchInternal({resolver:t,task:e,command:"TestTask"})||i()}))}},_="core.Context";class T{constructor(){this._initialized=!1,this._testing=!1,this._startTime=new Date,this._dispatcher=new w}static get instance(){return T._instance||(T._instance=new T),T._instance}static testUninitialize(){T._instance=void 0}static get dispatcher(){return T.instance._dispatcher}static get uploadEnabled(){return void 0===T.instance._uploadEnabled&&s(_,["Attempted to access Context.uploadEnabled before it was set. This may cause unexpected behaviour."],r.Trace),T.instance._uploadEnabled}static set uploadEnabled(e){T.instance._uploadEnabled=e}static get metricsDatabase(){return void 0===T.instance._metricsDatabase&&s(_,["Attempted to access Context.metricsDatabase before it was set. This may cause unexpected behaviour."],r.Trace),T.instance._metricsDatabase}static set metricsDatabase(e){T.instance._metricsDatabase=e}static get eventsDatabase(){return void 0===T.instance._eventsDatabase&&s(_,["Attempted to access Context.eventsDatabase before it was set. This may cause unexpected behaviour."],r.Trace),T.instance._eventsDatabase}static set eventsDatabase(e){T.instance._eventsDatabase=e}static get pingsDatabase(){return void 0===T.instance._pingsDatabase&&s(_,["Attempted to access Context.pingsDatabase before it was set. This may cause unexpected behaviour."],r.Trace),T.instance._pingsDatabase}static set pingsDatabase(e){T.instance._pingsDatabase=e}static get errorManager(){return void 0===T.instance._errorManager&&s(_,["Attempted to access Context.errorManager before it was set. This may cause unexpected behaviour."],r.Trace),T.instance._errorManager}static set errorManager(e){T.instance._errorManager=e}static get applicationId(){return void 0===T.instance._applicationId&&s(_,["Attempted to access Context.applicationId before it was set. This may cause unexpected behaviour."],r.Trace),T.instance._applicationId}static set applicationId(e){T.instance._applicationId=e}static get initialized(){return T.instance._initialized}static set initialized(e){T.instance._initialized=e}static get config(){return void 0===T.instance._config&&s(_,["Attempted to access Context.config before it was set. This may cause unexpected behaviour."],r.Trace),T.instance._config}static set config(e){T.instance._config=e}static get startTime(){return T.instance._startTime}static get testing(){return T.instance._testing}static set testing(e){T.instance._testing=e}static set platform(e){T.instance._platform=e}static get platform(){return void 0===T.instance._platform&&s(_,["Attempted to access Context.platform before it was set. This may cause unexpected behaviour."],r.Trace),T.instance._platform}static isPlatformSet(){return!!T.instance._platform}}function I(e){if(E(e)||P(e)||D(e))return!0;if(S(e)){if(0===Object.keys(e).length)return!0;for(const t in e)return I(e[t])}return!!Array.isArray(e)&&e.every((e=>I(e)))}function S(e){return"object"==typeof e&&null!==e&&e.constructor===Object}function x(e){return void 0===e}function E(e){return"string"==typeof e}function P(e){return"boolean"==typeof e}function D(e){return"number"==typeof e&&!isNaN(e)}function M(e){return D(e)&&Number.isInteger(e)}function $(e){return/^[a-z0-9-]{1,20}$/i.test(e)}function U(){return"undefined"!=typeof crypto?m():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}const O=Date.now();function k(){const e="undefined"==typeof performance?Date.now()-O:performance.now();return Math.round(e)}function A(e,t,r){return n(this,void 0,void 0,(function*(){const n=t.substr(0,r);return n!==t&&(yield T.errorManager.record(e,i.InvalidOverflow,`Value length ${t.length} exceeds maximum of ${r}.`)),n}))}function R(e,t="core.utils"){return!!T.testing||(s(t,[`Attempted to access test only method \`${e||"unknown"}\`,`,"but Glean is not in testing mode. Ignoring. Make sure to put Glean in testing mode","before accessing such methods, by calling `Glean.testResetGlean`."],r.Error),!1)}const z="platform.qt.Uploader";const V=new class extends c{post(e,t,i={}){return n(this,void 0,void 0,(function*(){return new Promise((n=>{const a=new XMLHttpRequest;a.timeout=1e4,a.open("POST",e);for(const e in i)a.setRequestHeader(e,i[e]);a.ontimeout=function(e){s(z,["Timeout while attempting to upload ping.\n",e.type],r.Error),n(new o(0))},a.onerror=function(e){s(z,["Network error while attempting to upload ping.\n",e.type],r.Error),n(new o(0))},a.onabort=function(e){s(z,["The attempt to upload ping is aborted.\n",e.type],r.Error),n(new o(0))},a.onload=()=>{n(new o(2,a.status))},E(t)?a.send(t):a.send(t.buffer)}))}))}},C={os(){return n(this,void 0,void 0,(function*(){switch(Qt.platform.os){case"android":return"Android";case"ios":return"iOS";case"tvos":return"TvOS";case"linux":return"Linux";case"osx":return"Darwin";case"qnx":return"QNX";case"windows":case"winrt":return"Windows";case"wasm":return"Wasm";default:return"Unknown"}}))},osVersion(e){return n(this,void 0,void 0,(function*(){return Promise.resolve(e||"Unknown")}))},arch(e){return n(this,void 0,void 0,(function*(){return Promise.resolve(e||"Unknown")}))},locale(){return n(this,void 0,void 0,(function*(){const e=Qt.locale();return Promise.resolve(e?e.name.replace("_","-"):"und")}))}};function G(e,t){if(0===t.length)throw Error("The index must contain at least one property to get.");let i=e;for(const e of t){if(!S(i)||!(e in i))return;{const t=i[e];I(t)&&(i=t)}}return i}function N(e,t,i){if(0===t.length)throw Error("The index must contain at least one property to update.");const n=Object.assign({},e);let a=n;for(const e of t.slice(0,t.length-1))S(a[e])||(a[e]={}),a=a[e];const o=t[t.length-1],c=a[o];try{const e=i(c);return a[o]=e,n}catch(e){return s("core.Storage.Utils",["Error while transforming stored value. Ignoring old value.",e],r.Error),a[o]=i(void 0),n}}function j(e,t="",i=[]){if(S(e)){const n=Object.keys(e);for(const r of n){const n=e[r];x(n)||j(n,`${t}${r}+`,i)}}else i.push([t.slice(0,-1),JSON.stringify(e)]);return i}function L(e){if(!e||0===e.rows.length)return;const t={};for(let i=0;i<e.rows.length;i++){const n=e.rows.item(i),r=n.key.split("+");let s=t;for(const e of r.slice(0,-1))x(s[e])&&(s[e]={}),s=s[e];try{s[r[r.length-1]]=JSON.parse(n.value)}catch(e){s[r[r.length-1]]=n.value}}return t}const q={Storage:class{constructor(e,t="Glean"){this.tableName=e,this.name=t;const i=`platform.qt.Storage.${e}`;this.initialized=this._executeQuery(`CREATE TABLE IF NOT EXISTS ${e}(key VARCHAR(255), value VARCHAR(255));`,i),this.logTag=i}_createKeyFromIndex(e){return e.join("+")}_dbHandle(e){try{const e=LocalStorage.LocalStorage.openDatabaseSync(this.name,"1.0",`${this.name} Storage`,3e5);this.dbHandle=e}catch(t){s(e||this.logTag,["Error while attempting to access LocalStorage.\n",t],r.Debug)}finally{return this.dbHandle}}_executeQuery(e,t){const i=this._dbHandle(t);return i?new Promise(((n,a)=>{try{i.transaction((t=>{const i=t.executeSql(e);n(i)}))}catch(i){s(t||this.logTag,[`Error executing LocalStorage query: ${e}.\n`,i],r.Debug),a()}})):Promise.reject()}_executeOnceInitialized(e){return n(this,void 0,void 0,(function*(){return yield this.initialized,this._executeQuery(e)}))}_getFullResultObject(e){return n(this,void 0,void 0,(function*(){const t=this._createKeyFromIndex(e);return L(yield this._executeOnceInitialized(`SELECT * FROM ${this.tableName} WHERE key LIKE "${t}%"`))}))}_getWholeStore(){return n(this,void 0,void 0,(function*(){return L(yield this._executeOnceInitialized(`SELECT * FROM ${this.tableName}`))}))}get(e=[]){return n(this,void 0,void 0,(function*(){if(0===e.length)return this._getWholeStore();const t=(yield this._getFullResultObject(e))||{};try{return G(t,e)}catch(e){s(this.logTag,["Error getting value from database.",e])}}))}update(e,t){return n(this,void 0,void 0,(function*(){const i=j(N((yield this._getFullResultObject(e))||{},e,t));for(const e of i){const[t,i]=e,n=i.replace("'","''"),r=yield this._executeOnceInitialized(`UPDATE ${this.tableName} SET value='${n}' WHERE key='${t}'`);(null==r?void 0:r.rows.length)||(yield this._executeOnceInitialized(`INSERT INTO ${this.tableName}(key, value) VALUES('${t}', '${n}');`))}}))}delete(e){return n(this,void 0,void 0,(function*(){const t=this._createKeyFromIndex(e);yield this._executeOnceInitialized(`DELETE FROM ${this.tableName} WHERE key LIKE "${t}%"`)}))}},uploader:V,info:C,timer:{setTimeout:()=>{throw new Error},clearTimeout:()=>{}},name:"Qt"},F="0.30.0",W="glean_ping_info",B="glean_client_info",J="c0ffeec0-ffee-c0ff-eec0-ffeec0ffeec0",H="deletion-request",X="#glean_reference_time",Q="#glean_execution_counter",K=[Q,X],Z="core.Config";class Y{constructor(e){var t,i;if(this.channel=null==e?void 0:e.channel,this.appBuild=null==e?void 0:e.appBuild,this.appDisplayVersion=null==e?void 0:e.appDisplayVersion,this.architecture=null==e?void 0:e.architecture,this.osVersion=null==e?void 0:e.osVersion,this.debug={},(null==e?void 0:e.serverEndpoint)&&(i=e.serverEndpoint,!/^(http|https):\/\/[a-zA-Z0-9._-]+(:\d+){0,1}(\/{0,1})$/i.test(i)))throw new Error(`Unable to initialize Glean, serverEndpoint ${e.serverEndpoint} is an invalid URL.`);if(!T.testing&&(null===(t=null==e?void 0:e.serverEndpoint)||void 0===t?void 0:t.startsWith("http:")))throw new Error(`Unable to initialize Glean, serverEndpoint ${e.serverEndpoint} must use the HTTPS protocol.`);this.serverEndpoint=e&&e.serverEndpoint?e.serverEndpoint:"https://incoming.telemetry.mozilla.org",this.httpClient=null==e?void 0:e.httpClient}get logPings(){return this.debug.logPings||!1}set logPings(e){this.debug.logPings=e}get debugViewTag(){return this.debug.debugViewTag}set debugViewTag(e){$(e||"")?this.debug.debugViewTag=e:s(Z,[`"${e||""}" is not a valid \`debugViewTag\` value.`,"Please make sure the value passed satisfies the regex `^[a-zA-Z0-9-]{1,20}$`."],r.Error)}get sourceTags(){return this.debug.sourceTags}set sourceTags(e){if(!e||e.length<1||e.length>5)s(Z,"A list of tags cannot contain more than 5 elements or less than one.",r.Error);else{for(const t of e){if(t.startsWith("glean"))return void s(Z,"Tags starting with `glean` are reserved and must not be used.",r.Error);if(!$(t))return}this.debug.sourceTags=e}}}class ee{constructor(e){if(!this.validate(e))throw new Error("Unable to create new Metric instance, value is in unexpected format.");this._inner=e}get(){return this._inner}set(e){this.validate(e)?this._inner=e:s("core.Metrics.Metric",`Unable to set metric to ${JSON.stringify(e)}. Value is in unexpected format. Ignoring.`,r.Error)}}class te extends ee{constructor(e){super(e)}validate(e){return!0}payload(){return this._inner}}const ie="__other__",ne=/^[a-z_][a-z0-9_-]{0,29}(\.[a-z_][a-z0-9_-]{0,29})*$/;function re(e,t){return`${e}/${t}`}class se{constructor(e,t,i){return new Proxy(this,{get:(n,r)=>i?se.createFromStaticLabel(e,t,i,r):se.createFromDynamicLabel(e,t,r)})}static createFromStaticLabel(e,t,i,n){const r=i.includes(n)?n:ie;return new t(Object.assign(Object.assign({},e),{name:re(e.name,r)}))}static createFromDynamicLabel(e,t,i){return new t(Object.assign(Object.assign({},e),{dynamicLabel:i}))}}const ae=se;class oe{constructor(e,t){this.type=e,this.name=t.name,this.category=t.category,this.sendInPings=t.sendInPings,this.lifetime=t.lifetime,this.disabled=t.disabled,this.dynamicLabel=t.dynamicLabel}baseIdentifier(){return this.category.length>0?`${this.category}.${this.name}`:this.name}identifier(){return n(this,void 0,void 0,(function*(){const e=this.baseIdentifier();return x(this.dynamicLabel)?e:yield function(e){return n(this,void 0,void 0,(function*(){if(void 0===e.dynamicLabel)throw new Error("This point should never be reached.");const t=re(e.baseIdentifier(),e.dynamicLabel);for(const i of e.sendInPings)if(yield T.metricsDatabase.hasMetric(e.lifetime,i,e.type,t))return t;let n=0;for(const t of e.sendInPings)n+=(yield T.metricsDatabase.countByBaseIdentifier(e.lifetime,t,e.type,e.baseIdentifier()));let r=!1;return n>=16?r=!0:e.dynamicLabel.length>61?(r=!0,yield T.errorManager.record(e,i.InvalidLabel,`Label length ${e.dynamicLabel.length} exceeds maximum of 61.`)):ne.test(e.dynamicLabel)||(r=!0,yield T.errorManager.record(e,i.InvalidLabel,`Label must be snake_case, got '${e.dynamicLabel}'.`)),r?re(e.baseIdentifier(),ie):t}))}(this)}))}shouldRecord(e){return e&&!this.disabled}testGetNumRecordedErrors(e,t=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){return R("testGetNumRecordedErrors")?T.errorManager.testGetNumRecordedErrors(this,e,t):0}))}}class ce extends ee{constructor(e){super(e)}validate(e){return P(e)}payload(){return this._inner}}const de=class extends oe{constructor(e){super("boolean",e)}set(e){T.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(!this.shouldRecord(T.uploadEnabled))return;const t=new ce(e);yield T.metricsDatabase.record(this,t)}))))}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){if(R("testGetValue","core.metrics.BooleanMetricType")){let t;return yield T.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield T.metricsDatabase.getMetric(e,this)})))),t}}))}};class le extends ee{constructor(e){super(e)}validate(e){return!!M(e)&&!(e<=0)}payload(){return this._inner}}class ue extends oe{constructor(e){super("counter",e)}static _private_addUndispatched(e,t){return n(this,void 0,void 0,(function*(){if(!e.shouldRecord(T.uploadEnabled))return;if(x(t)&&(t=1),t<=0)return void(yield T.errorManager.record(e,i.InvalidValue,`Added negative and zero value ${t}`));const n=(e=>t=>{let i,n;try{i=new le(t),n=i.get()+e}catch(t){i=new le(e),n=e}return n>Number.MAX_SAFE_INTEGER&&(n=Number.MAX_SAFE_INTEGER),i.set(n),i})(t);yield T.metricsDatabase.transform(e,n)}))}add(e){T.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){return ue._private_addUndispatched(this,e)}))))}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){if(R("testGetValue","core.metrics.CounterMetricType")){let t;return yield T.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield T.metricsDatabase.getMetric(e,this)})))),t}}))}}const he=ue;var ge;!function(e){e.Nanosecond="nanosecond",e.Microsecond="microsecond",e.Millisecond="millisecond",e.Second="second",e.Minute="minute",e.Hour="hour",e.Day="day"}(ge||(ge={}));const fe=ge;class pe extends ee{constructor(e){super(e)}static fromDate(e,t){return new pe({timeUnit:t,timezone:e.getTimezoneOffset(),date:e.toISOString()})}get date(){return new Date(this._inner.date)}get timezone(){return this._inner.timezone}get timeUnit(){return this._inner.timeUnit}get dateISOString(){return this._inner.date}validate(e){if(!S(e)||3!==Object.keys(e).length)return!1;const t="timeUnit"in e&&E(e.timeUnit)&&Object.values(fe).includes(e.timeUnit),i="timezone"in e&&D(e.timezone),n="date"in e&&E(e.date)&&24===e.date.length&&!isNaN(Date.parse(e.date));return!!(t&&i&&n)}payload(){const e=this.dateISOString.match(/\d+/g);if(!e||e.length<0)throw new Error("IMPOSSIBLE: Unable to extract date information from DatetimeMetric.");const t=new Date(parseInt(e[0]),parseInt(e[1])-1,parseInt(e[2]),parseInt(e[3])-this.timezone/60,parseInt(e[4]),parseInt(e[5]),parseInt(e[6])),i=function(e){const t=e/60*-1;return`${t>0?"+":"-"}${Math.abs(t).toString().padStart(2,"0")}:00`}(this.timezone),n=t.getFullYear().toString().padStart(2,"0"),r=(t.getMonth()+1).toString().padStart(2,"0"),s=t.getDate().toString().padStart(2,"0");if(this.timeUnit===fe.Day)return`${n}-${r}-${s}${i}`;const a=t.getHours().toString().padStart(2,"0");if(this.timeUnit===fe.Hour)return`${n}-${r}-${s}T${a}${i}`;const o=t.getMinutes().toString().padStart(2,"0");if(this.timeUnit===fe.Minute)return`${n}-${r}-${s}T${a}:${o}${i}`;const c=t.getSeconds().toString().padStart(2,"0");if(this.timeUnit===fe.Second)return`${n}-${r}-${s}T${a}:${o}:${c}${i}`;const d=t.getMilliseconds().toString().padStart(3,"0");return this.timeUnit===fe.Millisecond?`${n}-${r}-${s}T${a}:${o}:${c}.${d}${i}`:this.timeUnit===fe.Microsecond?`${n}-${r}-${s}T${a}:${o}:${c}.${d}000${i}`:`${n}-${r}-${s}T${a}:${o}:${c}.${d}000000${i}`}}class ve extends oe{constructor(e,t){super("datetime",e),this.timeUnit=t}static _private_setUndispatched(e,t){return n(this,void 0,void 0,(function*(){if(!e.shouldRecord(T.uploadEnabled))return;t||(t=new Date);const i=t;switch(e.timeUnit){case fe.Day:i.setMilliseconds(0),i.setSeconds(0),i.setMinutes(0),i.setMilliseconds(0);case fe.Hour:i.setMilliseconds(0),i.setSeconds(0),i.setMinutes(0);case fe.Minute:i.setMilliseconds(0),i.setSeconds(0);case fe.Second:i.setMilliseconds(0)}const n=pe.fromDate(t,e.timeUnit);yield T.metricsDatabase.record(e,n)}))}set(e){T.dispatcher.launch((()=>ve._private_setUndispatched(this,e)))}testGetValueAsDatetimeMetric(e,t){return n(this,void 0,void 0,(function*(){if(R(t,"core.metrics.DatetimeMetricType")){let t;if(yield T.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield T.metricsDatabase.getMetric(e,this)})))),t)return new pe(t)}}))}testGetValueAsString(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){const t=yield this.testGetValueAsDatetimeMetric(e,"testGetValueAsString");return t?t.payload():void 0}))}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){const t=yield this.testGetValueAsDatetimeMetric(e,"testGetValue");return t?t.date:void 0}))}}const me=ve;class ye extends ee{constructor(e){super(e)}validate(e){return!!M(e)&&!(e<0)}payload(){return this._inner}}class be extends oe{constructor(e){super("quantity",e)}static _private_setUndispatched(e,t){return n(this,void 0,void 0,(function*(){if(!e.shouldRecord(T.uploadEnabled))return;if(t<0)return void(yield T.errorManager.record(e,i.InvalidValue,`Set negative value ${t}`));t>Number.MAX_SAFE_INTEGER&&(t=Number.MAX_SAFE_INTEGER);const n=new ye(t);yield T.metricsDatabase.record(e,n)}))}set(e){T.dispatcher.launch((()=>be._private_setUndispatched(this,e)))}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){if(R("testGetValue","core.metrics.QuantityMetricType")){let t;return yield T.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield T.metricsDatabase.getMetric(e,this)})))),t}}))}}const we=be;class _e extends ee{constructor(e){super(e)}get numerator(){return this._inner.numerator}get denominator(){return this._inner.denominator}validate(e){if(!S(e)||2!==Object.keys(e).length)return!1;const t="numerator"in e&&D(e.numerator)&&e.numerator>=0,i="denominator"in e&&D(e.denominator)&&e.denominator>=0;return t&&i}payload(){return{numerator:this._inner.numerator,denominator:this._inner.denominator}}}const Te=class extends oe{constructor(e){super("rate",e)}addToNumerator(e){T.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(!this.shouldRecord(T.uploadEnabled))return;if(e<0)return void(yield T.errorManager.record(this,i.InvalidValue,`Added negative value ${e} to numerator.`));const t=(e=>t=>{let i,n;try{i=new _e(t),n=i.numerator+e}catch(t){i=new _e({numerator:e,denominator:0}),n=e}return n>Number.MAX_SAFE_INTEGER&&(n=Number.MAX_SAFE_INTEGER),i.set({numerator:n,denominator:i.denominator}),i})(e);yield T.metricsDatabase.transform(this,t)}))))}addToDenominator(e){T.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(!this.shouldRecord(T.uploadEnabled))return;if(e<0)return void(yield T.errorManager.record(this,i.InvalidValue,`Added negative value ${e} to denominator.`));const t=(e=>t=>{let i,n;try{i=new _e(t),n=i.denominator+e}catch(t){i=new _e({numerator:0,denominator:e}),n=e}return n>Number.MAX_SAFE_INTEGER&&(n=Number.MAX_SAFE_INTEGER),i.set({numerator:i.numerator,denominator:n}),i})(e);yield T.metricsDatabase.transform(this,t)}))))}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){if(R("testGetValue","core.metrics.RateMetricType")){let t;return yield T.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield T.metricsDatabase.getMetric(e,this)})))),t}}))}};class Ie extends ee{constructor(e){super(e)}validate(e){return!!E(e)&&!(e.length>100)}payload(){return this._inner}}class Se extends oe{constructor(e){super("string",e)}static _private_setUndispatched(e,t){return n(this,void 0,void 0,(function*(){if(!e.shouldRecord(T.uploadEnabled))return;const i=yield A(e,t,100),n=new Ie(i);yield T.metricsDatabase.record(e,n)}))}set(e){T.dispatcher.launch((()=>Se._private_setUndispatched(this,e)))}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){if(R("testGetValue","core.metrics.StringMetricType")){let t;return yield T.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield T.metricsDatabase.getMetric(e,this)})))),t}}))}}const xe=Se,Ee=20;class Pe extends ee{constructor(e){super(e)}validate(e){if(!Array.isArray(e))return!1;if(e.length>Ee)return!1;for(const t of e)if(!E(t)||t.length>50)return!1;return!0}payload(){return this._inner}}const De=class extends oe{constructor(e){super("string_list",e)}set(e){T.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(!this.shouldRecord(T.uploadEnabled))return;const t=[];e.length>Ee&&(yield T.errorManager.record(this,i.InvalidValue,`String list length of ${e.length} exceeds maximum of 20.`));for(let i=0;i<Math.min(e.length,Ee);++i){const n=yield A(this,e[i],50);t.push(n)}const n=new Pe(t);yield T.metricsDatabase.record(this,n)}))))}add(e){T.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(!this.shouldRecord(T.uploadEnabled))return;const t=yield A(this,e,50);let n=0;const r=(e=>t=>{let i,r;try{i=new Pe(t),r=i.get(),n=r.length,r.length<Ee&&r.push(e)}catch(t){i=new Pe([e]),r=[e]}return i.set(r),i})(t);yield T.metricsDatabase.transform(this,r),n>=Ee&&(yield T.errorManager.record(this,i.InvalidValue,`String list length of ${n+1} exceeds maximum of 20.`))}))))}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){if(R("testGetValue","core.metrics.StringListMetricType")){let t;return yield T.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield T.metricsDatabase.getMetric(e,this)})))),t}}))}},Me=204800;class $e extends ee{constructor(e){super(e)}validate(e){return!!E(e)&&!(e.length>Me)}payload(){return this._inner}}const Ue=class extends oe{constructor(e){super("text",e)}set(e){T.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(!this.shouldRecord(T.uploadEnabled))return;const t=yield A(this,e,Me),i=new $e(t);yield T.metricsDatabase.record(this,i)}))))}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){if(R("testGetValue","core.metrics.TextMetricType")){let t;return yield T.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield T.metricsDatabase.getMetric(e,this)})))),t}}))}};class Oe extends ee{constructor(e){super(e)}get timespan(){switch(this._inner.timeUnit){case fe.Nanosecond:return this._inner.timespan*10**6;case fe.Microsecond:return 1e3*this._inner.timespan;case fe.Millisecond:return this._inner.timespan;case fe.Second:return Math.round(this._inner.timespan/1e3);case fe.Minute:return Math.round(this._inner.timespan/1e3/60);case fe.Hour:return Math.round(this._inner.timespan/1e3/60/60);case fe.Day:return Math.round(this._inner.timespan/1e3/60/60/24)}}validate(e){if(!S(e)||2!==Object.keys(e).length)return!1;const t="timeUnit"in e&&E(e.timeUnit)&&Object.values(fe).includes(e.timeUnit),i="timespan"in e&&D(e.timespan)&&e.timespan>=0;return!(!t||!i)}payload(){return{time_unit:this._inner.timeUnit,value:this.timespan}}}class ke extends oe{constructor(e,t){super("timespan",e),this.timeUnit=t}static _private_setRawUndispatched(e,t){return n(this,void 0,void 0,(function*(){if(!e.shouldRecord(T.uploadEnabled))return;if(!x(e.startTime))return void(yield T.errorManager.record(e,i.InvalidState,"Timespan already running. Raw value not recorded."));let n=!1;const r=(t=>i=>{let r;try{r=new Oe(i),n=!0}catch(i){r=new Oe({timespan:t,timeUnit:e.timeUnit})}return r})(t);yield T.metricsDatabase.transform(e,r),n&&(yield T.errorManager.record(e,i.InvalidState,"Timespan value already recorded. New value discarded."))}))}start(){const e=k();T.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(this.shouldRecord(T.uploadEnabled)){if(x(this.startTime))return this.startTime=e,Promise.resolve();yield T.errorManager.record(this,i.InvalidState,"Timespan already started")}}))))}stop(){const e=k();T.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(!this.shouldRecord(T.uploadEnabled))return void(this.startTime=void 0);if(x(this.startTime))return void(yield T.errorManager.record(this,i.InvalidState,"Timespan not running."));const t=e-this.startTime;this.startTime=void 0,t<0?yield T.errorManager.record(this,i.InvalidState,"Timespan was negative."):yield ke._private_setRawUndispatched(this,t)}))))}cancel(){T.dispatcher.launch((()=>(this.startTime=void 0,Promise.resolve())))}setRawNanos(e){T.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){const t=e*10**-6;yield ke._private_setRawUndispatched(this,t)}))))}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){if(R("testGetValue","core.metrics.TimespanMetricType")){let t;if(yield T.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield T.metricsDatabase.getMetric(e,this)})))),t)return new Oe(t).timespan}}))}}const Ae=ke,Re=/^[a-zA-Z][a-zA-Z0-9-\+\.]*:(.*)$/;class ze extends Error{constructor(e,t){super(t),this.type=e,this.name="UrlMetricError"}}class Ve extends ee{constructor(e){super(e)}validate(e){if(!E(e))return!1;if(e.length>2048)throw new ze(i.InvalidOverflow,`URL length ${e.length} exceeds maximum of 2048.`);if(e.startsWith("data:"))throw new ze(i.InvalidValue,"URL metric does not support data URLs.");if(!Re.test(e))throw new ze(i.InvalidValue,`"${e}" does not start with a valid URL scheme.`);return!0}payload(){return this._inner}}const Ce=class extends oe{constructor(e){super("url",e)}set(e){T.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(this.shouldRecord(T.uploadEnabled))try{const t=new Ve(e);yield T.metricsDatabase.record(this,t)}catch(e){e instanceof ze&&(yield T.errorManager.record(this,e.type,e))}}))))}setUrl(e){this.set(e.toString())}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){if(R("testGetValue","core.metrics.URLMetricType")){let t;return yield T.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield T.metricsDatabase.getMetric(e,this)})))),t}}))}},Ge=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;class Ne extends ee{constructor(e){super(e)}validate(e){return!!E(e)&&Ge.test(e)}payload(){return this._inner}}class je extends oe{constructor(e){super("uuid",e)}static _private_setUndispatched(e,t){return n(this,void 0,void 0,(function*(){if(!e.shouldRecord(T.uploadEnabled))return;let n;t||(t=U());try{n=new Ne(t)}catch(n){return void(yield T.errorManager.record(e,i.InvalidValue,`"${t}" is not a valid UUID.`))}yield T.metricsDatabase.record(e,n)}))}set(e){T.dispatcher.launch((()=>je._private_setUndispatched(this,e)))}generateAndSet(){if(!this.shouldRecord(T.uploadEnabled))return;const e=U();return this.set(e),e}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){if(R("testGetValue","core.metrics.UUIDMetricType")){let t;return yield T.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield T.metricsDatabase.getMetric(e,this)})))),t}}))}}const Le=je,qe=Object.freeze({boolean:ce,counter:le,datetime:pe,labeled_boolean:te,labeled_counter:te,labeled_string:te,quantity:ye,rate:_e,string:Ie,string_list:Pe,text:$e,timespan:Oe,url:Ve,uuid:Ne});function Fe(e,t){if(!(e in qe))throw new Error(`Unable to create metric of unknown type ${e}`);return new qe[e](t)}function We(e,t){try{return Fe(e,t),!0}catch(e){return!1}}const Be="core.Metrics.Database";const Je=class{constructor(){this.userStore=new T.platform.Storage("userLifetimeMetrics"),this.pingStore=new T.platform.Storage("pingLifetimeMetrics"),this.appStore=new T.platform.Storage("appLifetimeMetrics")}_chooseStore(e){switch(e){case"user":return this.userStore;case"ping":return this.pingStore;case"application":return this.appStore}}record(e,t){return n(this,void 0,void 0,(function*(){yield this.transform(e,(()=>t))}))}transform(e,t){return n(this,void 0,void 0,(function*(){if(e.disabled)return;const i=this._chooseStore(e.lifetime),n=yield e.identifier();for(const r of e.sendInPings){const s=e=>t(e).get();yield i.update([r,e.type,n],s)}}))}hasMetric(e,t,i,r){return n(this,void 0,void 0,(function*(){const n=this._chooseStore(e);return!x(yield n.get([t,i,r]))}))}countByBaseIdentifier(e,t,i,r){return n(this,void 0,void 0,(function*(){const n=this._chooseStore(e),s=yield n.get([t,i]);return x(s)?0:Object.keys(s).filter((e=>e.startsWith(r))).length}))}getMetric(e,t){return n(this,void 0,void 0,(function*(){const i=this._chooseStore(t.lifetime),n=yield t.identifier(),a=yield i.get([e,t.type,n]);return x(a)||We(t.type,a)?a:(s(Be,`Unexpected value found for metric ${n}: ${JSON.stringify(a)}. Clearing.`,r.Error),void(yield i.delete([e,t.type,n])))}))}getAndValidatePingData(e,t){return n(this,void 0,void 0,(function*(){const i=this._chooseStore(t),n=yield i.get([e]);return x(n)?{}:function(e){if(S(e)){for(const t in e){const i=e[t];if(!S(i))return!1;for(const e in i)if(!We(t,i[e]))return s(Be,`Invalid metric representation found for metric "${e}"`,r.Debug),!1}return!0}return!1}(n)?n:(s(Be,`Unexpected value found for ping "${e}" in "${t}" store: ${JSON.stringify(n)}. Clearing.`,r.Debug),yield i.delete([e]),{})}))}processLabeledMetric(e,t,i,n){const r=`labeled_${t}`,s=i.split("/",2),a=s[0],o=s[1];if(r in e&&a in e[r]){const t=e[r][a];e[r][a]=Object.assign(Object.assign({},t),{[o]:n})}else e[r]=Object.assign(Object.assign({},e[r]),{[a]:{[o]:n}})}getPingMetrics(e,t){return n(this,void 0,void 0,(function*(){const i=yield this.getAndValidatePingData(e,"user"),n=yield this.getAndValidatePingData(e,"ping"),r=yield this.getAndValidatePingData(e,"application");t&&Object.keys(n).length>0&&(yield this.clear("ping",e));const s={};for(const e of[i,n,r])for(const t in e)for(const i in e[t])i.startsWith("glean.reserved#")||(i.includes("/")?this.processLabeledMetric(s,t,i,e[t][i]):s[t]=Object.assign(Object.assign({},s[t]),{[i]:e[t][i]}));return 0===Object.keys(s).length?void 0:function(e){const t={};for(const i in e){const n=e[i];t[i]={};for(const e in n){const r=Fe(i,n[e]);t[i][e]=r.payload()}}return t}(s)}))}clear(e,t){return n(this,void 0,void 0,(function*(){const i=this._chooseStore(e),n=t?[t]:[];yield i.delete(n)}))}clearAll(){return n(this,void 0,void 0,(function*(){yield this.userStore.delete([]),yield this.pingStore.delete([]),yield this.appStore.delete([])}))}};var He=Uint8Array,Xe=Uint16Array,Qe=Uint32Array,Ke=new He([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Ze=new He([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Ye=new He([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),et=function(e,t){for(var i=new Xe(31),n=0;n<31;++n)i[n]=t+=1<<e[n-1];var r=new Qe(i[30]);for(n=1;n<30;++n)for(var s=i[n];s<i[n+1];++s)r[s]=s-i[n]<<5|n;return[i,r]},tt=et(Ke,2),it=tt[0],nt=tt[1];it[28]=258,nt[258]=28;for(var rt=et(Ze,0),st=(rt[0],rt[1]),at=new Xe(32768),ot=0;ot<32768;++ot){var ct=(43690&ot)>>>1|(21845&ot)<<1;ct=(61680&(ct=(52428&ct)>>>2|(13107&ct)<<2))>>>4|(3855&ct)<<4,at[ot]=((65280&ct)>>>8|(255&ct)<<8)>>>1}var dt=function(e,t,i){for(var n=e.length,r=0,s=new Xe(t);r<n;++r)e[r]&&++s[e[r]-1];var a,o=new Xe(t);for(r=0;r<t;++r)o[r]=o[r-1]+s[r-1]<<1;if(i){a=new Xe(1<<t);var c=15-t;for(r=0;r<n;++r)if(e[r])for(var d=r<<4|e[r],l=t-e[r],u=o[e[r]-1]++<<l,h=u|(1<<l)-1;u<=h;++u)a[at[u]>>>c]=d}else for(a=new Xe(n),r=0;r<n;++r)e[r]&&(a[r]=at[o[e[r]-1]++]>>>15-e[r]);return a},lt=new He(288);for(ot=0;ot<144;++ot)lt[ot]=8;for(ot=144;ot<256;++ot)lt[ot]=9;for(ot=256;ot<280;++ot)lt[ot]=7;for(ot=280;ot<288;++ot)lt[ot]=8;var ut=new He(32);for(ot=0;ot<32;++ot)ut[ot]=5;var ht=dt(lt,9,0),gt=dt(ut,5,0),ft=function(e){return(e+7)/8|0},pt=function(e,t,i){(null==t||t<0)&&(t=0),(null==i||i>e.length)&&(i=e.length);var n=new(e instanceof Xe?Xe:e instanceof Qe?Qe:He)(i-t);return n.set(e.subarray(t,i)),n},vt=function(e,t,i){i<<=7&t;var n=t/8|0;e[n]|=i,e[n+1]|=i>>>8},mt=function(e,t,i){i<<=7&t;var n=t/8|0;e[n]|=i,e[n+1]|=i>>>8,e[n+2]|=i>>>16},yt=function(e,t){for(var i=[],n=0;n<e.length;++n)e[n]&&i.push({s:n,f:e[n]});var r=i.length,s=i.slice();if(!r)return[xt,0];if(1==r){var a=new He(i[0].s+1);return a[i[0].s]=1,[a,1]}i.sort((function(e,t){return e.f-t.f})),i.push({s:-1,f:25001});var o=i[0],c=i[1],d=0,l=1,u=2;for(i[0]={s:-1,f:o.f+c.f,l:o,r:c};l!=r-1;)o=i[i[d].f<i[u].f?d++:u++],c=i[d!=l&&i[d].f<i[u].f?d++:u++],i[l++]={s:-1,f:o.f+c.f,l:o,r:c};var h=s[0].s;for(n=1;n<r;++n)s[n].s>h&&(h=s[n].s);var g=new Xe(h+1),f=bt(i[l-1],g,0);if(f>t){n=0;var p=0,v=f-t,m=1<<v;for(s.sort((function(e,t){return g[t.s]-g[e.s]||e.f-t.f}));n<r;++n){var y=s[n].s;if(!(g[y]>t))break;p+=m-(1<<f-g[y]),g[y]=t}for(p>>>=v;p>0;){var b=s[n].s;g[b]<t?p-=1<<t-g[b]++-1:++n}for(;n>=0&&p;--n){var w=s[n].s;g[w]==t&&(--g[w],++p)}f=t}return[new He(g),f]},bt=function(e,t,i){return-1==e.s?Math.max(bt(e.l,t,i+1),bt(e.r,t,i+1)):t[e.s]=i},wt=function(e){for(var t=e.length;t&&!e[--t];);for(var i=new Xe(++t),n=0,r=e[0],s=1,a=function(e){i[n++]=e},o=1;o<=t;++o)if(e[o]==r&&o!=t)++s;else{if(!r&&s>2){for(;s>138;s-=138)a(32754);s>2&&(a(s>10?s-11<<5|28690:s-3<<5|12305),s=0)}else if(s>3){for(a(r),--s;s>6;s-=6)a(8304);s>2&&(a(s-3<<5|8208),s=0)}for(;s--;)a(r);s=1,r=e[o]}return[i.subarray(0,n),t]},_t=function(e,t){for(var i=0,n=0;n<t.length;++n)i+=e[n]*t[n];return i},Tt=function(e,t,i){var n=i.length,r=ft(t+2);e[r]=255&n,e[r+1]=n>>>8,e[r+2]=255^e[r],e[r+3]=255^e[r+1];for(var s=0;s<n;++s)e[r+s+4]=i[s];return 8*(r+4+n)},It=function(e,t,i,n,r,s,a,o,c,d,l){vt(t,l++,i),++r[256];for(var u=yt(r,15),h=u[0],g=u[1],f=yt(s,15),p=f[0],v=f[1],m=wt(h),y=m[0],b=m[1],w=wt(p),_=w[0],T=w[1],I=new Xe(19),S=0;S<y.length;++S)I[31&y[S]]++;for(S=0;S<_.length;++S)I[31&_[S]]++;for(var x=yt(I,7),E=x[0],P=x[1],D=19;D>4&&!E[Ye[D-1]];--D);var M,$,U,O,k=d+5<<3,A=_t(r,lt)+_t(s,ut)+a,R=_t(r,h)+_t(s,p)+a+14+3*D+_t(I,E)+(2*I[16]+3*I[17]+7*I[18]);if(k<=A&&k<=R)return Tt(t,l,e.subarray(c,c+d));if(vt(t,l,1+(R<A)),l+=2,R<A){M=dt(h,g,0),$=h,U=dt(p,v,0),O=p;var z=dt(E,P,0);vt(t,l,b-257),vt(t,l+5,T-1),vt(t,l+10,D-4),l+=14;for(S=0;S<D;++S)vt(t,l+3*S,E[Ye[S]]);l+=3*D;for(var V=[y,_],C=0;C<2;++C){var G=V[C];for(S=0;S<G.length;++S){var N=31&G[S];vt(t,l,z[N]),l+=E[N],N>15&&(vt(t,l,G[S]>>>5&127),l+=G[S]>>>12)}}}else M=ht,$=lt,U=gt,O=ut;for(S=0;S<o;++S)if(n[S]>255){N=n[S]>>>18&31;mt(t,l,M[N+257]),l+=$[N+257],N>7&&(vt(t,l,n[S]>>>23&31),l+=Ke[N]);var j=31&n[S];mt(t,l,U[j]),l+=O[j],j>3&&(mt(t,l,n[S]>>>5&8191),l+=Ze[j])}else mt(t,l,M[n[S]]),l+=$[n[S]];return mt(t,l,M[256]),l+$[256]},St=new Qe([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),xt=new He(0),Et=function(e,t,i,n,r,s){var a=e.length,o=new He(n+a+5*(1+Math.ceil(a/7e3))+r),c=o.subarray(n,o.length-r),d=0;if(!t||a<8)for(var l=0;l<=a;l+=65535){var u=l+65535;u>=a&&(c[d>>3]=s),d=Tt(c,d+1,e.subarray(l,u))}else{for(var h=St[t-1],g=h>>>13,f=8191&h,p=(1<<i)-1,v=new Xe(32768),m=new Xe(p+1),y=Math.ceil(i/3),b=2*y,w=function(t){return(e[t]^e[t+1]<<y^e[t+2]<<b)&p},_=new Qe(25e3),T=new Xe(288),I=new Xe(32),S=0,x=0,E=(l=0,0),P=0,D=0;l<a;++l){var M=w(l),$=32767&l,U=m[M];if(v[$]=U,m[M]=$,P<=l){var O=a-l;if((S>7e3||E>24576)&&O>423){d=It(e,c,0,_,T,I,x,E,D,l-D,d),E=S=x=0,D=l;for(var k=0;k<286;++k)T[k]=0;for(k=0;k<30;++k)I[k]=0}var A=2,R=0,z=f,V=$-U&32767;if(O>2&&M==w(l-V))for(var C=Math.min(g,O)-1,G=Math.min(32767,l),N=Math.min(258,O);V<=G&&--z&&$!=U;){if(e[l+A]==e[l+A-V]){for(var j=0;j<N&&e[l+j]==e[l+j-V];++j);if(j>A){if(A=j,R=V,j>C)break;var L=Math.min(V,j-2),q=0;for(k=0;k<L;++k){var F=l-V+k+32768&32767,W=F-v[F]+32768&32767;W>q&&(q=W,U=F)}}}V+=($=U)-(U=v[$])+32768&32767}if(R){_[E++]=268435456|nt[A]<<18|st[R];var B=31&nt[A],J=31&st[R];x+=Ke[B]+Ze[J],++T[257+B],++I[J],P=l+A,++S}else _[E++]=e[l],++T[e[l]]}}d=It(e,c,s,_,T,I,x,E,D,l-D,d),!s&&7&d&&(d=Tt(c,d+1,xt))}return pt(o,0,n+ft(d)+r)},Pt=function(){for(var e=new Int32Array(256),t=0;t<256;++t){for(var i=t,n=9;--n;)i=(1&i&&-306674912)^i>>>1;e[t]=i}return e}(),Dt=function(){var e=-1;return{p:function(t){for(var i=e,n=0;n<t.length;++n)i=Pt[255&i^t[n]]^i>>>8;e=i},d:function(){return~e}}},Mt=function(e,t,i,n,r){return Et(e,null==t.level?6:t.level,null==t.mem?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(e.length)))):12+t.mem,i,n,!r)},$t=function(e,t,i){for(;i;++t)e[t]=i,i>>>=8},Ut=function(e,t){var i=t.filename;if(e[0]=31,e[1]=139,e[2]=8,e[8]=t.level<2?4:9==t.level?2:0,e[9]=3,0!=t.mtime&&$t(e,4,Math.floor(new Date(t.mtime||Date.now())/1e3)),i){e[3]=8;for(var n=0;n<=i.length;++n)e[n+10]=i.charCodeAt(n)}},Ot=function(e){return 10+(e.filename&&e.filename.length+1||0)};function kt(e,t){t||(t={});var i=Dt(),n=e.length;i.p(e);var r=Mt(e,t,Ot(t),8),s=r.length;return Ut(r,t),$t(r,s-8,i.d()),$t(r,s-4,n),r}var At="undefined"!=typeof TextEncoder&&new TextEncoder,Rt="undefined"!=typeof TextDecoder&&new TextDecoder;try{Rt.decode(xt,{stream:!0}),1}catch(e){}function zt(e,t){if(t){for(var i=new He(e.length),n=0;n<e.length;++n)i[n]=e.charCodeAt(n);return i}if(At)return At.encode(e);var r=e.length,s=new He(e.length+(e.length>>1)),a=0,o=function(e){s[a++]=e};for(n=0;n<r;++n){if(a+5>s.length){var c=new He(a+8+(r-n<<1));c.set(s),s=c}var d=e.charCodeAt(n);d<128||t?o(d):d<2048?(o(192|d>>6),o(128|63&d)):d>55295&&d<57344?(o(240|(d=65536+(1047552&d)|1023&e.charCodeAt(++n))>>18),o(128|d>>12&63),o(128|d>>6&63),o(128|63&d)):(o(224|d>>12),o(128|d>>6&63),o(128|63&d))}return pt(s,0,a)}"function"==typeof queueMicrotask?queueMicrotask:"function"==typeof setTimeout&&setTimeout;const Vt="core.Pings.Database";function Ct(e){return e.path.split("/")[3]===H}function Gt(e){return zt(JSON.stringify(e)).length}function Nt(e){if(S(e)&&(2===Object.keys(e).length||3===Object.keys(e).length)){const t="path"in e&&E(e.path),i="payload"in e&&I(e.payload)&&S(e.payload),n=!("headers"in e)||I(e.headers)&&S(e.headers);return!!(t&&i&&n)}return!1}const jt=class{constructor(){this.store=new T.platform.Storage("pings")}attachObserver(e){this.observer=e}recordPing(e,t,i,r){return n(this,void 0,void 0,(function*(){const n={collectionDate:(new Date).toISOString(),path:e,payload:i};r&&(n.headers=r),yield this.store.update([t],(()=>n)),this.observer&&this.observer.update(t,n)}))}deletePing(e){return n(this,void 0,void 0,(function*(){yield this.store.delete([e])}))}getAllPings(){return n(this,void 0,void 0,(function*(){const e=yield this.store.get(),t={};if(S(e))for(const i in e){const n=e[i];Nt(n)?t[i]=n:(s(Vt,"Unexpected data found in pings database. Deleting.",r.Warn),yield this.store.delete([i]))}return Object.entries(t).sort((([e,{collectionDate:t}],[i,{collectionDate:n}])=>new Date(t).getTime()-new Date(n).getTime()))}))}getAllPingsWithoutSurplus(e=250,t=10485760){return n(this,void 0,void 0,(function*(){const i=yield this.getAllPings(),n=i.filter((([e,t])=>!Ct(t))).reverse(),a=i.filter((([e,t])=>Ct(t))),o=n.length;o>e&&s(Vt,[`More than ${e} pending pings in the pings database,`,`will delete ${o-e} old pings.`],r.Warn);let c=!1,d=0,l=0;const u=[];for(const[i,a]of n)d++,l+=Gt(a),!c&&l>t&&(s(Vt,[`Pending pings database has reached the size quota of ${t} bytes,`,"outstanding pings will be deleted."],r.Warn),c=!0),d>e&&(c=!0),c?yield this.deletePing(i):u.unshift([i,a]);return[...a,...u]}))}scanPendingPings(){return n(this,void 0,void 0,(function*(){if(!this.observer)return;const e=yield this.getAllPingsWithoutSurplus();for(const[t,i]of e)this.observer.update(t,i)}))}clearAll(){return n(this,void 0,void 0,(function*(){yield this.store.delete([])}))}};var Lt;!function(e){e[e.Incrementing=0]="Incrementing",e[e.Throttled=1]="Throttled"}(Lt||(Lt={}));const qt=class{constructor(e=6e4,t=40,i=0,n){this.interval=e,this.maxCount=t,this.count=i,this.started=n}get elapsed(){if(x(this.started))return NaN;const e=k()-this.started;return e<0?NaN:e}reset(){this.started=k(),this.count=0}shouldReset(){return!!x(this.started)||!!(isNaN(this.elapsed)||this.elapsed>this.interval)}getState(){this.shouldReset()&&this.reset();const e=this.interval-this.elapsed;return this.count>=this.maxCount?{state:1,remainingTime:e}:(this.count++,{state:0})}};class Ft{constructor(e=3,t=3,i=1048576){this.maxWaitAttempts=e,this.maxRecoverableFailures=t,this.maxPingBodySize=i}}const Wt="core.Upload.PingUploadWorker";class Bt extends Error{constructor(e){super(e),this.name="PingBodyOverflow"}}const Jt=class{constructor(e,t,i=new Ft){this.uploader=e,this.serverEndpoint=t,this.policy=i,this.isBlocking=!1}buildPingRequest(e){return n(this,void 0,void 0,(function*(){let t=e.headers||{};t=Object.assign(Object.assign({},e.headers),{"Content-Type":"application/json; charset=utf-8",Date:(new Date).toISOString(),"X-Client-Type":"Glean.js","X-Client-Version":F,"X-Telemetry-Agent":`Glean/0.30.0 (JS on ${yield T.platform.info.os()})`});const i=JSON.stringify(e.payload),n=zt(i);let r,s;try{r=kt(n),s=r.length,t["Content-Encoding"]="gzip"}catch(e){r=i,s=n.length}if(s>this.policy.maxPingBodySize)throw new Bt(`Body for ping ${e.identifier} exceeds ${this.policy.maxPingBodySize}bytes. Discarding.`);return t["Content-Length"]=s.toString(),{headers:t,payload:r}}))}attemptPingUpload(e){return n(this,void 0,void 0,(function*(){try{const t=yield this.buildPingRequest(e);return yield this.uploader.post(`${this.serverEndpoint}${e.path}`,t.payload,t.headers)}catch(e){return s(Wt,["Error trying to build or post ping request:",e],r.Warn),new o(1)}}))}workInternal(e,t){return n(this,void 0,void 0,(function*(){for(;;){const i=e();switch(i.type){case"upload":const e=yield this.attemptPingUpload(i.ping);yield t(i.ping,e);continue;case"wait":if(this.isBlocking)return;try{if(yield new Promise((e=>{this.waitPromiseResolver=e,this.waitTimeoutId=T.platform.timer.setTimeout((()=>{this.waitPromiseResolver=void 0,this.waitTimeoutId=void 0,e(!1)}),i.remainingTime)})))return}catch(e){return this.waitPromiseResolver=void 0,void(this.waitTimeoutId=void 0)}continue;case"done":return}}}))}work(e,t){this.currentJob||(this.currentJob=this.workInternal(e,t).then((()=>{this.currentJob=void 0})).catch((e=>{s(Wt,["IMPOSSIBLE: Something went wrong while processing ping upload tasks.",e],r.Error)})))}blockOnCurrentJob(){return n(this,void 0,void 0,(function*(){return this.currentJob?(this.waitTimeoutId&&this.waitPromiseResolver&&(T.platform.timer.clearTimeout(this.waitTimeoutId),this.waitPromiseResolver(!0),this.waitPromiseResolver=void 0,this.waitTimeoutId=void 0),this.isBlocking=!0,yield this.currentJob,void(this.isBlocking=!1)):Promise.resolve()}))}};var Ht;!function(e){e.Done="done",e.Wait="wait",e.Upload="upload"}(Ht||(Ht={}));const Xt=()=>({type:"done"}),Kt=e=>({type:"wait",remainingTime:e}),Zt=e=>({type:"upload",ping:e}),Yt="core.Upload.PingUploadManager";const ei=class{constructor(e,t,i=new Ft,n=new qt){this.pingsDatabase=t,this.policy=i,this.rateLimiter=n,this.recoverableFailureCount=0,this.waitAttemptCount=0,this.queue=[],this.worker=new Jt(e.httpClient?e.httpClient:T.platform.uploader,e.serverEndpoint,i),t.attachObserver(this)}enqueuePing(e){for(const t of this.queue)if(t.identifier===e.identifier)return;this.queue.push(e)}getUploadTaskInternal(){if(this.recoverableFailureCount>=this.policy.maxRecoverableFailures)return s(Yt,"Glean has reached maximum recoverable upload failures for the current uploading window.",r.Debug),Xt();if(this.queue.length>0){const{state:e,remainingTime:t}=this.rateLimiter.getState();if(1===e)return s(Yt,["Glean is currently throttled.",`Pending pings may be uploaded in ${(t||0)/1e3}s.`],r.Debug),this.waitAttemptCount++,this.waitAttemptCount>this.policy.maxWaitAttempts?Xt():Kt(t||0);const i=this.queue.shift();return Zt(i)}return Xt()}getUploadTask(){const e=this.getUploadTaskInternal();return"wait"!==e.type&&this.waitAttemptCount>0&&(this.waitAttemptCount=0),"upload"!==e.type&&this.recoverableFailureCount>0&&(this.recoverableFailureCount=0),e}processPingUploadResponse(e,t){return n(this,void 0,void 0,(function*(){const{identifier:i}=e;this.queue.filter((e=>e.identifier!==i));const{status:n,result:a}=t;return n&&n>=200&&n<300?(s(Yt,`Ping ${i} succesfully sent ${n}.`,r.Info),void(yield this.pingsDatabase.deletePing(i))):1===a||n&&n>=400&&n<500?(s(Yt,`Unrecoverable upload failure while attempting to send ping ${i}. Error was: ${null!=n?n:"no status"}.`,r.Warn),void(yield this.pingsDatabase.deletePing(i))):(s(Yt,[`Recoverable upload failure while attempting to send ping ${i}, will retry.`,`Error was: ${null!=n?n:"no status"}.`],r.Warn),this.recoverableFailureCount++,void this.enqueuePing(e))}))}clearPendingPingsQueue(){return n(this,void 0,void 0,(function*(){this.queue=this.queue.filter((e=>Ct(e))),yield this.blockOnOngoingUploads()}))}blockOnOngoingUploads(){return n(this,void 0,void 0,(function*(){return this.worker.blockOnCurrentJob()}))}update(e,t){this.enqueuePing(Object.assign({identifier:e},t)),this.worker.work((()=>this.getUploadTask()),((e,t)=>this.processPingUploadResponse(e,t)))}};class ti{constructor(){this.clientId=new Le({name:"client_id",category:"",sendInPings:["glean_client_info"],lifetime:"user",disabled:!1}),this.firstRunDate=new me({name:"first_run_date",category:"",sendInPings:["glean_client_info"],lifetime:"user",disabled:!1},fe.Day),this.os=new xe({name:"os",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1}),this.osVersion=new xe({name:"os_version",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1}),this.architecture=new xe({name:"architecture",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1}),this.locale=new xe({name:"locale",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1}),this.appChannel=new xe({name:"app_channel",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1}),this.appBuild=new xe({name:"app_build",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1}),this.appDisplayVersion=new xe({name:"app_display_version",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1})}initialize(){return n(this,void 0,void 0,(function*(){yield this.initializeClientId(),yield this.initializeFirstRunDate(),yield xe._private_setUndispatched(this.os,yield T.platform.info.os()),yield xe._private_setUndispatched(this.osVersion,yield T.platform.info.osVersion(T.config.osVersion)),yield xe._private_setUndispatched(this.architecture,yield T.platform.info.arch(T.config.architecture)),yield xe._private_setUndispatched(this.locale,yield T.platform.info.locale()),yield xe._private_setUndispatched(this.appBuild,T.config.appBuild||"Unknown"),yield xe._private_setUndispatched(this.appDisplayVersion,T.config.appDisplayVersion||"Unknown"),T.config.channel&&(yield xe._private_setUndispatched(this.appChannel,T.config.channel))}))}initializeClientId(){return n(this,void 0,void 0,(function*(){let e=!1;const t=yield T.metricsDatabase.getMetric(B,this.clientId);if(t)try{Fe("uuid",t).payload()===J&&(e=!0)}catch(t){s("core.InternalMetrics","Unexpected value found for Glean clientId. Ignoring.",r.Warn),e=!0}else e=!0;e&&(yield Le._private_setUndispatched(this.clientId,U()))}))}initializeFirstRunDate(){return n(this,void 0,void 0,(function*(){(yield T.metricsDatabase.getMetric(B,this.firstRunDate))||(yield me._private_setUndispatched(this.firstRunDate))}))}}class ii{constructor(e,t,i,n){this.category=e,this.name=t,this.timestamp=i,this.extra=n}static toJSONObject(e){return{category:e.category,name:e.name,timestamp:e.timestamp,extra:e.extra}}static fromJSONObject(e){return new ii(e.category,e.name,e.timestamp,e.extra)}static withTransformedExtras(e,t){const i=t(e.extra||{});return new ii(e.category,e.name,e.timestamp,i&&Object.keys(i).length>0?i:void 0)}addExtra(e,t){this.extra||(this.extra={}),this.extra[e]=t}withoutReservedExtras(){return ii.withTransformedExtras(this,(e=>Object.keys(e).filter((e=>!K.includes(e))).reduce(((t,i)=>(t[i]=e[i],t)),{})))}payload(){return ii.withTransformedExtras(this.withoutReservedExtras(),(e=>Object.keys(e).reduce(((t,i)=>(t[i]=e[i].toString(),t)),{})))}}class ni extends oe{constructor(e,t){super("event",e),this.allowedExtraKeys=t}static _private_recordUndispatched(e,t,r=k()){return n(this,void 0,void 0,(function*(){if(!e.shouldRecord(T.uploadEnabled))return;let n;if(t&&e.allowedExtraKeys){n={};for(const[r,s]of Object.entries(t))e.allowedExtraKeys.includes(r)?E(s)?n[r]=yield A(e,s,100):n[r]=s:yield T.errorManager.record(e,i.InvalidValue,`Invalid key index: ${r}`)}return T.eventsDatabase.record(e,new ii(e.category,e.name,r,n))}))}record(e){const t=k();T.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){yield ni._private_recordUndispatched(this,e,t)}))))}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){if(R("testGetValue","core.metrics.EventMetricType")){let t;return yield T.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield T.eventsDatabase.getEvents(e,this)})))),t}}))}}const ri=ni;function si(e){E(e)||(e="");const t=new Date(e);if(isNaN(t.getTime()))throw new Error(`Error attempting to generate Date object from string: ${e}`);return t}function ai(e){return new he(Object.assign(Object.assign({},{category:"glean",name:`reserved#${"execution_counter"}`}),{sendInPings:e,lifetime:"ping",disabled:!1}))}function oi(e){return new ri({category:"glean",name:"restarted",sendInPings:e,lifetime:"ping",disabled:!1},[X])}function ci(e,t=T.startTime){return n(this,void 0,void 0,(function*(){const i=oi(e);yield ri._private_recordUndispatched(i,{[X]:t.toISOString()},0)}))}const di=class{constructor(){this.initialized=!1,this.eventsStore=new T.platform.Storage("events")}getAvailableStoreNames(){return n(this,void 0,void 0,(function*(){const e=yield this.eventsStore.get([]);return x(e)?[]:Object.keys(e)}))}initialize(){return n(this,void 0,void 0,(function*(){if(this.initialized)return;const e=yield this.getAvailableStoreNames();yield he._private_addUndispatched(ai(e),1),yield ci(e),this.initialized=!0}))}record(e,t){return n(this,void 0,void 0,(function*(){if(!e.disabled)for(const i of e.sendInPings){const e=ai([i]);let n=yield T.metricsDatabase.getMetric(i,e);n||(yield he._private_addUndispatched(e,1),n=1,yield ci([i],new Date)),t.addExtra(Q,n);const r=e=>{var i;const n=null!==(i=e)&&void 0!==i?i:[];return n.push(ii.toJSONObject(t)),n};yield this.eventsStore.update([i],r)}}))}getEvents(e,t){return n(this,void 0,void 0,(function*(){const i=yield this.getAndValidatePingData(e);if(0!==i.length)return i.filter((e=>e.category===t.category&&e.name===t.name)).map((e=>e.withoutReservedExtras()))}))}getAndValidatePingData(e){return n(this,void 0,void 0,(function*(){const t=yield this.eventsStore.get([e]);return x(t)?[]:Array.isArray(t)?t.map((e=>ii.fromJSONObject(e))):(s("core.Metric.EventsDatabase",`Unexpected value found for ping ${e}: ${JSON.stringify(t)}. Clearing.`,r.Error),yield this.eventsStore.delete([e]),[])}))}getPingEvents(e,t){return n(this,void 0,void 0,(function*(){const i=yield this.getAndValidatePingData(e);if(t&&Object.keys(i).length>0&&(yield this.eventsStore.delete([e])),0===i.length)return;const n=yield this.prepareEventsPayload(e,i);return n.length>0?n:void 0}))}prepareEventsPayload(e,t){var r,s,a,o;return n(this,void 0,void 0,(function*(){const n=t.sort(((e,t)=>{var i,n;const r=Number(null===(i=e.extra)||void 0===i?void 0:i["#glean_execution_counter"]),s=Number(null===(n=t.extra)||void 0===n?void 0:n["#glean_execution_counter"]);return r!==s?r-s:e.timestamp-t.timestamp}));let c;try{c=si(null===(r=n[0].extra)||void 0===r?void 0:r["#glean_reference_time"]),n.shift()}catch(e){c=T.startTime}const d=(null===(s=n[0])||void 0===s?void 0:s.timestamp)||0;let l=0;for(const[t,r]of n.entries()){try{const s=si(null===(a=r.extra)||void 0===a?void 0:a["#glean_reference_time"]),o=s.getTime()-c.getTime();c=s;const d=l+o,u=n[t-1].timestamp;d<=u?(l=u+1,yield T.errorManager.record(oi([e]),i.InvalidValue,`Invalid time offset between application sessions found for ping "${e}". Ignoring.`)):l=d}catch(e){}let s;s=1===Number((null===(o=r.extra)||void 0===o?void 0:o["#glean_execution_counter"])||1)?r.timestamp-d:r.timestamp+l,n[t]=new ii(r.category,r.name,s,r.extra)}return n.map((e=>ii.toJSONObject(e.payload())))}))}clearAll(){return n(this,void 0,void 0,(function*(){yield this.eventsStore.delete([])}))}};const li={afterPingCollection:new class{constructor(e){this.name=e}get registeredPluginIdentifier(){var e;return null===(e=this.plugin)||void 0===e?void 0:e.name}registerPlugin(e){this.plugin?s("core.Events",[`Attempted to register plugin '${e.name}', which listens to the event '${e.event}'.`,`That event is already watched by plugin '${this.plugin.name}'`,`Plugin '${e.name}' will be ignored.`],r.Error):this.plugin=e}deregisterPlugin(){this.plugin=void 0}trigger(...e){if(this.plugin)return this.plugin.action(...e)}}("afterPingCollection")},ui=li,hi="core.Pings.Maker";function gi(e){return n(this,void 0,void 0,(function*(){const{startTimeMetric:t,startTime:i}=yield function(e){return n(this,void 0,void 0,(function*(){const t=new me({category:"",name:`${e.name}#start`,sendInPings:[W],lifetime:"user",disabled:!1},fe.Minute),i=yield T.metricsDatabase.getMetric(W,t);let n;return n=i?new pe(i):pe.fromDate(T.startTime,fe.Minute),{startTimeMetric:t,startTime:n}}))}(e),r=new Date;yield me._private_setUndispatched(t,r);const s=pe.fromDate(r,fe.Minute);return{startTime:i.payload(),endTime:s.payload()}}))}function fi(e,t){return n(this,void 0,void 0,(function*(){const i=yield function(e){return n(this,void 0,void 0,(function*(){const t=new he({category:"",name:`${e.name}#sequence`,sendInPings:[W],lifetime:"user",disabled:!1}),i=yield T.metricsDatabase.getMetric(W,t);if(yield he._private_addUndispatched(t,1),i)try{return new le(i).payload()}catch(t){s(hi,`Unexpected value found for sequence number in ping ${e.name}. Ignoring.`,r.Warn)}return 0}))}(e),{startTime:a,endTime:o}=yield gi(e),c={seq:i,start_time:a,end_time:o};return t&&(c.reason=t),c}))}function pi(e,t){return n(this,void 0,void 0,(function*(){const i=yield T.eventsDatabase.getPingEvents(e.name,!0),a=yield T.metricsDatabase.getPingMetrics(e.name,!0);if(!a&&!i){if(!e.sendIfEmpty)return void s(hi,`Storage for ${e.name} empty. Bailing out.`,r.Info);s(hi,`Storage for ${e.name} empty. Ping will still be sent.`,r.Info)}const o=a?{metrics:a}:{},c=i?{events:i}:{},d=yield fi(e,t),l=yield function(e){return n(this,void 0,void 0,(function*(){let t=yield T.metricsDatabase.getPingMetrics(B,!0);t||(s(hi,"Empty client info data. Will submit anyways.",r.Warn),t={});let i={telemetry_sdk_build:F};for(const e in t)i=Object.assign(Object.assign({},i),t[e]);return e.includeClientId||delete i.client_id,i}))}(e);return Object.assign(Object.assign(Object.assign({},o),c),{ping_info:d,client_info:l})}))}const vi=function(e,t,i){return n(this,void 0,void 0,(function*(){const n=yield pi(t,i);if(!n)return;let a;try{a=yield ui.afterPingCollection.trigger(n)}catch(e){return void s(hi,[`Error while attempting to modify ping payload for the "${t.name}" ping using`,`the ${JSON.stringify(ui.afterPingCollection.registeredPluginIdentifier)} plugin.`,"Ping will not be submitted. See more logs below.\n\n",e],r.Error)}T.config.logPings&&s(hi,JSON.stringify(n,null,2),r.Info);const o=a||n,c=function(){const e={};if(T.config.debugViewTag&&(e["X-Debug-ID"]=T.config.debugViewTag),T.config.sourceTags&&(e["X-Source-Tags"]=T.config.sourceTags.toString()),Object.keys(e).length>0)return e}();return T.pingsDatabase.recordPing(function(e,t){return`/submit/${T.applicationId}/${t.name}/1/${e}`}(e,t),e,o,c)}))},mi="core.Pings.PingType";class yi{constructor(e){var t;this.name=e.name,this.includeClientId=e.includeClientId,this.sendIfEmpty=e.sendIfEmpty,this.reasonCodes=null!==(t=e.reasonCodes)&&void 0!==t?t:[]}isDeletionRequest(){return this.name===H}submit(e){this.testCallback?this.testCallback(e).then((()=>{yi._private_internalSubmit(this,e,this.resolveTestPromiseFunction)})).catch((t=>{s(mi,[`There was an error validating "${this.name}" (${null!=e?e:"no reason"}):`,t],r.Error),yi._private_internalSubmit(this,e,this.rejectTestPromiseFunction)})):yi._private_internalSubmit(this,e)}static _private_submitUndispatched(e,t,i){return n(this,void 0,void 0,(function*(){if(!T.initialized)return void s(mi,"Glean must be initialized before submitting pings.",r.Info);if(!T.uploadEnabled&&!e.isDeletionRequest())return void s(mi,"Glean disabled: not submitting pings. Glean may still submit the deletion-request ping.",r.Info);let n=t;t&&!e.reasonCodes.includes(t)&&(s(mi,`Invalid reason code ${t} from ${this.name}. Ignoring.`,r.Warn),n=void 0);const a=U();yield vi(a,e,n),i&&(i(),e.resolveTestPromiseFunction=void 0,e.rejectTestPromiseFunction=void 0,e.testCallback=void 0)}))}static _private_internalSubmit(e,t,i){T.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){yield yi._private_submitUndispatched(e,t,i)}))))}testBeforeNextSubmit(e){return n(this,void 0,void 0,(function*(){if(R("testBeforeNextSubmit",mi))return this.testCallback?void s(mi,`There is an existing test call for ping "${this.name}". Ignoring.`,r.Error):new Promise(((t,i)=>{this.resolveTestPromiseFunction=t,this.rejectTestPromiseFunction=i,this.testCallback=e}))}))}}const bi=yi;const wi=class{constructor(){this.deletionRequest=new bi({name:H,includeClientId:!0,sendIfEmpty:!0})}};function _i(e){const t=e.event;if(t in ui){ui[t].registerPlugin(e)}else s("core.Events.Utils",[`Attempted to register plugin '${e.name}', which listens to the event '${e.event}'.`,"That is not a valid Glean event. Ignoring"],r.Error)}function Ti(e,t){const i=function(e){return e.split("/")[0]}(e.baseIdentifier());return new he({name:re(t,i),category:"glean.error",lifetime:"ping",sendInPings:e.sendInPings,disabled:!1})}class Ii{record(e,t,i,r=1){return n(this,void 0,void 0,(function*(){const n=Ti(e,t);s(function(e){return`core.Metrics.${e.type.charAt(0).toUpperCase()+e.type.slice(1)}`}(e),[`${e.baseIdentifier()}:`,i]),r>0&&(yield he._private_addUndispatched(n,r))}))}testGetNumRecordedErrors(e,t,i){return n(this,void 0,void 0,(function*(){const n=Ti(e,t);return(yield n.testGetValue(i))||0}))}}let Si={};const xi=class{constructor(e){this.rootKey=e}get(e=[]){try{const t=G(Si,[this.rootKey,...e]);return Promise.resolve(t)}catch(e){return Promise.reject(e)}}update(e,t){try{return Si=N(Si,[this.rootKey,...e],t),Promise.resolve()}catch(e){return Promise.reject(e)}}delete(e){try{Si=function(e,t){if(0===t.length)return{};const i=Object.assign({},e);let n=i;for(const e of t.slice(0,t.length-1)){const i=n[e];if(!S(i))throw Error(`Attempted to delete an entry from an inexistent index: ${JSON.stringify(t)}.`);n=i}return delete n[t[t.length-1]],i}(Si,[this.rootKey,...e])}catch(t){s("plaftom.test.Storage",[`Error attempting to delete key ${e.toString()} from storage. Ignoring.`,t],r.Warn)}return Promise.resolve()}};const Ei={os:()=>Promise.resolve("Unknown"),osVersion:()=>Promise.resolve("Unknown"),arch:()=>Promise.resolve("Unknown"),locale:()=>Promise.resolve("Unknown")},Pi="undefined"!=typeof setTimeout?setTimeout:()=>{throw new Error},Di="undefined"!=typeof clearTimeout?clearTimeout:()=>{},Mi={Storage:xi,uploader:new class extends c{post(e,t,i){const n=new o(2,200);return Promise.resolve(n)}},info:Ei,timer:{setTimeout:Pi,clearTimeout:Di},name:"test"},$i="core.Glean";var Ui;!function(e){function t(){return n(this,void 0,void 0,(function*(){T.uploadEnabled=!0,yield e.coreMetrics.initialize()}))}function i(){return n(this,void 0,void 0,(function*(){T.uploadEnabled=!1,yield bi._private_submitUndispatched(e.corePings.deletionRequest),yield a()}))}function a(){return n(this,void 0,void 0,(function*(){let t;yield e.pingUploader.clearPendingPingsQueue();try{t=new pe(yield T.metricsDatabase.getMetric(B,e.coreMetrics.firstRunDate)).date}catch(e){t=new Date}yield T.eventsDatabase.clearAll(),yield T.metricsDatabase.clearAll(),yield T.pingsDatabase.clearAll(),T.uploadEnabled=!0,yield Le._private_setUndispatched(e.coreMetrics.clientId,J),yield me._private_setUndispatched(e.coreMetrics.firstRunDate,t),T.uploadEnabled=!1}))}function o(o,c,d){if(T.initialized)return void s($i,"Attempted to initialize Glean, but it has already been initialized. Ignoring.",r.Warn);if(!E(o))return void s($i,"Unable to initialize Glean, applicationId must be a string.",r.Error);if(!P(c))return void s($i,"Unable to initialize Glean, uploadEnabled must be a boolean.",r.Error);if(0===o.length)return void s($i,"Unable to initialize Glean, applicationId cannot be an empty string.",r.Error);if(!T.platform)return void s($i,"Unable to initialize Glean, platform has not been set.",r.Error);T.applicationId=function(e){return e.replace(/[^a-z0-9]+/gi,"-").toLowerCase()}(o);const l=new Y(d);if(T.config=l,T.metricsDatabase=new Je,T.eventsDatabase=new di,T.pingsDatabase=new jt,T.errorManager=new Ii,e.pingUploader=new ei(l,T.pingsDatabase),null==d?void 0:d.plugins)for(const e of d.plugins)_i(e);T.dispatcher.flushInit((()=>n(this,void 0,void 0,(function*(){if(T.initialized=!0,T.uploadEnabled=c,c)yield T.metricsDatabase.clear("application"),yield t();else{const t=yield T.metricsDatabase.getMetric(B,e.coreMetrics.clientId);t?t!==J&&(yield i()):yield a()}yield T.eventsDatabase.initialize(),yield T.pingsDatabase.scanPendingPings()}))))}function c(){return n(this,void 0,void 0,(function*(){T.initialized?(yield T.dispatcher.shutdown(),yield e.pingUploader.blockOnOngoingUploads()):s($i,"Attempted to shutdown Glean, but Glean is not initialized. Ignoring.")}))}function d(e){T.initialized||(T.isPlatformSet()&&T.platform.name!==e.name&&!T.testing&&s($i,[`IMPOSSIBLE: Attempted to change Glean's targeted platform",\n          "from "${T.platform.name}" to "${e.name}". Ignoring.`],r.Error),T.platform=e)}function l(e,t=!0,i){return n(this,void 0,void 0,(function*(){T.testing=!0,d(Mi),o(e,t,i),yield T.dispatcher.testBlockOnQueue()}))}function u(e=!0){return n(this,void 0,void 0,(function*(){T.initialized&&(yield c(),e&&(yield T.eventsDatabase.clearAll(),yield T.metricsDatabase.clearAll(),yield T.pingsDatabase.clearAll()),T.testUninitialize(),function(){for(const e in ui)ui[e].deregisterPlugin()}())}))}e.coreMetrics=new ti,e.corePings=new wi,e.initialize=o,e.setUploadEnabled=function(e){T.initialized?P(e)?T.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){T.uploadEnabled!==e&&(e?yield t():yield i())})))):s($i,"Unable to change upload state, new value must be a boolean. Ignoring.",r.Error):s($i,["Changing upload enabled before Glean is initialized is not supported.\n","Pass the correct state into `initialize`.\n","See documentation at https://mozilla.github.io/glean/book/user/general-api.html#initializing-the-glean-sdk`"],r.Error)},e.setLogPings=function(e){T.dispatcher.launch((()=>(T.config.logPings=e,Promise.resolve())))},e.setDebugViewTag=function(e){T.dispatcher.launch((()=>(T.config.debugViewTag=e,Promise.resolve())))},e.setSourceTags=function(e){T.dispatcher.launch((()=>(T.config.sourceTags=e,Promise.resolve())))},e.shutdown=c,e.setPlatform=d,e.testInitialize=l,e.testUninitialize=u,e.testResetGlean=function(e,t=!0,i,r=!0){return n(this,void 0,void 0,(function*(){yield u(r),yield l(e,t,i)}))}}(Ui||(Ui={}));const Oi=Ui,ki=Object.assign(Object.assign({},(Ai=q,{initialize(e,t,i){Oi.setPlatform(Ai),Oi.initialize(e,t,i)},setUploadEnabled(e){Oi.setUploadEnabled(e)},setLogPings(e){Oi.setLogPings(e)},setDebugViewTag(e){Oi.setDebugViewTag(e)},shutdown:()=>Oi.shutdown(),setSourceTags(e){Oi.setSourceTags(e)},testResetGlean(e,t=!0,i){return n(this,void 0,void 0,(function*(){return Oi.testResetGlean(e,t,i)}))}})),{ErrorType:i,_private:{PingType:bi,BooleanMetricType:de,CounterMetricType:he,DatetimeMetricType:me,EventMetricType:ri,LabeledMetricType:ae,QuantityMetricType:we,RateMetricType:Te,StringMetricType:xe,StringListMetricType:De,TimespanMetricType:Ae,TextMetricType:Ue,UUIDMetricType:Le,URLMetricType:Ce}});var Ai})(),Glean=t})();