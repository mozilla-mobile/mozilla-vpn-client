#!/usr/bin/env bash

# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

set -eu

APP_DIR="$2/Mozilla VPN.app"
LOG_DIR=/var/log/mozillavpn

OSX_MAJOR_VER=$(sw_vers -productVersion | cut -d. -f1)

CODESIGN_APP_IDENTIFIER="@BUILD_OSX_APP_IDENTIFIER@"
DAEMON_PLIST_PATH="/Library/LaunchDaemons/${CODESIGN_APP_IDENTIFIER}.daemon.plist"

mkdir -p $LOG_DIR
chmod 755 $LOG_DIR
exec 2>&1 > $LOG_DIR/postinstall.log

echo "Running postinstall at $(date)"
echo "Installing Mozilla VPN to ${APP_DIR}"

pkill -U "${USER}" -x "Mozilla VPN" || echo "Unable to kill GUI, not running?"
sleep 1

if [ ${OSX_MAJOR_VER} -lt 13 ]; then
  echo "Minimum OSX version not met: ${OSX_MAJOR_VER} < 13"
  rm -rf "$APP_DIR"
  exit 1
fi

# Unload any daemons from the system.
UPDATING=
for SERVICE in $(launchctl list | awk '{print $3}' | grep "^${CODESIGN_APP_IDENTIFIER}."); do
  echo "Unloading launchd service: ${SERVICE}"
  if launchctl bootout system/${SERVICE} 2>/dev/null; then
    UPDATING=1
  fi
done
if [ -f "$DAEMON_PLIST_PATH" ]; then
  echo "Removing legacy daemon plist"
  rm -f ${DAEMON_PLIST_PATH}
fi

echo "Install Complete Run the app"
if [ "$UPDATING" ]; then
  open -a "$APP_DIR" --args ui --updated
else
  open -a "$APP_DIR"
fi
exit 0
