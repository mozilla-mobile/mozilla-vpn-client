# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.
---
loader: taskgraph.loader.transform:loader

transforms:
    - mozilla_taskgraph.transforms.scriptworker.release_artifacts:transforms
    - mozillavpn_taskgraph.transforms.repackage
    - taskgraph.transforms.run:transforms
    - taskgraph.transforms.task:transforms

kind-dependencies:
    - build
    - fetch
    - signing

task-defaults:
    run-on-tasks-for: [github-pull-request, github-push]
    worker:
        chain-of-trust: true
        max-run-time: 600
    treeherder:
        kind: build
        tier: 1
    run:
        using: run-task
        cwd: '{checkout}'

tasks:
    msi:
        description: Build MSI installer package
        fetches:
            from-dependency: # Updated to match dependencies in repackage.py
                - artifact: unsigned.zip
                  # Workers are using an old version of PowerShell that doesn'tcontain the fix in
                  # https://github.com/PowerShell/Microsoft.PowerShell.Archive/issues/48, and the
                  # `fetch-content` script is not able to properly extract it. Until we can use a
                  # newer PowerShell, we'll need to handle extraction ourselves.
                  extract: false
            fetch:
               - wix-toolset
        dependencies:
            by-level:
                "3":
                    signing: signing-windows/opt
                default:
                    build: build-windows/opt
        worker-type: b-win2022
        release-artifacts: [MozillaVPN.msi]
        attributes:
            build-type: windows/opt
        run:
            exec-with: powershell
            command: ./taskcluster/scripts/build/windows_repackage.ps1
        treeherder:
            symbol: rpk(msi)
            platform: windows/x86_64

    msi-next:
        description: Build MSI installer package (next Qt)
        fetches:
            build:
                - artifact: unsigned.zip
                  # Workers are using an old version of PowerShell that doesn'tcontain the fix in
                  # https://github.com/PowerShell/Microsoft.PowerShell.Archive/issues/48, and the
                  # `fetch-content` script is not able to properly extract it. Until we can use a
                  # newer PowerShell, we'll need to handle extraction ourselves.
                  extract: false
            fetch:
               - wix-toolset
        dependencies:
            build: build-windows/next
        worker-type: b-win2022
        release-artifacts: [MozillaVPN.msi]
        attributes:
            build-type: windows/next
        run:
            exec-with: powershell
            command: ./taskcluster/scripts/build/windows_repackage.ps1
        treeherder:
            symbol: rpk(msi-next)
            platform: windows/x86_64

    macpkg:
        description: Build macOS installer package
        fetches:
            fetch:
               - macos-cmake
            from-dependency: # Updated to match dependencies in repackage.py
                - artifact: MozillaVPN.tar.gz
                  extract: false
        dependencies:
            by-level:
                "3":
                    signing: signing-macos/opt
                default:
                    build: build-macos/opt
        worker-type: b-macos
        release-artifacts: [MozillaVPN.pkg]
        attributes:
            build-type: macos/opt
        run:
            command: ./taskcluster/scripts/build/macos_repackage.sh
        treeherder:
            symbol: rpk(macpkg)
            platform: macos/universal

    macpkg-next:
        description: Build macOS installer package (next Qt)
        fetches:
            fetch:
               - macos-cmake
            from-dependency: # Updated to match dependencies in repackage.py
                - artifact: MozillaVPN.tar.gz
                  extract: false
        dependencies:
            by-level:
                "3":
                    signing: signing-macos/next
                default:
                    build: build-macos/next
        worker-type: b-macos
        release-artifacts: [MozillaVPN.pkg]
        attributes:
            build-type: macos/next
        run:
            command: ./taskcluster/scripts/build/macos_repackage.sh
        treeherder:
            symbol: rpk(macpkg)
            platform: macos/next
