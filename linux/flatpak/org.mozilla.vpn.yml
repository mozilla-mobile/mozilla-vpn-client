app-id: org.mozilla.vpn
runtime: org.kde.Platform
runtime-version: '6.10'
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
command: mozillavpn
finish-args:
  - --share=ipc
  - --share=network
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  - --talk-name=org.kde.StatusNotifierWatcher
  - --system-talk-name=org.freedesktop.NetworkManager
build-options:
  append-path: /usr/lib/sdk/rust-stable/bin
cleanup:
  - /include
  - /lib/pkgconfig
  - /share/man
  - /share/doc
modules:
  # Dependency for jsonschema and glean-parser, needs to be installed as a
  # binary wheel because it has a bunch of complex rust dependencies that are
  # difficult to replicate offline.
  - name: python3-rpds
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "rpds-py" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/6c/b0/8fa5e36e58657997873fd6a1cf621285ca822ca75b4b3434ead047daa307/rpds_py-0.26.0-cp313-cp313-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
        sha256: 2c03c9b0c64afd0320ae57de4c982801271c0c211aa2d37f3003ff5feb75bb04
        only_arches:
          - x86_64
      - type: file
        url: https://files.pythonhosted.org/packages/75/83/1953a9d4f4e4de7fd0533733e041c28135f3c21485faaef56a8aadbd96b5/rpds_py-0.26.0-cp313-cp313-manylinux_2_17_aarch64.manylinux2014_aarch64.whl
        sha256: 390e3170babf42462739a93321e657444f0862c6d722a291accc46f9d21ed04e
        only_arches:
          - aarch64
    cleanup:
      - '*'

  - flatpak-glean-parser.yaml

  - name: qt5compat
    buildsystem: cmake-ninja
    sources:
      - type: git
        tag: v6.10.0
        url: https://github.com/qt/qt5compat

  - name: mozillavpn
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DBUILD_FLATPAK=ON
    sources:
      - type: dir
        path: ../..
        skip:
          - .flatpak-builder
          - .git

      # Install vendored Rust crates
      - flatpak-vpn-crates.json
      - type: shell
        commands:
          - mkdir .cargo
          - cp cargo/config .cargo/config.toml
