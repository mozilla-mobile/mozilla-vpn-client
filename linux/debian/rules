#!/usr/bin/make -f

export DH_VERBOSE=1

# Add cargo to PATH if installed via rustup
# Use hardcoded path for CI environment, fallback to HOME for local builds
WORKER_HOME := /builds/worker
ifneq ($(wildcard $(WORKER_HOME)/.cargo/bin),)
export PATH := $(WORKER_HOME)/.cargo/bin:$(PATH)
export RUSTUP_HOME := $(WORKER_HOME)/.rustup
export CARGO_HOME := $(WORKER_HOME)/.cargo
else ifneq ($(wildcard $(HOME)/.cargo/bin),)
export PATH := $(HOME)/.cargo/bin:$(PATH)
export RUSTUP_HOME := $(HOME)/.rustup
export CARGO_HOME := $(HOME)/.cargo
endif

DEB_HOST_MULTIARCH ?= $(shell dpkg-architecture -qDEB_HOST_MULTIARCH)
DEB_VERSION ?= $(shell dpkg-parsechangelog -SVersion)

# Check Qt features.
QT_INSTALL_HEADERS := $(shell pkg-config --variable=includedir Qt6Core || qmake6 -query QT_INSTALL_HEADERS || true)
qtfeature = $(shell test -d "$(QT_INSTALL_HEADERS)" && echo "$(1)" | gcc -I "$(QT_INSTALL_HEADERS)" -include QtCore/qconfig.h -E - | grep -e '^[[:alnum:]_-]')
ifeq (1,$(call qtfeature,QT_FEATURE_static))
ifeq (1,$(call qtfeature,QT_FEATURE_openssl_linked))
	OPENSSL_BUILD_ARGS := -DOPENSSL_USE_STATIC_LIBS=ON
endif
endif

export SYSTEMD_UNIT_PATH := $(shell (pkg-config --variable=systemdsystemunitdir systemd || echo "/lib/systemd/system") | sed 's/^[/]//g')

%:
	dh $@ --buildsystem=cmake+ninja --builddirectory=build-$(DEB_HOST_MULTIARCH) --warn-missing

override_dh_clean:
	dh_clean --exclude=3rdparty

override_dh_auto_configure:
	@echo "DEBUG [debian/rules]: HOME=$(HOME)"
	@echo "DEBUG [debian/rules]: PATH=$(PATH)"
	@echo "DEBUG [debian/rules]: RUSTUP_HOME=$(RUSTUP_HOME)"
	@echo "DEBUG [debian/rules]: CARGO_HOME=$(CARGO_HOME)"
	@which rustc || echo "rustc not found in PATH"
	@which cargo || echo "cargo not found in PATH"
	dh_auto_configure -- -DWEBEXT_INSTALL_LIBDIR=/lib -DBUILD_ID=$(DEB_VERSION) -DCMAKE_CXX_STANDARD=17 -DBUILD_TESTS=OFF ${OPENSSL_BUILD_ARGS}

override_dh_auto_test:

override_dh_installdocs:

override_dh_installinfo:

override_dh_builddeb:
	dh_builddeb -- -Zgzip
